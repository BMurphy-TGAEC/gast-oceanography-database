var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,b,c){a!=Array.prototype&&a!=Object.prototype&&(a[b]=c.value)};$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.SYMBOL_PREFIX="jscomp_symbol_";
$jscomp.initSymbol=function(){$jscomp.initSymbol=function(){};$jscomp.global.Symbol||($jscomp.global.Symbol=$jscomp.Symbol)};$jscomp.Symbol=function(){var a=0;return function(b){return $jscomp.SYMBOL_PREFIX+(b||"")+a++}}();
$jscomp.initSymbolIterator=function(){$jscomp.initSymbol();var a=$jscomp.global.Symbol.iterator;a||(a=$jscomp.global.Symbol.iterator=$jscomp.global.Symbol("iterator"));"function"!=typeof Array.prototype[a]&&$jscomp.defineProperty(Array.prototype,a,{configurable:!0,writable:!0,value:function(){return $jscomp.arrayIterator(this)}});$jscomp.initSymbolIterator=function(){}};$jscomp.arrayIterator=function(a){var b=0;return $jscomp.iteratorPrototype(function(){return b<a.length?{done:!1,value:a[b++]}:{done:!0}})};
$jscomp.iteratorPrototype=function(a){$jscomp.initSymbolIterator();a={next:a};a[$jscomp.global.Symbol.iterator]=function(){return this};return a};$jscomp.iteratorFromArray=function(a,b){$jscomp.initSymbolIterator();a instanceof String&&(a+="");var c=0,d={next:function(){if(c<a.length){var e=c++;return{value:b(e,a[e]),done:!1}}d.next=function(){return{done:!0,value:void 0}};return d.next()}};d[Symbol.iterator]=function(){return d};return d};
$jscomp.polyfill=function(a,b,c,d){if(b){c=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var e=a[d];e in c||(c[e]={});c=c[e]}a=a[a.length-1];d=c[a];b=b(d);b!=d&&null!=b&&$jscomp.defineProperty(c,a,{configurable:!0,writable:!0,value:b})}};$jscomp.polyfill("Array.prototype.keys",function(a){return a?a:function(){return $jscomp.iteratorFromArray(this,function(a){return a})}},"es6","es3");$jscomp.polyfill("Math.log10",function(a){return a?a:function(a){return Math.log(a)/Math.LN10}},"es6","es3");
$jscomp.polyfill("Array.prototype.fill",function(a){return a?a:function(a,c,d){var b=this.length||0;0>c&&(c=Math.max(0,b+c));if(null==d||d>b)d=b;d=Number(d);0>d&&(d=Math.max(0,b+d));for(c=Number(c||0);c<d;c++)this[c]=a;return this}},"es6","es3");CMBase.DATA_TYPE_COORDINATES=1;CMBase.DATA_TYPE_COLOR=2;CMBase.DATA_TYPE_INTEGER=3;CMBase.DATA_TYPE_BOOLEAN=4;CMBase.DATA_TYPE_FLOAT=5;CMBase.DATA_TYPE_CSS_STYLE=6;CMBase.DATA_TYPE_ENUMERATED=7;CMBase.DATA_TYPE_URL=8;CMBase.DATA_TYPE_STRING=9;
CMBase.DATA_TYPE_IMAGE=10;CMBase.DATA_TYPE_FONT=11;CMBase.DATA_TYPE_BOUNDS=12;CMBase.DATA_TYPE_BOOLEAN_ARRAY=12;CMBase.UniqueNumber=1;function CMBase(){}CMBase.prototype.GetName=function(){return"Untitled"};CMBase.prototype.AddChild=function(a){void 0==this.TheChildren&&(this.TheChildren=[]);var b=this.TheChildren.length;this.TheChildren.push(a);return b};
CMBase.prototype.GetNumChildren=function(a){var b=0;if(void 0!=this.TheChildren)if(void 0==a)b=this.TheChildren.length;else for(var c=0;c<this.TheChildren.length;c++)this.TheChildren[c]instanceof a&&b++;return b};CMBase.prototype.GetChild=function(a,b){var c=null;if(void 0!=this.TheChildren)if(void 0==a&&(a=0),void 0==b)c=this.TheChildren[a];else for(var d=0,e=0;e<this.TheChildren.length&&null==c;e++)this.TheChildren[e]instanceof b&&(d==a&&(c=this.TheChildren[e]),d++);return c};
CMBase.prototype.GetNumDescendants=function(a){for(var b=0,c=this.GetNumChildren(a),d=0;d<c;d++){b+=1;var e=this.GetChild(d);b+=e.GetNumDescendants(a)}return b};CMBase.prototype.GetDescendant=function(a,b){var c=null;void 0==b&&(b=0);for(var d=this.GetNumChildren(),e=0;e<d&&null==c;e++){if(b==a)c=this.GetChild(e);else{var f=this.GetChild(e),g=f.GetNumDescendants();g+b>=a?c=f.GetDescendant(a,b+1):b+=g}b++}return c};CMBase.prototype.SetParent=function(a){this.TheParent=a};
CMBase.prototype.GetParent=function(a){var b=null;if(void 0!=this.TheParent)if(void 0!=a)if(this.TheParent instanceof a)b=this.TheParent;else try{b=this.TheParent.GetParent(a)}catch(c){throw c;}else void 0!=this.TheParent&&(b=this.TheParent);return b};
CMBase.prototype.AddListener=function(a,b,c){if(void 0==a)throw"Sorry, the message is undefined";void 0==this.Listeners&&(this.Listeners=[]);void 0==this.Listeners[a]&&(this.Listeners[a]=[]);var d=CMBase.GetUniqueNumber();this.Listeners[a].push({TheFunction:c,TheListener:b,UniqueNumber:d});return d};CMBase.prototype.RemoveListener=function(a,b){if(void 0!=this.Listeners){a=this.Listeners[a];for(var c=0;c<a.length;c++)a[c].UniqueNumber==b&&a.splice(c,1)}};
CMBase.prototype.SendMessageToListeners=function(a,b){if(void 0==a)throw"Sorry, the message is undefined";if(void 0!=this.Listeners&&(a=this.Listeners[a],void 0!=a))for(var c=0;c<a.length;c++)a[c].TheFunction(this,a[c].TheListener,b)};CMBase.prototype.GetSettingsDefinitions=function(){return{}};CMBase.prototype.SettingsChanged=function(){};CMBase.prototype.GetSettings=function(){return{}};
CMBase.prototype.SetSettings=function(a){void 0==this.Settings&&(this.Settings={});for(var b in a){var c=a[b];void 0==this.Settings[b]&&(this.Settings[b]={});for(var d in c)this.Settings[b][d]=c[d]}this.SettingsChanged();this.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED,null)};CMBase.prototype.GetSetting=function(a,b,c){void 0!=this.Settings&&void 0!=this.Settings[a]&&void 0!=this.Settings[a][b]&&(c=this.Settings[a][b]);return c};
CMBase.prototype.SetSetting=function(a,b,c){var d={};d[a]={};d[a][b]=c;this.SetSettings(d)};CMBase.GetUniqueNumber=function(){CMBase.UniqueNumber++;return CMBase.UniqueNumber-1};CMBase.MESSAGE_SETTINGS_CHANGED=CMBase.GetUniqueNumber();CMDataset.GEOJSON=1;CMDataset.PYRAMID=2;CMDataset.PYRAMID_OPEN_FORMAT=3;CMDataset.RASTER=4;CMDataset.SQL=5;CMDataset.MESSAGE_DATASET_LOADED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_DATASET_SELECTION_CHANGED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_ATTRIBUTES_CHANGED=CMBase.GetUniqueNumber();CMDataset.MESSAGE_DATASET_TILE_LOADED=CMBase.GetUniqueNumber();CMDataset.LOAD_STATUS_NONE=1;CMDataset.LOAD_STATUS_LOADING=2;
CMDataset.LOAD_STATUS_LOADED=3;CMDataset.LOAD_STATUS_PENDING=4;CMDataset.LOAD_STATUS_CANCELED=5;CMDataset.REQUEST_TYPE_IMAGE=1;CMDataset.REQUEST_TYPE_TEXT=2;CMDataset.RequestQue=[];CMDataset.CurrentRequest=null;
CMDataset.MakeRequest=function(a){a.TheImage.TheRequest=a;a.TheImage.onload=function(){this.TheRequest.LoadStatus=CMDataset.LOAD_STATUS_LOADED;0<CMDataset.RequestQue.length?(CMDataset.CurrentRequest=CMDataset.RequestQue[0],CMDataset.RequestQue.shift(),CMDataset.CurrentRequest.LoadStatus=CMDataset.LOAD_STATUS_LOADING,CMDataset.CurrentRequest.TheImage.src=CMDataset.CurrentRequest.src):CMDataset.CurrentRequest=null;this.TheRequest.TheFunction()};null==CMDataset.CurrentRequest?(CMDataset.CurrentRequest=
a,a.LoadStatus=CMDataset.LOAD_STATUS_LOADING,a.TheImage.src=a.src):(a.LoadStatus=CMDataset.LOAD_STATUS_PENDING,CMDataset.RequestQue.push(a))};CMDataset.ResetRequests=function(){var a=CMDataset.RequestQue;CMDataset.RequestQue=[];for(var b=0;b<a.length;b++){var c=a[b];a[b]=null;c.LoadStatus=CMDataset.LOAD_STATUS_CANCELED}};function CMDataset(){CMBase.call(this);this.MouseOverFeatureIndex=this.SelectedFeature=-1}CMDataset.prototype=Object.create(CMBase.prototype);CMDataset.prototype.contructor=CMDataset;
CMDataset.prototype.SetVisible=function(a){};CMDataset.prototype.GetNumAttributeRows=function(){return 0};CMDataset.prototype.GetNumAttributeColumns=function(){return 0};CMDataset.prototype.GetAttributeHeading=function(a){return""};CMDataset.prototype.GetAttributeCell=function(a,b){return""};CMDataset.prototype.AddAttributeHeading=function(a,b){};CMDataset.prototype.SetAttributeCell=function(a,b,c){this.SendMessageToListeners(CMDataset.MESSAGE_ATTRIBUTES_CHANGED)};
CMDataset.prototype.GetAttributeArray=function(a){for(var b=this.GetNumAttributeRows(),c=[],d=0;d<b;d++)c[d]=this.GetAttributeCell(a,d);return c};CMDataset.prototype.LoadAttributeColumn=function(a){};CMDataset.prototype.SetProjector=function(a){this.TheProjector=a};CMDataset.prototype.GetProjector=function(){return this.TheProjector};CMDataset.prototype.SetURL=function(a){alert("TCMDataset.SetURL() should be overriden in a subclass")};CMDataset.prototype.SetData=function(a){this.TheData=a};
CMDataset.prototype.GetData=function(){return this.TheData};CMDataset.prototype.GetNumFeatures=function(){return 0};CMDataset.prototype.InFeature=function(a,b,c,d,e){return!1};CMDataset.prototype.In=function(a,b,c,d){return-1};CMDataset.prototype.Paint=function(a,b,c){};CMDataset.prototype.GetSearchResults=function(a,b){};CMDataset.prototype.GetIcon=function(a,b){return b};
CMDataset.prototype.SetSelectedFeature=function(a){this.SelectedFeature!=a&&(this.GetParent(CMScene).UnselectAll(!0),this.SelectedFeature=a,this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_SELECTION_CHANGED))};CMDataset.prototype.UnselectAll=function(a){-1!=this.SelectedFeature&&(this.SelectedFeature=-1,a&&this.GetParent(CMScene).SelectionChanged(this))};CMDataset.prototype.GetSelected=function(){var a=!1;-1!=this.SelectedFeature&&(a=!0);return a};CMDataset.prototype.GetSelectedFeature=function(){return this.SelectedFeature};
CMDataset.prototype.SetMouseOverFeature=function(a){this.MouseOverFeatureIndex!=a&&(this.MouseOverFeatureIndex=a,this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED))};CMDataset.prototype.GetMouseOverFeature=function(){return this.MouseOverFeatureIndex};CMDataset.prototype.AddPoint=function(a,b){};CMDataset.TheDataSets=[];
CMDataset.GetDataObject=function(a,b){var c=null;if(null!=a)for(var d=0;d<CMDataset.TheDataSets.length&&null==c;d++)CMDataset.TheDataSets[d].URL==a&&(c=CMDataset.TheDataSets[d]);if(null==c){switch(b){case CMDataset.GEOJSON:case void 0:c=new CMDatasetGeoJSON;break;case CMDataset.PYRAMID:c=new CMDatasetPyramid;break;case CMDataset.PYRAMID_OPEN_FORMAT:c=new CMDatasetPyramidOpenFormat;break;case CMDataset.RASTER:c=new CMDatasetRaster;break;case CMDataset.SQL:c=new CMDatasetSQL}CMDataset.TheDataSets.push(c)}return c};CMDatasetVector.TYPE_POINTS=1;CMDatasetVector.TYPE_POLYLINES=2;CMDatasetVector.TYPE_POLYGONS=3;function CMDatasetVector(){CMDataset.call(this);this.Type=this.TheRegions=null;this.ColumnHeadings=[];this.Columns=[]}CMDatasetVector.prototype=Object.create(CMDataset.prototype);CMDatasetVector.prototype.contructor=CMDatasetVector;
CMDatasetVector.GetBoundingBoxFromRegion=function(a){for(var b=null,c=0;c<a.length;c++){var d=a[c][0],e=d[0];d=d[1];for(var f=0;f<e.length;f++)null==b?b={XMin:e[f],XMax:e[f],YMin:d[f],YMax:d[f]}:(b.XMin>e[f]&&(b.XMin=e[f]),b.XMax<e[f]&&(b.XMax=e[f]),b.YMin>d[f]&&(b.YMin=d[f]),b.YMax<d[f]&&(b.YMax=d[f]))}return b};
CMDatasetVector.prototype.SetupBoundingBoxesFromRegions=function(a){var b=null;this.FeatureBounds=[];if(null!=a){for(var c=0;c<a.length;c++){var d=CMDatasetVector.GetBoundingBoxFromRegion(a[c]);null==b?b=CMUtilities.CloneBounds(d):CMUtilities.AddToBounds(b,d);this.FeatureBounds[c]=d}this.TheBounds=b}return b};CMDatasetVector.prototype.SetAttributes=function(a,b){this.ColumnHeadings=a;this.Columns=b;this.SendMessageToListeners(CMDataset.MESSAGE_ATTRIBUTES_CHANGED)};
CMDatasetVector.prototype.SetBounds=function(a){this.TheBounds=a};CMDatasetVector.prototype.GetBounds=function(){return this.TheBounds};CMDatasetVector.prototype.GetFeatureBounds=function(a){return this.FeatureBounds[a]};CMDatasetVector.prototype.GetNumAttributeRows=function(){var a=0;0<this.Columns.length&&(a=this.Columns[0].length);return a};CMDatasetVector.prototype.GetNumAttributeColumns=function(){return this.ColumnHeadings.length};CMDatasetVector.prototype.GetAttributeHeading=function(a){return this.ColumnHeadings[a]};
CMDatasetVector.prototype.GetAttributeHeadings=function(a){return this.ColumnHeadings};CMDatasetVector.prototype.GetAttributeCell=function(a,b){return this.Columns[a][b]};CMDatasetVector.prototype.AddAttributeHeading=function(a,b){this.ColumnHeadings.push(a);a=[];for(var c=this.GetNumAttributeRows(),d=0;d<c;d++)a[d]=b;this.Columns.push(a)};
CMDatasetVector.prototype.GetAttributeCellByHeading=function(a,b){var c=this.ColumnHeadings.indexOf(a);if(-1==c)throw"Sorry, the heading "+a+" was not found";return this.GetAttributeCell(c,b)};CMDatasetVector.prototype.GetAttributeIndexFromHeading=function(a){return this.ColumnHeadings.indexOf(a)};CMDatasetVector.prototype.SetAttributeCell=function(a,b,c){this.Columns[a][b]=c;this.SendMessageToListeners(CMDataset.MESSAGE_ATTRIBUTES_CHANGED)};
CMDatasetVector.prototype.GetNumFeatures=function(){var a=0;null!=this.TheRegions&&(a=this.TheRegions.length);return a};CMDatasetVector.prototype.In=function(a,b,c,d){var e=-1;if(null!=this.TheRegions)for(var f=0;f<this.TheRegions.length&&-1==e;f++)this.InFeature(a,b,c,f,d)&&(e=f);return e};
CMDatasetVector.prototype.InFeature=function(a,b,c,d,e){var f=!1;if(null!=this.TheRegions)switch(this.Type){case CMDatasetVector.TYPE_POINTS:d=this.TheRegions[d];for(a=0;a<d.length&&0==f;a++){var g=d[a];g=g[0];var h=g[1][0];Math.abs(g[0][0]-b)<=e&&Math.abs(h-c)<=e&&(f=!0)}break;case CMDatasetVector.TYPE_POLYLINES:d=this.TheRegions[d];for(a=0;a<d.length&&0==f;a++)g=d[a],g=g[0],f=g[0],g=g[1],f=CMUtilities.InPolyline(b,c,f,g,e);break;case CMDatasetVector.TYPE_POLYGONS:for(d=this.TheRegions[d],a=0;a<
d.length&&0==f;a++)g=d[a],g=g[0],f=g[0],g=g[1],f=CMUtilities.InsideAPolygon(b,c,f,g,f.length)}return f};
CMDatasetVector.prototype.Paint=function(a,b,c,d){if(b instanceof CMView2D&&null!=this.TheRegions){void 0==d&&(d=!1);for(var e=b.GetExtent(),f=0;f<this.TheRegions.length;f++){var g=!1;0==c&&0==d?g=!0:c&&this.SelectedFeature==f?g=!0:d&&this.MouseOverFeatureIndex==f&&(g=!0);if(g){g=this.GetFeatureBounds(f);var h=a.GetParent(CMGeo);if(CMUtilities.BoundsOverlap(e,g)||h.GetProjectorType()==CMGeo.PROJECTOR_DYNAMIC)if(this.Type==CMDatasetVector.TYPE_POINTS)g=this.TheRegions[f],h=g[0],g=h[0],a.PaintPoint(b,
f,g[0][0],g[1][0],c,d);else if(null!=this.TheRegions){g=this.TheRegions[f];for(var k=0;k<g.length;k++)h=g[k],a.PaintRefArea(b,f,h,this.Type,c,d)}}}}};CMDatasetVector.prototype.SearchColumn=function(a,b){var c=[];if(null!=this.Columns){b=b.toLowerCase();a=this.Columns[a];for(var d=0;d<a.length;d++){var e=a[d];"string"!=typeof e&&(e=""+e);e=e.toLowerCase();-1!=e.indexOf(b)&&c.push(d)}}return c};
CMDatasetVector.prototype.GetSearchResults=function(a,b){if(null!=this.Columns)for(var c=0;c<this.Columns.length;c++)for(var d=this.Columns[c],e=0;e<d.length;e++){var f=d[e];if("string"==typeof f&&(f=f.toLowerCase(),-1!=f.indexOf(a))){var g=document.createElement("DIV");g.innerHTML=f;g.className="CM_SearchResult";g.TheDataset=this;g.FeatureIndex=e;g.onclick=function(){var a=this.TheDataset.GetParent(CMScene);a.UnselectAll();this.TheDataset.SetSelectedFeature(this.FeatureIndex);var b=this.TheDataset.FeatureBounds[this.FeatureIndex];
a.GetView(0).ZoomToBounds(b)};b.appendChild(g);Found=!0}}};CMDatasetVector.prototype.CMDataset_GetIcon=CMDataset.prototype.GetIcon;
CMDatasetVector.prototype.GetIcon=function(a,b){var c=this.CMDataset_GetIcon(a,b);if(null!=this.TheRegions)switch(this.Type){case CMDatasetVector.TYPE_POLYLINES:c=document.createElement("CANVAS");c.className="CM_LayerListIconClass";c.TheLayer=this;c.style.borderColor="rgba(0,0,0,0)";c.width=16;c.height=16;(new CMView2D).Setup(c);b=a.GetSetting("Style","strokeStyle");a=a.GetSetting("Style","lineWidth");var d=c.getContext("2d");d.strokeStyle=b;d.lineWidth=a;d.moveTo(0,0);d.lineTo(16,16);d.moveTo(0,
16);d.lineTo(7,7);d.stroke();break;case CMDatasetVector.TYPE_POINTS:c=this.GetSetting("Mark","Type",void 0),void 0==c&&(c=CMLayer.MARK_CIRCLE),b=a.GetSetting("Style","strokeStyle"),d=a.GetSetting("Style","fillStyle"),c=a.GetMarkIcon(c,d,b)}return c};
CMDatasetVector.prototype.AddPoint=function(a,b,c){var d=this.GetProjector();null!=d&&(b=d.ProjectFromGeographic(a,b),a=b[0],b=b[1]);null==this.TheRegions&&(this.TheRegions=[],this.Type=CMDatasetVector.TYPE_POINTS);a=[[a],[b]];void 0!=c&&a.push([c]);this.TheRegions.push([[a]]);this.SetupBoundingBoxesFromRegions(this.TheRegions)};
CMDatasetVector.prototype.AddPolyline=function(a,b,c){var d=this.GetProjector();null!=d&&(b=d.ProjectFromGeographic(a,b),a=b[0],b=b[1]);null==this.TheRegions&&(this.TheRegions=[],this.Type=CMDatasetVector.TYPE_POLYLINES);a=[a,b];void 0!=c&&a.push(c);this.TheRegions.push([[a]]);this.SetupBoundingBoxesFromRegions(this.TheRegions)};CMDatasetVector.prototype.GetRegions=function(){return this.TheRegions};CMDatasetVector.prototype.GetType=function(){return this.Type};function CMDatasetGeoJSON(){CMDatasetVector.call(this)}CMDatasetGeoJSON.prototype=Object.create(CMDatasetVector.prototype);CMDatasetGeoJSON.prototype.contructor=CMDatasetGeoJSON;
CMDatasetGeoJSON.prototype.SetURL=function(a){if(this.URL!=a){this.URL=a;var b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.TheDataset=this;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(this.responseText);this.TheDataset.SetGeoJSON(a);null!=this.TheDataset.GetParent(CMMainContainer)&&this.TheDataset.GetParent(CMMainContainer).AddToDebugPanel(this.TheDataset.GetName()+" Received info, repainting:"+CMUtilities.GetSeconds())}else alert("HTTP error "+
this.status+" "+this.statusText+" ("+this.TheURL+")")};b.send()}};CMDatasetGeoJSON.prototype.SaveDataToURL=function(a){var b=this.GetGeoJSONFeatures();b=JSON.stringify(b);a+=encodeURI("?Data="+b);var c=new XMLHttpRequest;c.open("PUT",a,!0);c.TheURL=a;c.TheDataset=this;c.onreadystatechange=function(){4==this.readyState&&(200==this.status?JSON.parse(c.responseText):alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")"))};c.send(b)};
CMDatasetGeoJSON.prototype.SetGeoJSONFeatures=function(a){this.TheRegions=[];this.Type=CMDatasetGeoJSON.GetRegionsFromGeoJSON(a,this.TheRegions);a=this.GetProjector();null!=a&&(this.TheRegions=a.ProjectRegionsFromGeographic(this.TheRegions,this.Type));this.SetupBoundingBoxesFromRegions(this.TheRegions);this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_LOADED)};
CMDatasetGeoJSON.prototype.SetGeoJSON=function(a){var b=0,c=[],d=a.features[0].properties;for(e in d)c.push(e),b++;var e=a.features.length;for(var f=[],g=0;g<b;g++){for(var h=[],k=c[g],l=0;l<e;l++)d=a.features[l].properties,h.push(d[k]);f.push(h)}this.SetAttributes(c,f);this.SetGeoJSONFeatures(a)};CMDatasetGeoJSON.GetAreaFromGeoJSON=function(a,b){var c=[];if(void 0!=a)for(var d=0;d<a.length;d++){var e=a[d],f=[],g=[],h=e.length;b&&--h;for(var k=0;k<h;k++)f.push(e[k][0]),g.push(e[k][1]);c.push([f,g])}return c};
CMDatasetGeoJSON.GetRegionFromGeoJSONGeometry=function(a,b){var c=null;if("Point"==a.type){var d=[[a.coordinates]];d=CMDatasetGeoJSON.GetAreaFromGeoJSON(d,!1);null!=d&&b.push(d);c=CMDatasetVector.TYPE_POINTS}else if("LineString"==a.type)d=[a.coordinates],d=CMDatasetGeoJSON.GetAreaFromGeoJSON(d,!1),null!=d&&b.push(d),c=CMDatasetVector.TYPE_POLYLINES;else if("MultiLineString"==a.type){for(var e=0;e<a.coordinates.length;e++)d=[a.coordinates[e]],d=CMDatasetGeoJSON.GetAreaFromGeoJSON(d,!1),null!=d&&b.push(d);
c=CMDatasetVector.TYPE_POLYLINES}else if("Polygon"==a.type){d=[];for(e=0;e<a.coordinates.length;e++)d.push(a.coordinates[e]);d=CMDatasetGeoJSON.GetAreaFromGeoJSON(d,!0);null!=d&&b.push(d);c=CMDatasetVector.TYPE_POLYGONS}else if("MultiPolygon"==a.type){for(c=0;c<a.coordinates.length;c++){d=[];var f=a.coordinates[c];for(e=0;e<f.length;e++)d.push(f[e]);d=CMDatasetGeoJSON.GetAreaFromGeoJSON(d,!0);null!=d&&b.push(d)}c=CMDatasetVector.TYPE_POLYGONS}else if("GeometryCollection"==a.type)for(e=0;e<a.geometries.length;e++)c=
CMDatasetGeoJSON.GetRegionFromGeoJSONGeometry(a.geometries[e],b);return c};CMDatasetGeoJSON.GetRegionsFromGeoJSON=function(a,b){var c=null;a=a.features;for(var d=0;d<a.length;d++){var e=[],f=CMDatasetGeoJSON.GetRegionFromGeoJSONGeometry(a[d].geometry,e);null!=f&&(c=f);b.push(e)}return c};CMDatasetGeoJSON.GetGeoJSONCoordinatesFromPoly=function(a,b){var c=[];if(void 0!=a){var d=a[0];a=a[1];for(var e=0;e<d.length;e++)c.push([d[e],a[e]]);b==CMDatasetVector.TYPE_POLYGONS&&c.push([d[0],a[0]])}return c};
CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea=function(a,b){var c=[];if(void 0!=a)for(var d=0;d<a.length;d++){var e=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromPoly(a[d],b);c.push(e)}return c};CMDatasetGeoJSON.GetGeoJSONCoordinatesFromRegion=function(a,b){var c=[];if(void 0!=a)for(var d=0;d<a.length;d++){var e=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a[d],b);c.push(e)}return c};
CMDatasetGeoJSON.GetGeoJSONGeometryFromRegion=function(a,b){var c="";switch(b){case CMDatasetVector.TYPE_POINTS:a=a[0];a=a[0];b=[a[0][0],a[1][0]];c={type:"Point",coordinates:b};break;case CMDatasetVector.TYPE_POLYLINES:1==a.length?(a=a[0],a=a[0],b=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromPoly(a,b),c={type:"LineString",coordinates:b}):(a=a[0],b=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a,b),c={type:"MultiLineString",coordinates:b});break;case CMDatasetVector.TYPE_POLYGONS:1==a.length?(a=a[0],
b=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a,b),c={type:"Polygon",coordinates:b}):(b=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromRegion(a,b),c={type:"MultiPolygon",coordinates:b})}return c};
CMDatasetGeoJSON.prototype.GetGeoJSONFeatures=function(){for(var a=[],b=this.GetRegions(),c=this.GetType(),d=this.GetAttributeHeadings(),e=0;e<b.length;e++){for(var f=CMDatasetGeoJSON.GetGeoJSONGeometryFromRegion(b[e],c),g={},h=0;h<d.length;h++)g[d[h]]=this.GetAttributeCell(h,e);a.push({type:"Feature",geometry:f,properties:g})}return{type:"FeatureCollection",features:a}};function CMDatasetRaster(){CMDataset.call(this);this.TheMatrix=null}CMDatasetRaster.prototype=Object.create(CMDataset.prototype);CMDatasetRaster.prototype.contructor=CMDatasetRaster;
CMDatasetRaster.prototype.SetURL=function(a){if(this.URL!=a){this.URL=a;var b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.TheDataset=this;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(b.responseText);this.TheDataset.SetData(a)}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")")};b.send()}};CMDatasetRaster.prototype.CMDataset_SetData=CMDataset.prototype.SetData;
CMDatasetRaster.prototype.SetData=function(a){this.CMDataset_SetData(a);this.TheGeoJSONObject=a;this.NumBands=a.NumBands;this.WidthInPixels=a.WidthInPixels;this.HeightInPixels=a.HeightInPixels;this.NumBands=a.NumBands;this.MinPixelValues=a.MinPixelValues;this.MaxPixelValues=a.MaxPixelValues;this.SetBounds(a.Bounds);this.TheMatrix=a.Data;this.SendMessageToListeners(CMDataset.MESSAGE_DATASET_LOADED)};CMDatasetRaster.prototype.SetImage=function(a){this.TheImage=a};
CMDatasetRaster.prototype.In=function(a,b,c,d){return-1};CMDatasetRaster.prototype.SetBounds=function(a){this.TheBounds=a};CMDatasetRaster.prototype.GetBounds=function(){return this.TheBounds};CMDatasetRaster.prototype.GetRefY=function(){return this.TheBounds.YMax};CMDatasetRaster.prototype.GetRefX=function(){return this.TheBounds.XMin};CMDatasetRaster.prototype.GetRefWidth=function(){return this.TheBounds.XMax-this.TheBounds.XMin};
CMDatasetRaster.prototype.GetRefHeight=function(){return this.TheBounds.YMin-this.TheBounds.YMax};CMDatasetRaster.prototype.GetPixelRefWidth=function(){var a=1;null!=this.GetBounds()&&(a=this.GetRefWidth()/this.WidthInPixels);return a};CMDatasetRaster.prototype.GetPixelRefHeight=function(){var a=-1;null!=this.GetBounds()&&(a=this.GetRefHeight()/this.HeightInPixels);return a};CMDatasetRaster.prototype.GetPixelXFromRefX=function(a){return(a-this.GetRefX())/this.GetRefWidth()*this.WidthInPixels};
CMDatasetRaster.prototype.GetPixelYFromRefY=function(a){return(a-this.GetRefY())/this.GetRefHeight()*this.HeightInPixels};CMDatasetRaster.prototype.GetPixelWidthFromRefWidth=function(a){return a/this.GetRefWidth()*this.WidthInPixels};CMDatasetRaster.prototype.GetPixelHeightFromRefHeight=function(a){return a/this.GetRefHeight()*this.HeightInPixels};CMDatasetRaster.prototype.GetRefXFromPixelX=function(a){return a/this.WidthInPixels*this.GetRefWidth()+this.GetRefX()};
CMDatasetRaster.prototype.GetRefYFromPixelY=function(a){return a/this.HeightInPixels*this.GetRefHeight()+this.GetRefY()};CMDatasetRaster.prototype.GetRefWidthFromPixelWidth=function(a){return a/this.WidthInPixels*this.GetRefWidth()};CMDatasetRaster.prototype.GetRefHeightFromPixelHeight=function(a){return a/this.HeightInPixels*this.GetRefHeight()};
CMDatasetRaster.prototype.Paint=function(a){var b=null;if(null!=this.TheMatrix){var c=a.GetContext();this.GetBounds();var d=this.GetBounds(),e=d.XMin,f=d.XMax,g=d.YMin,h=d.YMax,k=d=0,l=a.GetExtent(),m=a.GetPixelXFromRefX(e),n=a.GetPixelYFromRefY(h);e<l.XMin&&(e=l.XMin,m=0,d=this.GetPixelXFromRefX(e));h>l.YMax&&(h=l.YMax,n=0,k=this.GetPixelYFromRefY(h));l.XMax<f&&(f=l.XMax);l.YMin>g&&(g=l.YMin);e=f-e;l=g-h;h=this.GetPixelWidthFromRefWidth(e);f=this.GetPixelHeightFromRefHeight(l);g=a.GetPixelWidthFromRefWidth(e);
a=a.GetPixelHeightFromRefHeight(l);e=h/g;f/=a;d=Math.round(d);k=Math.round(k);a=Math.round(a);g=Math.round(g);if(0<g&&0<a){b=c.getImageData(m,n,g,a);h=256/(this.MaxPixelValues-this.MinPixelValues);l=this.TheGeoJSONObject.Mask;for(var p=0,q=0;q<a;q++){var r=k+q*f;r=Math.round(r);0>r&&(r=0);r>=this.HeightInPixels&&(r=this.HeightInPixels-1);for(var t=0;t<g;t++){var u=d+t*e;u=Math.round(u);0>u&&(u=0);u>=this.WidthInPixels&&(u=this.WidthInPixels-1);var v=255;if(null!=l)try{v=l[r][u]}catch(z){throw z;}if(0!=
v)if(u=this.TheGeoJSONObject.Data[r][u],u=(u-this.MinPixelValues)*h,u=Math.round(u),0>u&&(u=0),255<u&&(u=255),255==v)b.data[p+0]=u,b.data[p+1]=u,b.data[p+2]=u;else{var w=b.data[p+0],x=b.data[p+1],y=b.data[p+2];w=w/255*(255-v)+u/255*v;0>w&&(w=0);255<w&&(w=255);x=x/255*(255-v)+u/255*v;0>x&&(x=0);255<x&&(x=255);y=y/255*(255-v)+u/255*v;0>y&&(y=0);255<y&&(y=255);b.data[p+0]=Math.round(w);b.data[p+1]=Math.round(x);b.data[p+2]=Math.round(y)}p+=4}}null!=b&&c.putImageData(b,m,n)}return b}};
CMDatasetRaster.prototype.GetSampleFromRef=function(a,b,c){c=void 0;void 0!=this.TheGeoJSONObject&&(a=Math.floor(this.GetPixelXFromRefX(a)),b=Math.floor(this.GetPixelYFromRefY(b)),0<=a&&a<this.WidthInPixels&&0<=b&&b<this.HeightInPixels&&(c=this.TheGeoJSONObject.Data[b][a]));return c};
CMDatasetRaster.prototype.GetPathArray=function(a,b,c,d,e){void 0==d&&(d=0);void 0==e&&(e=1);var f=[];if(void 0==this.TheMatrix)for(var g=0;g<a.length;g++){var h=a[g],k=b[g],l=0;if(null!=c)l=c[g];else{var m=this.GetSampleFromRef(h,k);void 0!=m&&(l=m)}l=l*e+d;f.push(new THREE.Vector3(h,k,l))}else for(g=0;g<a.length;g++)h=a[g],k=b[g],null!=c?l=c[g]:(l=this.GetSampleFromRef(h,k),void 0==l&&(l=0)),l=l*e+d,f.push(new THREE.Vector3(h,k,l));return f};CMDatasetPyramid.MESSAGE_DATASET_TILE_LOADED=CMBase.GetUniqueNumber();function CMDatasetPyramid(){CMDataset.call(this);this.AttributeInfo=null;this.HeadingIndex=-1;this.TileWidthInPixels=256;this.PaintDebugTileInfo=!1;this.DebugZoomLevel=-1;this.DebugGlobalRow=this.DebugGlobalColumn=0;this.Bounds=null}CMDatasetPyramid.prototype=Object.create(CMDataset.prototype);CMDatasetPyramid.prototype.contructor=CMDatasetPyramid;
CMDatasetPyramid.prototype.SetDebugTile=function(a,b,c){this.PaintDebugTileInfo=!0;this.DebugZoomLevel=a;this.DebugGlobalColumn=b;this.DebugGlobalRow=c};
CMDatasetPyramid.prototype.SetURL=function(a){if(this.URL!=a)if(this.URL=a,null==a)this.NumColumns=this.NumRows=this.Tiles=void 0;else{a=this.URL+"Info.js";var b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.TheDataset=this;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(this.responseText);null===this.TheDataset.GetName()&&this.TheDataset.SetName(a.Title);this.TheDataset.SetBounds(a.Bounds);this.TheDataset.OriginalBounds=a.OriginalBounds;this.TheDataset.TileRefWidth=
a.TileRefWidth;this.TheDataset.MinColumn=Math.round(a.MinColumn);this.TheDataset.MaxColumn=Math.round(a.MaxColumn);this.TheDataset.NumColumns=Math.round(a.NumColumns);this.TheDataset.MinRow=Math.round(a.MinRow);this.TheDataset.MaxRow=Math.round(a.MaxRow);this.TheDataset.NumRows=Math.round(a.NumRows);this.TheDataset.Type=a.Type;this.TheDataset.TopZoomLevel=Math.round(a.TopZoomLevel);if("REGIONS"==this.TheDataset.Type||"POINTS"==this.TheDataset.Type)this.TheDataset.AttributeInfo=a.AttributeInfo;"RASTER_DATA"==
this.TheDataset.Type&&(this.TheDataset.MinPixelValues=a.MinPixelValues,this.TheDataset.MaxPixelValues=a.MaxPixelValues);this.TheDataset.Tiles=[];this.TheDataset.GetParent(CMMainContainer);for(Row=0;Row<this.TheDataset.NumRows;Row++)for(this.TheDataset.Tiles[Row]=[],Column=0;Column<this.TheDataset.NumColumns;Column++)this.TheDataset.Tiles[Row][Column]=new CMTile(this.TheDataset,this.TheDataset.TopZoomLevel,Column+this.TheDataset.MinColumn,this.TheDataset.MaxRow-Row),this.PaintDebugTileInfo&&TheChildTile.SetPaintTileInfo(this.PaintDebugTile),
this.TheDataset.Tiles[Row][Column].LoadTile();this.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_LOADED)}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")")};b.send()}};CMDatasetPyramid.prototype.CMDataset_GetIcon=CMDataset.prototype.GetIcon;
CMDatasetPyramid.prototype.GetIcon=function(a,b){var c=this.CMDataset_GetIcon(a,b);switch(this.Type){case "REGIONS":c=document.createElement("CANVAS");c.className="CM_LayerListIconClass";c.TheLayer=this;c.style.borderColor="rgba(0,0,0,0)";c.width=16;c.height=16;(new CMView2D).Setup(c);b=a.GetSetting("Style","strokeStyle");a=a.GetSetting("Style","lineWidth");var d=c.getContext("2d");d.strokeStyle=b;d.lineWidth=a;d.moveTo(0,0);d.lineTo(16,16);d.moveTo(0,16);d.lineTo(7,7);d.stroke();break;case "POINTS":c=
this.GetSetting("Mark","Type",void 0),void 0==c&&(c=CMLayer.MARK_CIRCLE),b=a.GetSetting("Style","strokeStyle"),d=a.GetSetting("Style","fillStyle"),c=a.GetMarkIcon(c,d,b)}return c};CMDatasetPyramid.prototype.GetNumFeatures=function(){var a=0;null!=this.AttributeInfo&&(a=this.AttributeInfo.NumRows);return a};
CMDatasetPyramid.prototype.InFeature=function(a,b,c,d,e){for(var f=!1,g=0;g<this.NumRows&&0==f;g++)for(Column=0;Column<this.NumColumns&&!1===f;Column++)this.Tiles[g][Column].In(a,b,c,e)==d&&(f=!0);return f};CMDatasetPyramid.prototype.In=function(a,b,c,d){for(var e=-1,f=0;f<this.NumRows&&-1==e;f++)for(Column=0;Column<this.NumColumns&&-1==e;Column++)e=this.Tiles[f][Column].In(a,b,c,d);return e};
CMDatasetPyramid.prototype.GetHeadingIndex=function(){if(-1==this.HeadingIndex)for(var a=0;a<this.AttributeInfo.Attributes.Headings.length;a++)this.AttributeInfo.Attributes.Headings[a]==this.HTMLAttribute&&(this.HeadingIndex=a)};CMDatasetPyramid.prototype.ShowInfoWindow=function(a,b,c,d){null!=this.HTMLAttribute&&(this.GetHeadingIndex(),a=b.CreateInfoWindow("CMDatasetPyramid.InfoWindow",c,d,200,30,this.Attributes.Values[this.HeadingIndex][a]),CMMainContainer.SetPopupWindow(a))};
CMDatasetPyramid.prototype.MouseDown=function(a,b,c,d){var e=!1;if(this.IsVisible()&&a.GetTool()==CMView.TOOL_INFO&&a.GetTool()==CMView.TOOL_SELECT)for(var f=0;f<this.NumRows&&0==e;f++)for(Column=0;Column<this.NumColumns&&0==e;Column++)e=this.Tiles[f][Column].MouseDown(a,b,c,d);return e};CMDatasetPyramid.prototype.SetBounds=function(a){this.TheBounds=a};CMDatasetPyramid.prototype.GetBounds=function(){return this.TheBounds};
CMDatasetPyramid.prototype.GetNumAttributeRows=function(){var a=0;null!=this.AttributeInfo.Attributes&&(a=this.AttributeInfo.NumRows);return a};CMDatasetPyramid.prototype.GetNumAttributeColumns=function(){var a=0;null!=this.AttributeInfo&&(a=this.AttributeInfo.NumRows);return a};CMDatasetPyramid.prototype.GetAttributeHeading=function(a){var b="";null!=this.AttributeInfo&&(b=this.AttributeInfo.Attributes[a]);return b};
CMDatasetVector.prototype.GetAttributeCellByHeading=function(a,b){var c=this.GetAttributeIndexFromHeading(a);if(-1==c)throw"Sorry, the heading "+a+" was not found";return this.GetAttributeCell(c,b)};CMDatasetPyramid.prototype.GetAttributeIndexFromHeading=function(a){var b=-1;if(null!=this.AttributeInfo)for(var c=0;c<this.AttributeInfo.Attributes.length;c++)this.AttributeInfo.Attributes[c].Heading==a&&(b=c);return b};
CMDatasetPyramid.prototype.GetAttributeCell=function(a,b){var c="";null!=this.Attributes&&(c=this.Attributes[a][b]);return c};
CMDatasetPyramid.prototype.LoadAttributeColumn=function(a){var b=this.URL+"Attributes/AttributeColumn_"+a+".js",c=new XMLHttpRequest;c.open("GET",b,!0);c.TheURL=b;c.TheDataset=this;c.ColumnIndex=a;c.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(this.responseText);void 0==this.TheDataset.Attributes&&(this.TheDataset.Attributes=[]);this.TheDataset.Attributes[this.ColumnIndex]=a.Values;this.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_ATTRIBUTES_CHANGED)}else alert("HTTP error "+
this.status+" "+this.statusText+" ("+this.TheURL+")")};c.send()};CMDatasetPyramid.prototype.GetFeatureBounds=function(a){for(var b=null,c=0;c<this.NumRows;c++)for(Column=0;Column<this.NumColumns;Column++)b=this.Tiles[c][Column].AddToFeatureBounds(a,b);return b};CMDatasetPyramid.prototype.GetDataForTextureTile=function(a,b,c){for(var d=null,e=0;e<this.NumRows&&null==d;e++)for(Column=0;Column<this.NumColumns&&null==d;Column++)d=this.Tiles[e][Column].GetDataForTextureTile(a,b,c);return d};
CMDatasetPyramid.prototype.Paint=function(a,b,c,d){if(void 0!=this.NumRows&&0==c&&(void 0==d||0==d))for(b.GetContext(),d=0;d<this.NumRows;d++)for(Column=0;Column<this.NumColumns;Column++)this.Tiles[d][Column].PaintTile(a,b,c,this.TileRefWidth)};
CMDatasetPyramid.prototype.GetSearchResults=function(a,b){if(this.IsVisible()&&null!=this.AttributeInfo)for(var c=this.GetNumAttributeRows(),d=this.GetNumAttributeColumns(),e=0;e<d;e++)for(var f=this.Attributes.Values[e],g=0;g<c;g++){var h=f[g];h=h.toLowerCase();-1!=h.indexOf(a)&&(h=document.createElement("DIV"),h.innerHTML=f[g],h.TheLayer=this,h.FeatureIndex=g,h.onclick=function(){this.TheLayer.TheScene.UnselectAll();this.TheLayer.SetSelectedFeature(this.FeatureIndex);var a=this.TheLayer.GetFeatureBounds(this.FeatureIndex),
b=this.TheLayer.TheScene.GetView(0);this.className="CM_SearchResultSelected";b.ZoomToBounds(a)},b.appendChild(h))}return""};function CMDatasetPyramidOpenFormat(){CMDataset.call(this);this.TopTile=null;this.Visible=!0;this.TileWidthInPixels=256;this.PaintDebugTile=!1;this.DebugZoomLevel=-1;this.DebugGlobalRow=this.DebugGlobalColumn=0;this.FileExtension=null;this.TheBounds={XMin:-180,XMax:180,YMin:-90,YMax:90}}CMDatasetPyramidOpenFormat.prototype=Object.create(CMDataset.prototype);CMDatasetPyramidOpenFormat.prototype.contructor=CMDatasetPyramidOpenFormat;
CMDatasetPyramidOpenFormat.prototype.SetDebugTile=function(a,b,c){this.PaintDebugTile=!0;this.DebugZoomLevel=a;this.DebugGlobalColumn=b;this.DebugGlobalRow=c};
CMDatasetPyramidOpenFormat.prototype.SetURL=function(a){if(this.URL!=a){a=a.trim();if("}"!=a[a.length-1]){var b=a.lastIndexOf(".");this.FileExtension=a.substr(b+1)}b=a.indexOf("{x}");var c=a.indexOf("{y}"),d=a.indexOf("{z}"),e=d;this.CoordinateValueOrder=[];b<c?b<d?(e=b,this.CoordinateValueOrder=c<d?["x","y","z"]:["x","z","y"]):this.CoordinateValueOrder=["z","x","y"]:b<d?this.CoordinateValueOrder=["y","x","z"]:c<d?(e=c,this.CoordinateValueOrder=["y","z","x"]):this.CoordinateValueOrder=["z","y","x"];
this.URL=a=a.substr(0,e);this.TopTile=new CMTileOpenFormat(this,-18,0,0);this.GetParent(CMScene).Repaint()}};CMDatasetPyramidOpenFormat.prototype.GetCoordinateValueOrder=function(){return this.CoordinateValueOrder};CMDatasetPyramidOpenFormat.prototype.GetFileExtension=function(){return this.FileExtension};CMDatasetPyramidOpenFormat.prototype.GetBounds=function(){return this.TheBounds};
CMDatasetPyramidOpenFormat.prototype.SetVisible=function(a,b){this.Visible&&0==b&&this.TopTile.HideTiles(a);this.Visible=b};CMDatasetPyramidOpenFormat.prototype.Paint=function(a,b,c,d){0!=c||void 0!=d&&0!=d||this.TopTile.PaintTile(a,b,c,d)};CMTileOpenFormat.NumTilesLoaded=0;function CMTileOpenFormat(a,b,c,d){this.GlobalRow=d;this.GlobalColumn=c;this.ZoomLevel=b;this.ChildTiles=this.TheRasterRequest=this.TheRaster=null;this.TheDataset=a;this.MeshIsInGeo=this.PaintTileInfo=!1;this.TheMesh=null}
CMTileOpenFormat.prototype.GetTileImageFilePath=function(){var a=null,b=this.ZoomLevel,c=this.GlobalRow,d=this.GlobalColumn;b=18+b;var e=this.TheDataset.GetCoordinateValueOrder(),f=this.TheDataset.GetFileExtension();if(0<=d&&0<=c){a="";for(var g=0;3>g;g++)0!=g&&(a+="/"),"x"==e[g]&&(a+=d),"y"==e[g]&&(a+=c),"z"==e[g]&&(a+=b);null!=f&&(a+="."+f);a=this.TheDataset.URL+a}return a};
CMTileOpenFormat.prototype.LoadTileRaster=function(a){this.TheRaster=new Image;this.TheRaster.TheTile=this;a=this.GetTileImageFilePath();this.TheRasterRequest={LoadStatus:CMDataset.LOAD_STATUS_NONE,Type:CMDataset.REQUEST_TYPE_IMAGE,TheImage:this.TheRaster,src:a,TheFunction:function(){this.TheTile.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_TILE_LOADED,this.TheTile)}};this.TheRasterRequest.TheTile=this;CMDataset.MakeRequest(this.TheRasterRequest)};
CMTileOpenFormat.prototype.CheckPaintTile=function(a,b,c){var d=!1;if(this.TheDataset.PaintDebugTile)this.TheDataset.DebugZoomLevel==this.ZoomLevel&&this.TheDataset.DebugGlobalColumn==this.GlobalColumn&&this.TheDataset.DebugGlobalRow==this.GlobalRow&&(d=!0);else if(0==d){var e=!1;"undefined"!=typeof CM3View&&a instanceof CM3View?CMTileOpenFormat.GetDistanceToView(a,this.GetTileExtent(),c)>2*b&&(d=!0):(b=a.GetPixelWidthFromRefWidth(b),256>=b?d=!0:512>=b&&(e=!0));if(0==d)if(0==this.ZoomLevel)d=!0;else for(NumLoadedChildTiles=
0,null==this.ChildTiles&&(this.ChildTiles=[],this.ChildTiles[0]=[null,null],this.ChildTiles[1]=[null,null]),b=0;2>b;b++)for(c=0;2>c;c++){if(null==this.ChildTiles[b][c]){var f=new CMTileOpenFormat(this.TheDataset,this.ZoomLevel+1,2*this.GlobalColumn+c,2*this.GlobalRow+(1-b));this.PaintTileInfo&&f.SetPaintTileInfo(this.PaintTileInfo);this.ChildTiles[b][c]=f}e&&(f=this.ChildTiles[b][c],null==f.TheRasterRequest?f.LoadTileRaster(a):f.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_NONE?f.LoadTileRaster(a):
f.TheRasterRequest.LoadStatus!=CMDataset.LOAD_STATUS_LOADING&&(f.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?NumLoadedChildTiles++:f.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster(a)))}}return d};CMTileOpenFormat.prototype.GetTileExtent=function(){var a=1/Math.pow(2,this.ZoomLevel)*256,b=this.GlobalColumn*a,c=-(this.GlobalRow*a);return{XMin:b,XMax:b+a,YMax:c,YMin:c-a}};
CMTileOpenFormat.GetGlobalCoordinate=function(a,b,c,d){a=a.GetParent(CMGeo);var e=new CMProjectorGoogleMaps;e.SetZoomLevel(18);b=e.ProjectToGeographic(b,c);return a.ProjectFromGeographic(b[0],b[1],d)};CMTileOpenFormat.GetDistanceToView=function(a,b,c){a=a.GetPosition();var d=(b.XMin+b.XMax)/2;b=(b.YMin+b.YMax)/2;c=CMTileOpenFormat.GetGlobalCoordinate(c,d,b,0);d=c.x;b=c.y;d=a.x-d;b=a.y+b;a=a.z-c.z;return Math.sqrt(d*d+b*b+a*a)};
CMTileOpenFormat.prototype.SetupGeometry=function(a){var b=a.GetParent(CM3Geo),c=this.GetTileExtent();a=[];var d=c.XMin,e=c.YMin,f=(c.YMax-e)/16;c=(c.XMax-d)/16;var g=new CMProjectorGoogleMaps;g.SetZoomLevel(18);for(var h=0;16>=h;h++){var k=[];a[h]=k;for(var l=0;16>=l;l++){k[l]=[];var m=g.ProjectToGeographic(d+l*c,e+h*f);m=b.ProjectFromGeographic(m[0],m[1],0);k[l][0]=m.x;k[l][1]=m.y;k[l][2]=m.z}}b=new CM3SurfaceGeometry(a[0].length-1,a.length-1);b.SetPositions(a);return b};
CMTileOpenFormat.prototype.HideMesh=function(a){this.MeshIsInGeo&&(a.GetParent(CMGeo).RemoveOGLObjectFromGeo(this.TheMesh),this.MeshIsInGeo=!1)};CMTileOpenFormat.prototype.HideTiles=function(a){this.HideMesh(a);if(null!=this.ChildTiles)for(var b=0;2>b;b++)if(null!=this.ChildTiles[b])for(var c=0;2>c;c++)null!=this.ChildTiles[b][c]&&this.ChildTiles[b][c].HideTiles(a)};
CMTileOpenFormat.prototype.PaintTile=function(a,b,c){var d=0,e=this.GetTileExtent(),f=e.XMax-e.XMin,g=e.XMin,h=e.YMax,k=!0;if("undefined"!=typeof CM3View&&b instanceof CM3View){if(a.GetVisible()){g=(e.XMax+e.XMax)/2;k=CMTileOpenFormat.GetGlobalCoordinate(a,g,e.YMin,0);h=CMTileOpenFormat.GetGlobalCoordinate(a,g,e.YMax,0);e=k.x-h.x;g=k.y-h.y;k=k.z-h.z;if(k=this.CheckPaintTile(b,2*Math.sqrt(e*e+g*g+k*k)/2,a)){if(null!=this.ChildTiles)for(e=0;2>e;e++)if(null!=this.ChildTiles[e])for(g=0;2>g;g++)null!=
this.ChildTiles[e][g]&&(h=this.ChildTiles[e][g],h.HideMesh(a));if(0==this.MeshIsInGeo){if(null==this.TheMesh){a.GetSetting("Elevation","Exaggeration",1);e=this.SetupGeometry(a);g=this.GetTileImageFilePath();h=new THREE.TextureLoader;h.crossOrigin="";var l=new THREE.MeshLambertMaterial({color:65535,side:THREE.FrontSide,opacity:1,transparent:!1});l.map=h.load(g);this.TheMesh=new THREE.Mesh(e,l)}null!=this.TheMesh&&(a.GetParent(CMGeo).AddOGLObjectToGeo(this.TheMesh),this.MeshIsInGeo=!0)}}0==k&&this.HideMesh(a)}}else if(CMUtilities.BoundsOverlap(e,
b.GetExtent())){k=this.CheckPaintTile(b,f);var m=0;k&&(null!=this.TheRasterRequest?this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?b.PaintRefImageScaled(this.TheRaster,g,h,f,-f):this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster(b):this.LoadTileRaster(b));k&&this.PaintTileInfo&&(e={font:"20px Arial",fillStyle:"red",lineWidth:1,strokeColor:"red",strokeStyle:"#000"},null!=e&&b.SetStyle(e),b.PaintRefText(this.ZoomLevel+"_"+this.GlobalColumn+"_"+this.GlobalRow,
g+f/2,h-f/2,20),b.PaintRefLine(g,h,g,h-f),b.PaintRefLine(g+f,h,g+f,h-f),b.PaintRefLine(g,h,g+f,h),b.PaintRefLine(g,h-f,g+f,h-f),null!=e&&b.RestoreStyle())}if(0==k)for(e=0;2>e;e++)for(g=0;2>g;g++)null!=this.ChildTiles[e][g]&&(h=this.ChildTiles[e][g],m+=h.PaintTile(a,b,c,f/2));d++;return d};CMTileOpenFormat.prototype.SetPaintTileInfo=function(a){this.PaintTileInfo=a};CMTileOpenFormat.prototype.GetData=function(){return this.TheData};CMDialog.DIALOG_WIDTH=400;CMDialog.DIALOG_HEIGHT=400;CMDialog.SIZING_NONE=0;CMDialog.SIZING_RIGHT=1;CMDialog.SIZING_BOTTOM=2;CMDialog.SIZING_BOTTOM_RIGHT=3;
CMDialog.CreateCloseBox=function(a,b,c,d,e,f,g){var h=document.createElement("canvas");h.style.position="absolute";h.style.top=c+"px";h.style.right=b+"px";h.style.width=d+"px";h.style.height=e+"px";h.style.border="1px solid "+f;h.width=d;h.height=e;a instanceof CMDialog?a.TheElement.appendChild(h):a.appendChild(h);h.TheDialog=a;h.Callback=g;h.onmousedown=function(a){void 0!=this.Callback?g():this.TheDialog.Close()};CMDialog.PaintCloseBox(h,d,e,f);return h};
CMDialog.PaintCloseBox=function(a,b,c,d){a=a.getContext("2d");a.strokeStyle=d;a.lineWidth=2;a.beginPath();a.moveTo(0,0);a.lineTo(b,c);a.stroke();a.beginPath();a.moveTo(b,0);a.lineTo(0,c);a.stroke();a.strokeRect(1,1,b-2,c-2)};
function CMDialog(a,b,c,d,e){void 0==e&&(e="Dialog");-1==b&&(b=CMDialog.DIALOG_WIDTH);-1==c&&(c=CMDialog.DIALOG_HEIGHT);this.TheElement=document.getElementById(a);if(null==this.TheElement)this.TheElement=document.createElement("DIV"),this.TheElement.id=a,document.body.appendChild(this.TheElement);else for(;this.TheElement.firstChild;)this.TheElement.removeChild(this.TheElement.firstChild);this.Sizing=CMDialog.SIZING_NONE;var f=this;this.TheElement.className="CM_SettingsDialog";this.TheElement.style.visibility=
"visible";a=$(window).height();var g=$(window).width();CMUtilities.AbsolutePosition(this.TheElement,(g-b)/2,(a-c)/2,b,c);var h=document.createElement("DIV");h.className="CM_DialogHeader";b=document.createElement("DIV");b.style.position="relative";b.style.top="6px";b.style.left="8px";b.innerHTML=e;h.appendChild(b);this.TheElement.appendChild(h);e=document.createElement("DIV");e.className="CM_DialogBody";this.BodyElement=e;this.TheElement.appendChild(this.BodyElement);h.addEventListener("mousedown",
function(a){var b=h.getBoundingClientRect();f.AnchorX=a.clientX-b.left;f.AnchorY=a.clientY-b.top;f.Dragging=!0;a.preventDefault()});window.addEventListener("mousedown",function(a){f.Sizing=f.GetSizing(a);f.Sizing!=CMDialog.SIZING_NONE&&a.preventDefault()});window.addEventListener("mousemove",function(a){if(f.Dragging){var b=window.pageXOffset||document.documentElement.scrollLeft,c=window.pageYOffset||document.documentElement.scrollTop;h.getBoundingClientRect();c=a.clientY-f.AnchorY+c;f.TheElement.style.left=
a.clientX-f.AnchorX+b+"px";f.TheElement.style.top=c+"px";a.preventDefault()}else if(f.Sizing!=CMDialog.SIZING_NONE){b=f.TheElement.getBoundingClientRect();c=b.right-b.left;var d=b.bottom-b.top;f.Sizing==CMDialog.SIZING_BOTTOM_RIGHT?(c=a.clientX-b.left,d=a.clientY-b.top):f.Sizing==CMDialog.SIZING_RIGHT?c=a.clientX-b.left:f.Sizing==CMDialog.SIZING_BOTTOM&&(d=a.clientY-b.top);f.TheElement.style.width=c+"px";f.TheElement.style.height=d+"px";f.BodyElement.style.width=c-6+"px";f.BodyElement.style.height=
d-34+"px"}else switch(f.GetSizing(a)){case CMDialog.SIZING_BOTTOM_RIGHT:f.TheElement.style.cursor="nwse-resize";break;case CMDialog.SIZING_RIGHT:f.TheElement.style.cursor="ew-resize";break;case CMDialog.SIZING_BOTTOM:f.TheElement.style.cursor="ns-resize";break;default:f.TheElement.style.cursor="auto"}});window.addEventListener("mouseup",function(a){f.Dragging&&(f.Dragging=!1,a.preventDefault());f.Sizing&&(f.Sizing=CMDialog.SIZING_NONE,a.preventDefault())});CMDialog.CreateCloseBox(this,8,8,16,16,"#ffffff");
this.DisablePage=document.getElementById("DialogDisablePage");null==this.DisablePage&&(this.DisablePage=document.createElement("DIV"),this.DisablePage.id="DialogDisablePage",document.body.appendChild(this.DisablePage));this.DisablePage.style.visibility="hidden";d&&(this.DisablePage.style.backgroundColor="white",this.DisablePage.style.visibility="visible",this.DisablePage.style.opacity="0.5",this.DisablePage.style.zIndex="99999999",a=$(window).height(),g=$(window).width(),CMUtilities.AbsolutePosition(this.DisablePage,
0,0,g,a))}CMDialog.prototype.GetSizing=function(a){var b=CMDialog.SIZING_NONE,c=this.TheElement.getBoundingClientRect(),d=Math.abs(c.right-a.clientX);a=Math.abs(c.bottom-a.clientY);4>d&&4>a?b=CMDialog.SIZING_BOTTOM_RIGHT:4>d?b=CMDialog.SIZING_RIGHT:4>a&&(b=CMDialog.SIZING_BOTTOM);return b};CMDialog.prototype.GetBodyElement=function(){return this.BodyElement};
CMDialog.prototype.SetVisible=function(a){a?(this.TheElement.style.visibility="visible",this.DisablePage.style.visibility="visible"):(this.TheElement.style.visibility="hidden",this.DisablePage.style.visibility="hidden")};CMDialog.prototype.GetVisible=function(){var a=!1;"visible"==this.TheElement.style.visibility&&(a=!0);return a};CMDialog.prototype.Close=function(){this.SetVisible(!1)};
CMDialog.AddLabelToPanel=function(a,b,c,d){var e=document.createElement("div");e.innerHTML=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+10,d,300,30);return e};CMDialog.AddParagraphToPanel=function(a,b,c,d,e,f){var g=document.createElement("p");g.innerHTML=b;a.appendChild(g);CMUtilities.AbsolutePosition(g,c+10,d,e,f);return g};
CMDialog.AddColorControlToPanel=function(a,b,c,d,e){var f=document.createElement("div");f.innerHTML=b;a.appendChild(f);CMUtilities.AbsolutePosition(f,c+10,d,100,30);document.createElement("input");b=document.createElement("div");b.innerHTML="<input id='ColorControl' type='color'>";b=b.childNodes[0];e=CMUtilities.GetHexColorFromColor(e);b.value=e;a.appendChild(b);CMUtilities.AbsolutePosition(b,c+110,d,100,20);return b};
CMDialog.AddButtonControlToPanel=function(a,b,c,d){var e=document.createElement("button");b=document.createTextNode(b);e.appendChild(b);a.appendChild(e);CMUtilities.AbsolutePosition(e,c+10,d,80,30);return e};CMDialog.AddSliderControlToPanel=function(a,b,c,d,e,f,g){b=CMUtilities.CreateLabelControl(b);CMUtilities.AbsolutePosition(b,c+10,d,80,30);a.appendChild(b);e=CMUtilities.CreateSliderControl(e,f,g);CMUtilities.AbsolutePosition(e,c+110,d,100,30);a.appendChild(e);return e};
CMDialog.AddCheckBoxControlToPanel=function(a,b,c,d,e){var f=document.createElement("input");f.type="checkbox";f.name=b;f.text=b;f.checked=e?!0:!1;a.appendChild(f);CMUtilities.AbsolutePosition(f,c,d,40,30);e=document.createElement("div");e.innerHTML=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+60,d+8,80,30);return f};
CMDialog.AddTextControlToPanel=function(a,b,c,d,e){var f=document.createElement("div");f.innerHTML=b;a.appendChild(f);CMUtilities.AbsolutePosition(f,c+10,d+8,100,30);f=document.createElement("input");f.type="text";f.name=b;void 0!=e&&(f.value=e);a.appendChild(f);CMUtilities.AbsolutePosition(f,c+110,d,80,24);return f};
CMDialog.AddRadioControlToPanel=function(a,b,c,d,e,f){for(var g=[],h=0;h<e.length;h++){var k=document.createElement("input");k.type="radio";k.name=b;k.value=e[h];f==e[h]&&(k.checked=!0);a.appendChild(k);CMUtilities.AbsolutePosition(k,c+10,d,24,24);var l=document.createElement("div");l.innerHTML=e[h];a.appendChild(l);CMUtilities.AbsolutePosition(l,c+50,d+8,100,30);d+=30;g.push(k)}return g};
CMDialog.AddSelectControlToPanel=function(a,b,c,d,e,f){var g=document.createElement("div");g.innerHTML=b;a.appendChild(g);CMUtilities.AbsolutePosition(g,c+10,d+8,100,30);e=CMUtilities.CreateSelectControl(e,f);e.name=b;a.appendChild(e);CMUtilities.AbsolutePosition(e,c+110,d,150,24);return e};CMDialog.prototype.AddLabel=function(a,b,c){return CMDialog.AddLabelToPanel(this.TheElement,a,b,c)};
CMDialog.prototype.AddParagraph=function(a,b,c,d,e){return CMDialog.AddParagraphToPanel(this.TheElement,a,b,c,d,e)};CMDialog.prototype.AddColorControl=function(a,b,c,d){return CMDialog.AddColorControlToPanel(this.TheElement,a,b,c,d)};CMDialog.prototype.AddButtonControl=function(a,b,c){return CMDialog.AddButtonControlToPanel(this.TheElement,a,b,c)};CMDialog.prototype.AddSliderControl=function(a,b,c,d,e,f){return CMDialog.AddSliderControlToPanel(this.TheElement,a,b,c,d,e,f)};
CMDialog.prototype.AddCheckBoxControl=function(a,b,c,d){return CMDialog.AddCheckBoxControlToPanel(this.TheElement,b,c,d)};CMDialog.prototype.AddTextControl=function(a,b,c,d){return CMDialog.AddTextControlToPanel(this.TheElement,a,b,c,d)};CMDialog.prototype.AddRadioControl=function(a,b,c,d,e){return CMDialog.AddRadioControlToPanel(this.TheElement,a,b,c,d,e)};CMDialog.prototype.AddSelectControl=function(a,b,c,d,e){return CMDialog.AddSelectControlToPanel(this.TheElement,a,b,c,d,e)};
CMDialog.GetRGBAFromControls=function(a,b){b=b.value;a=CMUtilities.GetRGBFromHex(a.value);a=a.Red+","+a.Green+","+a.Blue;return 100!=b?"rgba("+a+","+b/100+")":"rgb("+a+")"};CMDialogSettings=function(){};CMDialogSettings.SetStyle=function(a,b,c,d){var e=a.GetProperty(b,null);null==e&&(e={});e[c]=d;a.SetProperty(b,e);a.GetScene().Repaint()};
CMDialogSettings.AddPenPanel=function(a,b,c){var d=10,e=document.createElement("div");a.TheElement.appendChild(e);var f=0;a=b.GetProperty(c,null);var g=null;null!=a&&(g=a.strokeStyle);g=CMDialog.AddColorControlToPanel(e,"Pen Color:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(b,c,"strokeStyle",this.value)});d+=40;g=["None","butt","round","square"];var h="None";null!=a&&(h=a.lineCap);g=CMDialog.AddSelectControlToPanel(e,"Cap:",f,d,g,h);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(b,
c,"lineCap",this.value)});d+=40;g=["None","bevel","round","miter"];h="None";null!=a&&(h=a.lineJoin);g=CMDialog.AddSelectControlToPanel(e,"Join:",f,d,g,h);g.TheLayer=b;$(g).change(function(){var a=this.value;"None"==a&&(a=void 0);CMDialogSettings.SetStyle(b,c,"lineJoin",a)});d+=40;g=null;null!=a&&(g=a.miterLimit);g=CMDialog.AddTextControlToPanel(e,"Miter Limit:",f,d,g);g.TheLayer=b;$(g).change(function(){""==this.value&&(this.value=void 0);CMDialogSettings.SetStyle(b,c,"miterLimit",this.value)});d+=
40;g=null;null!=a&&(g=a.lineWidth);g=CMDialog.AddTextControlToPanel(e,"Width:",f,d,g);g.TheLayer=b;$(g).change(function(){""==this.value&&(this.value=void 0);CMDialogSettings.SetStyle(b,c,"lineWidth",this.value)});d+=50;h=null;null!=a&&(h=a.fillStyle);g=CMDialog.AddColorControlToPanel(e,"Fill Color:",f,d,h);g.TheLayer=b;$(g).change(function(){var a=CMDialog.GetRGBAFromControls(this,this.FillTransparencyControl);CMDialogSettings.SetStyle(this.TheLayer,c,"fillStyle",a)});d+=40;h=100;null!=a&&(h=a.fillStyle,
h=100*CMUtilities.GetRGBAValuesFromRGBA(h).Transparency);f=CMDialog.AddSliderControlToPanel(e,"Transparency:",f,d,0,100,h);f.TheLayer=b;$(f).change(function(){var a=CMDialog.GetRGBAFromControls(this.FillColorControl,this);CMDialogSettings.SetStyle(this.TheLayer,c,"fillStyle",a)});f.FillColorControl=g;g.FillTransparencyControl=f;d+=40;g.FillTransparencyControl=f;f.FillColorControl=g;f=270;d=10;CMDialog.AddLabelToPanel(e,"Shadow Settings:",f,d).style.fontSize="18px";d+=40;g=null;null!=a&&(g=a.shadowColor);
g=CMDialog.AddColorControlToPanel(e,"Color:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowColor",this.value)});d+=40;g=0;null!=a&&(g=a.shadowBlur);g=CMDialog.AddTextControlToPanel(e,"Blur:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowBlur",this.value)});d+=40;g=0;null!=a&&(g=a.shadowOffsetX);g=CMDialog.AddTextControlToPanel(e,"X Offset:",f,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetStyle(this.TheLayer,
c,"shadowOffsetX",this.value)});g=0;null!=a&&(g=a.shadowOffsetY);d=CMDialog.AddTextControlToPanel(e,"Y Offset:",f,d+40,g);d.TheLayer=b;$(d).change(function(){CMDialogSettings.SetStyle(this.TheLayer,c,"shadowOffsetY",this.value)});return e};
CMDialogSettings.AddGeneralPanel=function(a,b,c){var d=10,e=document.createElement("div");a.TheElement.appendChild(e);a=b.GetProperty(c,null);var f=100;null!=a&&(f=100*a.globalAlpha);var g=CMDialog.AddSliderControlToPanel(e,"Global Opacity:",10,d,0,100,f);g.TheLayer=b;$(g).change(function(){var a=g.value/100;1<a&&(a=1);0>a&&(a=0);CMDialogSettings.SetStyle(b,c,"globalAlpha",a)});d+=40;a=b.GetPropertyAttribute(CMLayer.INFO);f=b.GetDataset().GetAttributeHeadings();var h=CMDialog.AddSelectControlToPanel(e,
"Attribute:",10,d,f,a);h.TheLayer=b;$(h).change(function(){this.TheLayer.SetPropertyAttribute(CMLayer.INFO,h.value);this.TheLayer.GetScene().Repaint()});return e};CMDialogSettings.Fonts="Arial;Verdana;Times New Roman;Courier New;serif;sans-serif".split(";");CMDialogSettings.FontWeights=["normal","bold","bolder","lighter"];CMDialogSettings.LabelDirectionStrings="Top Left;Top;Top Right;Right;Bottom Right;Bottom;Bottom Left;Left".split(";");
CMDialogSettings.AddFontPanel=function(a,b){var c=10,d=10,e=document.createElement("div");a.TheElement.appendChild(e);var f=b.GetProperty(CMLayer.LABEL_FONT,null),g="40",h="Arial";a="normal";if(null!=f){var k=f.indexOf("px");-1!=k&&(g=f.substring(0,k),k=g.lastIndexOf(" "),-1!=k&&(g=g.substring(k+1)),g=parseInt(g));for(k=0;k<CMDialogSettings.Fonts.length;k++)-1!=f.indexOf(CMDialogSettings.Fonts[k])&&(h=CMDialogSettings.Fonts[k]);for(k=0;k<CMDialogSettings.FontWeights.length;k++)-1!=f.indexOf(CMDialogSettings.FontWeights[k])&&
(a=CMDialogSettings.FontWeights[k]);f.indexOf("italic")}f=CMDialog.AddSelectControlToPanel(e,"Font Family:",c,d,CMDialogSettings.Fonts,h);f.TheLayer=b;$(f).change(function(){CMDialogSettings.SetFont(this.Controls,this.TheLayer)});d+=40;a=CMDialog.AddSelectControlToPanel(e,"Font Weight:",c,d,CMDialogSettings.FontWeights,a);a.TheLayer=b;$(a).change(function(){CMDialogSettings.SetFont(this.Controls,this.TheLayer)});d+=40;g=CMDialog.AddTextControlToPanel(e,"Font Size:",c,d,g);g.TheLayer=b;$(g).change(function(){CMDialogSettings.SetFont(this.Controls,
this.TheLayer)});d+=40;h={FontControl:f,FontWeightControl:a,FontSizeControl:g};f.Controls=h;a.Controls=h;g.Controls=h;LabelDirection="TR";a=b.GetProperty(CMLayer.LABEL_POSITION);null!=a&&(LabelDirection=a.Direction);k=CMLayer.LabelDirections.indexOf(LabelDirection);LabelDirectionString=CMDialogSettings.LabelDirectionStrings[k];var l=CMDialog.AddSelectControlToPanel(e,"Direction:",c,d,CMDialogSettings.LabelDirectionStrings,LabelDirectionString);l.TheLayer=b;$(l).change(function(){var a=l.selectedIndex,
b=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);b.Direction=CMLayer.LabelDirections[a];this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,b);this.TheLayer.GetScene().Repaint()});d+=40;f=10;null!=a&&(f=a.OffsetX);var m=CMDialog.AddTextControlToPanel(e,"X Offset:",c,d,f);m.TheLayer=b;$(m).change(function(){var a=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);a.OffsetX=parseInt(m.value);this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,a);this.TheLayer.GetScene().Repaint()});f=10;null!=a&&(f=a.OffsetY);
var n=CMDialog.AddTextControlToPanel(e,"Y Offset:",c,d+40,f);n.TheLayer=b;$(n).change(function(){var a=this.TheLayer.GetProperty(CMLayer.LABEL_POSITION);a.OffsetY=parseInt(n.value);this.TheLayer.SetProperty(CMLayer.LABEL_POSITION,a);this.TheLayer.GetScene().Repaint()});c=300;d=10;a=b.GetPropertyAttribute(CMLayer.LABEL);f=b.GetDataset().GetAttributeHeadings();l=CMDialog.AddSelectControlToPanel(e,"Attribute:",c,d,f,a);l.TheLayer=b;$(l).change(function(){this.TheLayer.SetPropertyAttribute(CMLayer.LABEL,
l.value);this.TheLayer.GetScene().Repaint()});return e};CMDialogSettings.MarkTypes=["Circle","Triangle","Square","Star"];
CMDialogSettings.AddMarkPanel=function(a,b){var c=10,d=document.createElement("div");a.TheElement.appendChild(d);a=b.GetProperty(CMLayer.MARK_TYPE);a=CMDialog.AddSelectControlToPanel(d,"Mark Type:",10,c,CMDialogSettings.MarkTypes,CMDialogSettings.MarkTypes[a]);a.TheLayer=b;$(a).change(function(){this.TheLayer.SetProperty(CMLayer.MARK_TYPE,this.selectedIndex);this.TheLayer.GetScene().Repaint()});c+=40;a=b.GetProperty(CMLayer.MARK_SIZE);c=CMDialog.AddTextControlToPanel(d,"Mark Size:",10,c,a);c.TheLayer=
b;$(c).change(function(){var a=parseInt(this.value);this.TheLayer.SetProperty(CMLayer.MARK_SIZE,a);this.TheLayer.GetScene().Repaint()});return d};CMDialogSettings.SetFont=function(a,b){b.SetProperty(CMLayer.LABEL_FONT,a.FontWeightControl.value+" "+a.FontSizeControl.value+"px "+a.FontControl.value);b.GetScene().Repaint()};CMDialogSettings.HidePanels=function(a){for(var b=0;b<a.Panels.length;b++)a.Panels[b].style.visibility="hidden",a.Tabs[b].className="CM_SettingsDialogTab"};
CMDialogSettings.AddTab=function(a,b,c,d,e,f,g,h){d=document.createElement("LI");d.className="CM_SettingsDialogTab";a.appendChild(d);a=document.createTextNode(c);d.appendChild(a);d.TargetPanel=h;d.TargetTab=d;d.TheDialog=b;d.addEventListener("click",function(){CMDialogSettings.HidePanels(this.TheDialog);this.TargetTab.className="CM_SettingsDialogTab_Selected";this.TargetPanel.style.visibility="visible"});return d};
CMDialogSettings.ShowSettingsDialog=function(a){var b=new CMDialog("LayerVector_Settings_Dialog",600,400);b.SuperClass_SetVisible=b.SetVisible;b.SetVisible=function(a){this.SuperClass_SetVisible(a);!1===a&&CMDialogSettings.HidePanels(this)};null==a.TheStyle&&(a.TheStyle={});var c=document.createElement("UL");b.TheElement.appendChild(c);var d=CMDialogSettings.AddGeneralPanel(b,a,CMLayer.FEATURE_STYLE);d.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(d,10,40,500,500);var e=CMDialogSettings.AddPenPanel(b,
a,CMLayer.FEATURE_STYLE);e.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(e,10,40,500,500);var f=CMDialogSettings.AddPenPanel(b,a,CMLayer.LABEL_STYLE);f.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(f,10,40,500,500);var g=CMDialogSettings.AddFontPanel(b,a);g.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(g,10,40,500,500);var h=CMDialogSettings.AddMarkPanel(b,a);h.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(h,10,40,500,500);var k=CMDialogSettings.AddPenPanel(b,
a,CMLayer.MOUSE_OVER_STYLE);k.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(k,10,40,500,500);a=CMDialogSettings.AddPenPanel(b,a,CMLayer.SELECTED_STYLE);a.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(a,10,40,500,500);b.Panels=[];b.Tabs=[];b.Panels.push(d);b.Panels.push(e);b.Panels.push(f);b.Panels.push(g);b.Panels.push(h);b.Panels.push(k);b.Panels.push(a);d=CMDialogSettings.AddTab(c,b,"General",10,10,100,30,d);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Feature",10,10,100,
30,e);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Labels",10,10,100,30,f);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Font",10,10,100,30,g);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Marks",10,10,100,30,h);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Mouse",10,10,100,30,k);b.Tabs.push(d);d=CMDialogSettings.AddTab(c,b,"Selected",10,10,100,30,a);b.Tabs.push(d);CMDialogSettings.HidePanels(b);b.Panels[0].style.visibility="visible";return b};
CMDialogSettings.ShowSettingsDialogForStyle=function(a){var b=new CMDialog("LayerVector_Settings_Dialog",600,400);b.SuperClass_SetVisible=b.SetVisible;b.SetVisible=function(a){this.SuperClass_SetVisible(a);!1===a&&CMDialogSettings.HidePanels(this)};null==a&&(a={});a=document.createElement("UL");b.TheElement.appendChild(a);var c=CMDialogSettings.AddPenPanel(b,TheLayer,CMLayer.LABEL_STYLE);c.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(c,10,40,500,500);var d=CMDialogSettings.AddFontPanel(b,
TheLayer);d.className="CM_SettingsPanel";CMUtilities.AbsolutePosition(d,10,40,500,500);b.Panels=[];b.Tabs=[];b.Panels.push(c);b.Panels.push(d);TheTab=CMDialogSettings.AddTab(a,b,"Labels",10,10,100,30,c);b.Tabs.push(TheTab);TheTab=CMDialogSettings.AddTab(a,b,"Font",10,10,100,30,d);b.Tabs.push(TheTab);CMDialogSettings.HidePanels(b);b.Panels[0].style.visibility="visible";return b};CMItem.SettingDefintions={Item:{Name:{Name:"Name",Type:CMBase.DATA_TYPE_STRING,Default:""},Visible:{Name:"Visible",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!0},Selectable:{Name:"Selectable",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!0},PixelTolerance:{Name:"Pixel Tolerance",Type:CMBase.DATA_TYPE_FLOAT,Default:6}},Style:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Line Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,
Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",
Type:CMBase.DATA_TYPE_FLOAT,Default:1},PatternImage:{Name:"Pattern Images",Type:CMBase.DATA_TYPE_IMAGE,Default:null},GradientType:{Name:"Gradient Type",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["Linear","Radial"],Default:"Radial"},GradientCoordinates:{Name:"Gradient Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null},GradientRadius:{Name:"Gradient Radius",Type:CMBase.DATA_TYPE_FLOAT,Default:100},GradientColors:{Name:"Gradient Colors",Type:CMBase.DATA_TYPE_COLOR_ARRAY,Default:null},globalAlpha:{Name:"Transparency",
Type:CMBase.DATA_TYPE_FLOAT,Default:1},globalCompositeOperation:{Name:"Composite Operation",Type:CMBase.DATA_TYPE_ENUMERATED,Options:"source-over source-atop source-in source-out destination-over destination-atop destination-in destination-out lighter copy xor".split(" "),Default:"source-over"}},Text:{Text:{Name:"Text",Type:CMBase.DATA_TYPE_STRING,Default:null},Visible:{Name:"Text Visible",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!0},font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"12px Arial"},
strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,
Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",Type:CMBase.DATA_TYPE_FLOAT,Default:1},globalAlpha:{Name:"Transparency",Type:CMBase.DATA_TYPE_FLOAT,Default:1},globalCompositeOperation:{Name:"Composite Operation",Type:CMBase.DATA_TYPE_ENUMERATED,Options:"source-over source-atop source-in source-out destination-over destination-atop destination-in destination-out lighter copy xor".split(" "),
Default:"source-over"}}};CMItem.UniqueNumber=0;function CMItem(){CMBase.call(this);this.UniqueNumber=CMItem.UniqueNumber;this.TimeSlices=[{UniqueNumber:CMItem.UniqueNumber,Time:0,Settings:{Item:{Visible:!0},Style:{strokeStyle:"rgb(0,0,0)",lineWidth:1,fillStyle:"rgb(255,255,255)"},Text:{strokeStyle:"rgb(255,255,255)",lineWidth:1,fillStyle:"rgb(0,0,0)"}}}];CMItem.UniqueNumber++;this.LastStyle=null;this.LastTimeSlice=0}CMItem.prototype=Object.create(CMBase.prototype);CMItem.prototype.contructor=CMItem;
CMItem.prototype.SettingsChanged=function(){this.LastStyle=null;this.Repaint()};CMItem.prototype.GetSettingsDefinitions=function(){var a={};for(Key in CMItem.SettingDefintions)a[Key]=CMItem.SettingDefintions[Key];return a};CMItem.prototype.GetSettings=function(a){var b=null;a=CMItem.FindTimeSliceIndex(this.TimeSlices,a);-1!=a&&(b=this.TimeSlices[a].Settings);return b};
CMItem.prototype.SetSettings=function(a,b){var c=0;void 0!=b&&(c=CMItem.FindTimeSliceIndex(this.TimeSlices,b));if(-1!=c){b=this.TimeSlices[c].Settings;for(var d in a){c=a[d];for(var e in c)b[d][e]=c[e]}}this.SettingsChanged()};CMItem.prototype.SetSetting=function(a,b,c,d){var e=0;void 0!=d&&(e=CMItem.FindTimeSliceIndex(this.TimeSlices,d));if(-1!=e){d=this.TimeSlices[e].Settings;try{d[a][b]=c}catch(f){CMMainContainer.Error("Sorry, we could not find the group '"+a+"' or the Key '"+b+"' in this objects settings")}}this.SettingsChanged()};
CMItem.prototype.GetSetting=function(a,b,c,d){var e=null;void 0!=c&&(e=c);c=0;void 0!=d&&(c=CMItem.FindTimeSliceIndex(this.TimeSlices,d));-1!=c&&(a=this.TimeSlices[c].Settings[a],void 0!=a&&b in a&&(e=a[b]));return e};CMItem.prototype.SetSettingGroup=function(a,b,c){var d=0;void 0!=c&&(d=CMItem.FindTimeSliceIndex(this.TimeSlices,c));-1!=d&&(this.TimeSlices[d].Settings[a]=b);this.SettingsChanged()};
CMItem.prototype.GetSettingGroup=function(a,b,c){var d=null;void 0!=b&&(d=b);b=0;void 0!=c&&(b=CMItem.FindTimeSliceIndex(this.TimeSlices,c));-1!=b&&(d=this.TimeSlices[b].Settings[a]);return d};CMItem.prototype.UnselectAll=function(a){this.Selected&&(this.Selected=!1,void 0!=this.LayerInList&&(this.LayerInList.className="CM_LayerListItemClass"),a&&this.GetParent(CMScene).SelectionChanged(this))};
CMItem.FindTimeSliceIndex=function(a,b){var c=-1;if(void 0==b)0<a.length&&(c=0);else for(var d=0;d<a.length&&-1==c;d++)a[d].Time==b&&(c=d);return c};CMItem.prototype.GetTimes=function(a){a=[];for(var b=0;b<this.TimeSlices.length;b++)CMUtilities.InsertIntoSortedArray(a,parseFloat(this.TimeSlices[b].Time));return a};
CMItem.prototype.InsertTime=function(a){for(var b=this.TimeSlices,c=-1,d=0;d<b.length;d++)b[d].Time==a?c=d:b[d].Time>a&&(c=d,b.splice(c,0,a));-1==c&&(c=b.length,b.push({Settings:{},Time:a}));if(-1!=c)for(ClassKey in a=b[c-1].Settings,b=b[c].Settings,a)d=a[ClassKey],d=CMUtilities.Clone(d),b[ClassKey]=d;this.Repaint();return c};CMItem.prototype.DeleteTime=function(a){for(var b=this.TimeSlices,c=-1,d=0;d<b.length;d++)b[d].Time==a&&(c=d,b.splice(c,1));this.Repaint();return c};
CMItem.GetTweenFloatValue=function(a,b,c,d){void 0!=a?c=void 0!=b?a*d+b*(1-d):a:void 0!=b&&(c=b);return c};CMItem.GetTweenColorValue=function(a,b,c,d){var e=null;void 0!=a?(e=CMUtilities.GetColorsFromAnyColor(a),void 0!=b?(a=CMUtilities.GetColorsFromAnyColor(b),e={Red:Math.round(e.Red*d+a.Red*(1-d)),Green:Math.round(e.Green*d+a.Green*(1-d)),Blue:Math.round(e.Blue*d+a.Blue*(1-d))}):e=a):void 0!=b&&(e=b);null!=e&&(c="rgb("+e.Red+","+e.Green+","+e.Blue+")");return c};
CMItem.GetTweenStyleValue=function(a,b,c,d){return CMItem.GetTweenColorValue(a,b,c,d)};CMItem.GetTimeFactor=function(a){a=a[1].Time-a[0].Time;return(a-TimeSlice)/a};
CMItem.prototype.GetBoundingTimeSlices=function(a){void 0==a&&(a=this.GetParent(CMScene).GetTimeRange());for(var b=null,c=null,d=0;d<this.TimeSlices.length&&null==b;d++){var e=parseFloat(this.TimeSlices[d].Time);e==a?b=this.TimeSlices[d]:e>a&&(0==d?b=this.TimeSlices[0]:(b=this.TimeSlices[d-1],c=this.TimeSlices[d]))}null==b&&0<this.TimeSlices.length&&(b=this.TimeSlices[this.TimeSlices.length-1]);return[b,c]};
CMItem.prototype.GetStyle=function(a,b,c){void 0==b&&(b=0);void 0==c&&(c="Style");this.LastStyle=null;this.LastTimeSlice=b;a=this.GetBoundingTimeSlices(b);var d=a[0];b=d.Settings;var e=a[1];if(null!=d){var f;if(null==e)for(TheSettingKey1 in b=b[c],b)void 0===f&&(f={}),c=b[TheSettingKey1],f[TheSettingKey1]=c;else for(TheSettingKey1 in d=e.Settings,a=CMItem.GetTimeFactor(a),b=b[c],d=d[c],b)void 0===f&&(f={}),c=b[TheSettingKey1],e=d[TheSettingKey1],f[TheSettingKey1]="strokeStyle"==TheSettingKey1||"fillStyle"==
TheSettingKey1?CMItem.GetTweenStyleValue(c,e,"rgb(0,0,0)",a):"shadowColor"==TheSettingKey1?CMItem.GetTweenColorValue(c,e,"rgb(0,0,0)",a):CMItem.GetTweenFloatValue(c,e,0,a);for(key in f);this.LastStyle=f}return this.LastStyle};CMItem.prototype.GetRefTolerance=function(a){var b=this.GetSetting("Item","PixelTolerance",6);return a.GetRefWidthFromPixelWidth(b)};
CMItem.prototype.AddToList=function(a,b,c,d){var e=null;e=document.createElement("div");e.className="CM_LayerListItemClass";a.appendChild(e);this.LayerInList=e;this.Selected&&(this.LayerInList.className="CM_LayerListItemClass_Selected");var f=document.createElement("input");f.className="CM_LayerListCheckBoxClass";f.type="checkbox";f.TheLayer=this;f.checked=this.GetVisible();f.addEventListener("click",function(){this.checked?this.TheLayer.SetVisible(!0):this.TheLayer.SetVisible(!1)});CMUtilities.AbsolutePosition(f,
b+2,-6,30,d-6);e.appendChild(f);f=this.GetIcon();CMUtilities.IsDefined(f)&&(CMUtilities.AbsolutePosition(f,b+28,-5,16,16),e.appendChild(f));f=document.createElement("div");f.className="CM_LayerListNameClass";var g=this.GetName();null===g&&(g="Untitled");f.innerHTML=g;f.TheLayer=this;f.TheElement=a;f.LayerInList=e;f.TheLayerList=this;CMUtilities.AbsolutePosition(f,b+48,0,170,d);this.DraggingDiv=null;document.addEventListener("contextmenu",function(a){a.preventDefault();return!1});f.addEventListener("mousedown",
function(a){this.TheLayer.SetSelected(!0);if(0==a.button){this.DraggingDiv=document.getElementById("DraggingDiv");null==this.DraggingDiv&&(this.DraggingDiv=document.createElement("div"),this.DraggingDiv.className="CM_DraggingDivClass",this.DraggingDiv.id="DraggingDiv");this.DraggingDiv.style.visibility="visible";this.TheElement.appendChild(this.DraggingDiv);this.TheElement.DraggingDiv=DraggingDiv;this.TheElement.DraggingLayer=this.TheLayer;var b=$(this.TheElement).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,
0,a.clientY-b.top,200,0)}else b=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",a.clientX,a.clientY),this.TheLayer.FillPopupMenu(b);a.stopPropagation();a.preventDefault();return!1});f.addEventListener("mouseup",function(a){a.preventDefault();return!1});e.appendChild(f);a=jQuery(a).outerWidth(!1);CMUtilities.AbsolutePosition(e,b+2,c,a,d)};CMItem.prototype.Repaint=function(){var a=this.GetParent(CMScene);null!=a&&a.Repaint()};CMItem.prototype.Paint=function(a){};CMItem.prototype.PaintSelected=function(a){};
CMItem.prototype.GetName=function(){return this.GetSetting("Item","Name","")};CMItem.prototype.SetName=function(a){this.SetSetting("Item","Name",a)};CMItem.prototype.GetSelected=function(){return this.Selected};
CMItem.prototype.SetSelected=function(a){if(this.Selected!=a){var b=this instanceof CMScene?this:this.GetParent(CMScene);a?(b.UnselectAll(!1),this.Selected=!0,void 0!=this.LayerInList&&(this.LayerInList.className="CM_LayerListItemClass_Selected")):(this.Selected=!1,this.LayerInList.className="CM_LayerListItemClass");b.SelectionChanged(this)}};CMItem.prototype.SetVisible=function(a){this.GetSetting("Item","Visible")!=a&&(this.SetSetting("Item","Visible",a),this.Repaint())};
CMItem.prototype.GetVisible=function(){return this.GetSetting("Item","Visible",!0)};CMItemPoly.SettingDefintions={Curve:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null},Smoothing:{Name:"Smoothing",Type:CMBase.DATA_TYPE_BOOLEAN_ARRAY,Default:null}}};function CMItemPoly(){CMItem.call(this);this.TimeSlices[0].Settings.Curve={};this.Anchor=null;this.Creating=this.Dragging=!1;this.SelectedPart=-1;this.Closed=!1}CMItemPoly.prototype=Object.create(CMItem.prototype);CMItemPoly.prototype.contructor=CMItemPoly;
CMItemPoly.prototype.GetAnchor=function(a,b,c,d){a=this.GetParent(CMScene).GetTimeRange();a=this.GetControlPoints(a);return{X:c-a.Ys[d],Y:b-a.Xs[d]}};CMItemPoly.prototype.GetName=function(){return"Curve"};CMItemPoly.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;CMItemPoly.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMItemPoly.SettingDefintions)a[Key]=CMItemPoly.SettingDefintions[Key];return a};
CMItemPoly.prototype.MouseDown=function(a,b,c,d){var e=!1;if(0==e&&this.Creating){var f=this.GetParent(CMScene).GetTimeRange();e=this.GetControlPoints(f);var g=e.Xs.length;2==d.detail?(this.Dragging=this.Creating=!1,e.Xs.pop(),e.Ys.pop(),e.Smoothing.pop()):(d=this.GetRefTolerance(a),0==this.InPart(a,b,c,d)?(e.Xs.pop(),e.Ys.pop(),e.Smoothing.pop(),this.Closed=!0,this.Dragging=this.Creating=!1):(e.Xs.splice(g-1,0,b),e.Ys.splice(g-1,0,c),e.Smoothing.splice(g-1,0,e.Smoothing[g-1])));this.SetControlPoints(f,
e.Xs,e.Ys,e.Smoothing);e=!0;this.Repaint()}else if(0==e)if(0==event.button){if(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)d=this.GetRefTolerance(a),d=this.InPart(a,b,c,d),-1!=d&&(this.Dragging=!0,this.SelectedPart=d,this.Anchor=this.GetAnchor(a,b,c,d),e=!0)}else d=this.InPart(a,b,c,3),-1!=d&&(a=CMUtilities.GetPopupMenu("CM_LayerPopupMenu",event.clientX,event.clientY),b=document.createElement("div"),b.setAttribute("id","CM_DeleteElementMenuItem"),b.className="CM_LayerListPopupMenuItem",
b.innerHTML="Delete",b.TheItem=this,b.SelectedPart=d,b.ThePopupMenu=a,b.addEventListener("click",function(a){this.TheItem.DeleteControlPoint(this.SelectedPart);a.stopPropagation();this.TheItem.Repaint()}),a.appendChild(b),b=document.createElement("div"),b.setAttribute("id","CM_DuplicateElementMenuItem"),b.className="CM_LayerListPopupMenuItem",b.innerHTML="Duplicate",b.TheItem=this,b.SelectedPart=d,b.ThePopupMenu=a,b.addEventListener("click",function(a){this.TheItem.DuplicateControlPoint(this.SelectedPart);
a.stopPropagation();this.TheItem.Repaint()}),a.appendChild(b),b=document.createElement("div"),b.setAttribute("id","CM_SmoothElementMenuItem"),b.className="CM_LayerListPopupMenuItem",this.GetSetting("Curve","Smoothing",void 0,f)[d]?b.innerHTML="Make sharp":b.innerHTML="Make smooth",b.TheItem=this,b.SelectedPart=d,b.ThePopupMenu=a,b.addEventListener("click",function(a){var b=this.TheItem.GetSetting("Curve","Smoothing",void 0,f);b[this.SelectedPart]=b[this.SelectedPart]?!1:!0;this.TheItem.SetSetting("Curve",
"Smoothing",b,f);a.stopPropagation();this.TheItem.Repaint()}),a.appendChild(b));return e};
CMItemPoly.prototype.MouseMove=function(a,b,c,d){d=this.GetParent(CMScene).GetTimeRange();this.Creating?(a=this.GetControlPoints(d),d=a.Xs.length,a.Xs[d-1]=b,a.Ys[d-1]=c,this.Repaint()):this.Dragging?(a=this.GetControlPoints(d),a.Xs[this.SelectedPart]=b+this.Anchor.X,a.Ys[this.SelectedPart]=c+this.Anchor.Y,this.Repaint()):(d=this.GetRefTolerance(a),-1!==this.InPart(a,b,c,d)&&(this.GetParent(CMMainContainer).GetElement(CMMainContainer.CANVAS).style.cursor="move"));return!1};
CMItemPoly.prototype.MouseUp=function(a,b,c,d){a=!1;this.Dragging&&0==this.Creating&&(this.Dragging=!1,a=!0);return a};CMItemPoly.prototype.StartCreating=function(a,b){this.Anchor={X:0,Y:0};this.SelectedPart=CMItem.PART_LOWER_RIGHT;this.Creating=this.Dragging=!0};
CMItemPoly.prototype.Paint=function(a){var b=this.GetTweenedControlPoints(),c=b.Xs;b=b.Ys;var d=this.GetSetting("Curve","Smoothing"),e=this.GetParent(CMScene).GetTimeRange();e=this.GetStyle(a,e);void 0!=e&&a.SetStyle(e,!0);if(!(1>=c.length))if(2==c.length)a.PaintRefLine(c[0],b[0],c[1],b[1]);else{var f=c.length,g=c.length;0==this.Closed&&(g=c.length-1);for(var h=[c[0]],k=[b[0]],l=0;l<g;l++){var m=l,n=l+1;n==c.length&&(n=0);var p=!1;if(0!=l||this.Closed)p=d[m];var q=!1;if(l+1<f-1||this.Closed)q=d[n];
var r=m-1;0>r&&(r=c.length-1);var t=n+1;t==c.length&&(t=0);if(0==p){if(0!=q)for(m=CMUtilityBezier.GetThreePoint3D(10,c[m],b[m],0,c[n],b[n],0,c[t],b[t],0),p=0;p<m[0].length;p++)h.push(m[0][p]),k.push(m[1][p])}else if(q)for(m=CMUtilityBezier.GetFourPoint2D(10,c[r],b[r],c[m],b[m],c[n],b[n],c[t],b[t]),p=0;p<m[0].length;p++)h.push(m[0][p]),k.push(m[1][p]);else for(m=CMUtilityBezier.GetThreePoint3D(10,c[n],b[n],0,c[m],b[m],0,c[r],b[r],0),p=m[0].length-1;0<=p;p--)h.push(m[0][p]),k.push(m[1][p]);h.push(c[n]);
k.push(b[n])}a.PaintRefPoly(h,k,this.Closed)}void 0!=e&&a.RestoreStyle()};CMItemPoly.prototype.PaintSelected=function(a){if(this.Selected){a.SaveStyle();a.SetStyle({fillStyle:"rgba(0,0,0,1)",strokeStyle:"white"});var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetControlPoints(b);if(null!=c){b=c.Xs;c=c.Ys;for(var d=0;d<b.length;d++)a.PaintRefCircle(b[d],c[d],5)}a.RestoreStyle()}};
CMItemPoly.prototype.GetControlPoints=function(a){a=this.GetBoundingTimeSlices(a);Settings=a[0].Settings;void 0!=Settings&&void 0!=Settings.Curve.Coordinates&&(a={Xs:Settings.Curve.Coordinates.Xs,Ys:Settings.Curve.Coordinates.Ys,Smoothing:Settings.Curve.Smoothing});return a};
CMItemPoly.prototype.SetControlPoints=function(a,b,c,d){Settings=this.GetBoundingTimeSlices(a)[0].Settings;void 0!=Settings?(void 0==Settings.Curve.Coordinates&&(Settings.Curve.Coordinates={}),void 0==Settings.Curve.Smoothing&&(Settings.Curve.Smoothing=[]),Settings.Curve.Coordinates.Xs=b,Settings.Curve.Coordinates.Ys=c,Settings.Curve.Smoothing=d):alert("Sorry, time slice "+a+" is not defined")};
CMItemPoly.prototype.GetTweenedControlPoints=function(){var a=[],b=[];this.GetParent(CMMainContainer);var c=this.GetParent(CMScene).GetTimeRange(),d=this.GetBoundingTimeSlices(c);c=d[0].Time;if(null==d[1])d=this.GetControlPoints(c),a=d.Xs,b=d.Ys;else{CMItem.GetTimeFactor(d);d=this.GetControlPoints(c);c=d.Xs;var e=d.Ys;d=this.GetControlPoints(TheTime2);var f=d.Xs;d=d.Ys;for(var g=0;g<c.length;g++)a[g]=c[g]*Factor1+f[g]*Factor2,b[g]=e[g]*Factor1+d[g]*Factor2}return{Xs:a,Ys:b}};
CMItemPoly.prototype.DeleteControlPoint=function(a){var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetControlPoints(b);c.Xs.splice(a,1);c.Ys.splice(a,1);c.Smoothing.splice(a,1);this.SetControlPoints(b,c.Xs,c.Ys,c.Smoothing)};CMItemPoly.prototype.DuplicateControlPoint=function(a){var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetControlPoints(b);c.Xs.splice(a,0,c.Xs[a]);c.Ys.splice(a,0,c.Ys[a]);c.Smoothing.splice(a,0,c.Smoothing[a]);this.SetControlPoints(b,c.Xs,c.Ys,c.Smoothing)};
CMItemPoly.prototype.InPart=function(a,b,c,d){a=-1;var e=this.GetParent(CMScene).GetTimeRange(),f=this.GetControlPoints(e);if(null!=f){e=f.Xs;f=f.Ys;for(var g=0;g<e.length&&-1==a;g++){var h=f[g];Math.abs(e[g]-b)<d&&Math.abs(h-c)<d&&(a=g)}}return a};CMItemPolyArrow.NUM_STEPS=30;CMItemPolyArrow.SettingDefintions={Arrow:{BarbWidth:{Name:"Barb Width",Type:CMBase.DATA_TYPE_INTEGER,Default:2},BarbLength:{Name:"Barb Length",Type:CMBase.DATA_TYPE_INTEGER,Default:3},ShaftWidth:{Name:"Shaft Width",Type:CMBase.DATA_TYPE_INTEGER,Default:2},HeadLength:{Name:"Head Length",Type:CMBase.DATA_TYPE_INTEGER,Default:4}}};
function CMItemPolyArrow(){CMItemPoly.call(this);this.BarbLength=this.BarbWidth=5;this.ShaftWidth=2;this.HeadLength=4;this.Type=CMLayerItems.ARROW;this.SpineYs=this.SpineXs=this.FinalYs=this.FinalXs=null;this.TimeSlices[0].Settings.Arrow={BarbWidth:5,BarbLength:5,ShaftWidth:2,HeadLength:4}}CMItemPolyArrow.prototype=Object.create(CMItemPoly.prototype);CMItemPolyArrow.prototype.contructor=CMItemPolyArrow;CMItemPolyArrow.prototype.ResetCoordinates=function(){this.FinalYs=this.FinalXs=null};
CMItemPolyArrow.prototype.InitializeCoordinates=function(){null==this.FinalXs&&this.FindCoordinates()};function FindBannerPoints(a,b,c,d,e,f,g){c=e-c;d=f-d;f=Math.sqrt(c*c+d*d);c=c/f*g;d=d/f*g;return[{X:a+d,Y:b-c},{X:a-d,Y:b+c}]}function GetPointsOffLine(a,b,c,d,e){var f=Math.sin(c);c=Math.cos(c);return Result={RightX:a-f*e-c*d,RightY:b-c*e+f*d,LeftX:a-f*e+c*d,LeftY:b-c*e-f*d}}
CMItemPolyArrow.prototype.FindCoordinates=function(){var a=this.GetTweenedControlPoints(),b=a.Xs,c=a.Ys,d=b.length-1,e=[],f=[];e.push(b[0]);f.push(c[0]);if(2==b.length)e.push(b[1]),f.push(c[1]);else if(2<b.length){var g=CMUtilityBezier.GetThreePoint3D(CMItemPolyArrow.NUM_STEPS,b[0],c[0],0,b[1],c[1],0,b[2],c[2],0);for(a=0;a<g[0].length;a++)e.push(g[0][a]),f.push(g[1][a]);for(g=1;g<b.length-1;g++){e.push(b[g]);f.push(c[g]);var h=CMUtilityBezier.GetFourPoint2D(CMItemPolyArrow.NUM_STEPS,b[g-1],c[g-1],
b[g],c[g],b[g+1],c[g+1],b[g+2],c[g+2]);for(a=0;a<h[0].length;a++)e.push(h[0][a]),f.push(h[1][a])}e.push(b[d-1]);f.push(c[d-1]);h=CMUtilityBezier.GetThreePoint3D(CMItemPolyArrow.NUM_STEPS,b[d],c[d],0,b[d-1],c[d-1],0,b[d-2],c[d-2],0);for(a=h[0].length-1;0<=a;a--)e.push(h[0][a]),f.push(h[1][a]);var k=0,l=b[d],m=c[d];g=e.length-1;for(a=0;a<h[0].length&&k<this.ShaftWidth;a++)k+=CMUtilities.GetLength(l,m,h[0][a],h[1][a]),g--,l=h[0][a],m=h[1][a];0<g&&g--}this.SpineXs=e;this.SpineYs=f;var n=Math.atan2(e[e.length-
1]-e[e.length-2],f[e.length-1]-f[e.length-2]);a=GetPointsOffLine(b[d],c[d],n,this.BarbWidth,this.BarbLength);h=a.RightX;k=a.RightY;l=a.LeftX;m=a.LeftY;a=GetPointsOffLine(b[d],c[d],n,this.ShaftWidth,this.HeadLength);n=a.RightX;var p=a.RightY,q=a.LeftX,r=a.LeftY,t=[],u=[],v=[],w=[],x=FindBannerPoints(e[0],f[0],e[0],f[0],e[1],f[1],this.ShaftWidth);t.push(x[0].X);u.push(x[0].Y);v.push(x[1].X);w.push(x[1].Y);for(a=0;a<g;a++)x=FindBannerPoints(e[a],f[a],e[a],f[a],e[a+1],f[a+1],this.ShaftWidth),t.push(x[0].X),
u.push(x[0].Y),v.push(x[1].X),w.push(x[1].Y);e=[];f=[];for(a=0;a<v.length;a++)e.push(v[a]),f.push(w[a]);e.push(n);f.push(p);e.push(h);f.push(k);e.push(b[d]);f.push(c[d]);e.push(l);f.push(m);e.push(q);f.push(r);for(a=0;a<t.length;a++)e.push(t[t.length-a-1]),f.push(u[u.length-a-1]);e.push(e[0]);f.push(f[0]);this.FinalXs=e;this.FinalYs=f};
CMItemPolyArrow.prototype.Private_SetupProperties=function(a,b){var c=this.GetBoundingTimeSlices(b);a=c[0].Settings;this.BarbWidth=a.Arrow.BarbWidth;this.BarbLength=a.Arrow.BarbLength;this.ShaftWidth=a.Arrow.ShaftWidth;this.HeadLength=a.Arrow.HeadLength;null!=c[1]&&(b=c[1].Settings,c=CMItem.GetTimeFactor(c),this.BarbWidth=a.Arrow.BarbWidth*(1-c)+b.Arrow.BarbWidth*c,this.BarbLength=a.Arrow.BarbLength,this.ShaftWidth=a.Arrow.ShaftWidth,this.HeadLength=a.Arrow.HeadLength)};
CMItemPolyArrow.prototype.GetName=function(){return"Arrow"};CMItemPolyArrow.prototype.CMItemPoly_GetSettingsDefinitions=CMItemPoly.prototype.GetSettingsDefinitions;CMItemPolyArrow.prototype.GetSettingsDefinitions=function(){var a=this.CMItemPoly_GetSettingsDefinitions();for(Key in CMItemPolyArrow.SettingDefintions)a[Key]=CMItemPolyArrow.SettingDefintions[Key];return a};
CMItemPolyArrow.prototype.Paint=function(a){this.InitializeCoordinates();var b=this.GetParent(CMScene).GetTimeRange();this.Private_SetupProperties(a,b);this.FindCoordinates();b=this.GetStyle(a,b);void 0!=b&&a.SetStyle(b,!0);a.PaintRefPoly(this.FinalXs,this.FinalYs,!0);void 0!=b&&a.RestoreStyle()};CMItemPolyArrow.prototype.CMItemPoly_SetControlPoints=CMItemPoly.prototype.SetControlPoints;CMItemPolyArrow.prototype.SetControlPoints=function(a,b,c,d){this.CMItemPoly_SetControlPoints(a,b,c,d);this.ResetCoordinates()};CMItemRect.RECTANGLE=0;CMItemRect.OVAL=1;CMItemRect.ROUNDED_RECTANGLE=2;CMItemRect.PART_UPPER_LEFT=0;CMItemRect.PART_UPPER_RIGHT=1;CMItemRect.PART_LOWER_RIGHT=2;CMItemRect.PART_LOWER_LEFT=3;CMItemRect.PART_TOP=4;CMItemRect.PART_RIGHT=5;CMItemRect.PART_BOTTOM=6;CMItemRect.PART_LEFT=7;CMItemRect.PART_INSIDE=8;
CMItemRect.SettingDefintions={Rectangle:{Coordinates:{Name:"Coordinates",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}},RoundedRectangle:{RoundedCornerWidth:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,Default:3},RoundedCornerHeight:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:3}}};
function CMItemRect(a){CMItem.call(this);this.Type=a;switch(a){case CMItemRect.RECTANGLE:this.SetName("Rectangle");break;case CMItemRect.OVAL:this.SetName("Oval");break;case CMItemRect.ROUNDED_RECTANGLE:this.SetName("Rounded Rectangle")}this.TimeSlices[0].Settings.Rectangle={Coordinates:{Xs:[0,10],Ys:[0,10]}};this.TimeSlices[0].Settings.RoundedRectangle={RoundedCornerWidth:3,RoundedCornerHeight:3};this.Anchor=null;this.Dragging=!1}CMItemRect.prototype=Object.create(CMItem.prototype);
CMItemRect.prototype.contructor=CMItemRect;CMItemRect.prototype.GetControlBounds=function(){var a=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;return{XMin:a.Xs[0],XMax:a.Xs[1],YMin:a.Ys[0],YMax:a.Ys[1]}};CMItemRect.prototype.SetControlBounds=function(a,b,c,d){var e=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;e.Xs[0]=a;e.Xs[1]=b;e.Ys[0]=c;e.Ys[1]=d};
CMItemRect.prototype.GetAnchor=function(a,b,c){var d=0,e=0,f=this.GetControlBounds();switch(c){case CMItemRect.PART_LOWER_LEFT:e=a-f.XMin;d=b-f.YMin;break;case CMItemRect.PART_UPPER_LEFT:e=a-f.XMin;d=b-f.YMax;break;case CMItemRect.PART_LEFT:e=a-f.XMin;break;case CMItemRect.PART_LOWER_RIGHT:e=a-f.XMax;d=b-f.YMin;break;case CMItemRect.PART_UPPER_RIGHT:e=a-f.XMax;d=b-f.YMax;break;case CMItemRect.PART_RIGHT:e=a-f.XMax;break;case CMItemRect.PART_TOP:d=b-f.YMax;break;case CMItemRect.PART_BOTTOM:d=b-f.YMin;
break;case CMItemRect.PART_INSIDE:e=a-f.XMin,d=b-f.YMin}return{X:e,Y:d}};
CMItemRect.prototype.InPart=function(a,b,c,d){a=-1;var e=this.GetControlBounds();b<e.XMax+d&&b>e.XMin-d&&c<e.YMax+d&&c>e.YMin-d&&(b<e.XMin+d?(a=c<e.YMin+d?CMItemRect.PART_LOWER_LEFT:c>e.YMax-d?CMItemRect.PART_UPPER_LEFT:CMItemRect.PART_LEFT,e.AnchorX=b-e.XMin):a=b>e.XMax-d?c<e.YMin+d?CMItemRect.PART_LOWER_RIGHT:c>e.YMax-d?CMItemRect.PART_UPPER_RIGHT:CMItemRect.PART_RIGHT:c>e.YMax-d?CMItemRect.PART_TOP:c<e.YMin+d?CMItemRect.PART_BOTTOM:CMItemRect.PART_INSIDE);return a};
CMItemRect.prototype.SetXMin=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Xs[0]=a;b.Xs[0]>b.Xs[1]&&(b.Xs[0]=b.Xs[1])};CMItemRect.prototype.SetXMax=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Xs[1]=a;b.Xs[1]<b.Xs[0]&&(b.Xs[1]=b.Xs[0])};CMItemRect.prototype.SetYMin=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Ys[0]=a;b.Ys[0]>b.Ys[1]&&(b.Ys[0]=b.Ys[1])};
CMItemRect.prototype.SetYMax=function(a){var b=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;b.Ys[1]=a;b.Ys[1]<b.Ys[0]&&(b.Ys[1]=b.Ys[0])};CMItemRect.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;CMItemRect.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMItemRect.SettingDefintions)a[Key]=CMItemRect.SettingDefintions[Key];return a};
CMItemRect.prototype.MouseDown=function(a,b,c,d){d=this.GetRefTolerance(a);a=this.InPart(a,b,c,d);-1!=a&&(this.Dragging=!0,this.SelectedPart=a,this.Anchor=this.GetAnchor(b,c,a))};
CMItemRect.prototype.MouseMove=function(a,b,c,d){d=!1;if(this.Dragging){d=this.Anchor;switch(this.SelectedPart){case CMItemRect.PART_UPPER_LEFT:this.SetXMin(b+d.X);this.SetYMax(c+d.Y);break;case CMItemRect.PART_UPPER_RIGHT:this.SetXMax(b+d.X);this.SetYMax(c+d.Y);break;case CMItemRect.PART_LOWER_RIGHT:this.SetXMax(b+d.X);this.SetYMin(c+d.Y);break;case CMItemRect.PART_LOWER_LEFT:this.SetXMin(b+d.X);this.SetYMin(c+d.Y);break;case CMItemRect.PART_TOP:this.SetYMax(c+d.Y);break;case CMItemRect.PART_RIGHT:this.SetXMax(b+
d.X);break;case CMItemRect.PART_BOTTOM:this.SetYMin(c+d.Y);break;case CMItemRect.PART_LEFT:this.SetXMin(b+d.X);break;case CMItemRect.PART_INSIDE:a=this.GetBoundingTimeSlices()[0].Settings.Rectangle.Coordinates;var e=a.Xs[1]-a.Xs[0],f=a.Ys[1]-a.Ys[0];a.Xs[0]=b-d.X;a.Ys[0]=c-d.Y;a.Xs[1]=b+e-d.X;a.Ys[1]=c+f-d.Y}d=!0;this.Repaint()}else switch(e=this.GetRefTolerance(a),b=this.InPart(a,b,c,e),c=this.GetParent(CMMainContainer).GetElement(CMMainContainer.CANVAS),c.style.cursor="crosshair",b){case CMLayerItems.PART_UPPER_LEFT:c.style.cursor=
"nw-resize";break;case CMLayerItems.PART_UPPER_RIGHT:c.style.cursor="ne-resize";break;case CMLayerItems.PART_LOWER_RIGHT:c.style.cursor="se-resize";break;case CMLayerItems.PART_LOWER_LEFT:c.style.cursor="sw-resize";break;case CMLayerItems.PART_TOP:case CMLayerItems.PART_BOTTOM:c.style.cursor="s-resize";break;case CMLayerItems.PART_RIGHT:case CMLayerItems.PART_LEFT:c.style.cursor="e-resize";break;case CMLayerItems.PART_INSIDE:c.style.cursor="move"}return d};
CMItemRect.prototype.MouseUp=function(a,b,c,d){a=!1;this.Dragging&&(this.Dragging=!1,a=!0);return a};
CMItemRect.prototype.Paint=function(a){var b=this.GetParent(CMScene).GetTimeRange(),c=this.GetStyle(a,b);void 0!=c&&a.SetStyle(c,!0);var d=this.GetControlBounds();switch(this.Type){case CMItemRect.RECTANGLE:a.PaintRefRect(d.XMin,d.XMax,d.YMin,d.YMax);break;case CMItemRect.OVAL:a.PaintRefArc(d.XMin,d.XMax,d.YMin,d.YMax,0,2*Math.PI);break;case CMItemRect.ROUNDED_RECTANGLE:var e=this.GetBoundingTimeSlices(b)[0].Settings.RoundedRectangle;a.PaintRefRoundedRect(d.XMin,d.XMax,d.YMin,d.YMax,e.RoundedCornerWidth,
e.RoundedCornerHeight)}void 0!=c&&a.RestoreStyle();e=this.GetSetting("Text","Text");if(CMUtilities.IsDefined(e)){c=this.GetStyle(a,b,"Text");void 0!=c&&a.SetStyle(c,!0);var f=30;b=this.GetSetting("Text","font",void 0,b);CMUtilities.IsDefined(b)&&(f=CMUtilities.GetFontSizeFromFont(b));a.GetRefHeightFromPixelHeight(f);b=(d.YMin+d.YMax)/2;d=(d.XMin+d.XMax)/2;a.TheContext.font=f+"px arial";a.TheContext.textBaseline="middle";a.PaintRefText(e,d,b,f,"center",0);void 0!=c&&a.RestoreStyle()}};
CMItemRect.prototype.PaintSelected=function(a){if(this.GetSelected()){a.SaveStyle();a.SetStyle({fillStyle:"rgba(0,0,0,1)",strokeStyle:"white"});var b=this.GetControlBounds();a.PaintRefCircle(b.XMin,b.YMin,5);a.PaintRefCircle(b.XMin,b.YMax,5);a.PaintRefCircle(b.XMax,b.YMin,5);a.PaintRefCircle(b.XMax,b.YMax,5);a.RestoreStyle()}};CMItemRect.prototype.StartCreating=function(a,b){this.Anchor={X:0,Y:0};this.SelectedPart=CMItemRect.PART_LOWER_RIGHT;this.Dragging=!0};CMLayer.MARK_CIRCLE=0;CMLayer.MARK_TRIANGLE=1;CMLayer.MARK_SQUARE=2;CMLayer.MARK_STAR=3;CMLayer.LabelDirections="TL T TR R BR B BL L".split(" ");
CMLayer.SettingDefintions={Layer:{InfoText:{Name:"Info Text",Type:CMBase.DATA_TYPE_STRING,Default:"Undefined"},Metadata:{Name:"Metadata",Type:CMBase.DATA_TYPE_STRING,Default:"Undefined"},MinZoom:{Name:"Min Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:0},MaxZoom:{Name:"Max Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:0},ZoomToBoundsOnLoad:{Name:"Zoom To Bounds On Load",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!1}},Mark:{Type:{Name:"Type",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMLayer.MARK_CIRCLE,CMLayer.MARK_TRIANGLE,
CMLayer.MARK_SQUARE,CMLayer.MARK_STAR],Default:CMLayer.MARK_CIRCLE},Size:{Name:"Size",Type:CMBase.DATA_TYPE_FLOAT,Default:3}},IconImage:{URL:{Name:"URL",Type:CMBase.DATA_TYPE_URL,Default:""},TheImage:{Name:"Image",Type:CMBase.DATA_TYPE_IMAGE,Default:null},OffsetX:{Name:"Offset X",Type:CMBase.DATA_TYPE_FLOAT,Default:0},OffsetY:{Name:"Offset Y",Type:CMBase.DATA_TYPE_FLOAT,Default:0}},LabelBox:{Position:{Name:"Position",Type:CMBase.DATA_TYPE_ENUMERATED,Options:"TL T TR R BR B BL L".split(" "),Default:"UR"},
OffsetX:{Name:"Offset X",Type:CMBase.DATA_TYPE_FLOAT,Default:0},OffsetY:{Name:"Offset Y",Type:CMBase.DATA_TYPE_FLOAT,Default:0},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},MouseOverStyle:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,
Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",
Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},SelectedStyle:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},
fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y Offset",Type:CMBase.DATA_TYPE_FLOAT,Default:1}}};
function CMLayer(){CMItem.call(this);this.FeatureBounds=this.TheBounds=null;this.InfoWindowWidth=300;this.TimeSlices[0].Settings.Layer={};this.TimeSlices[0].Settings.Dataset={};this.TimeSlices[0].Settings.Mark={};this.TimeSlices[0].Settings.IconImage={};this.TimeSlices[0].Settings.LabelBox={};this.TimeSlices[0].Settings.MouseOverStyle={};this.TimeSlices[0].Settings.SelectedStyle={strokeStyle:"rgb(120,100,255)",lineWidth:"3",fillStyle:"rgba(0,0,0,0)"};this.SettingsAttributes=this.FeatureSettings=null}
CMLayer.prototype=Object.create(CMItem.prototype);CMLayer.prototype.contructor=CMLayer;CMLayer.prototype.CMItem_GetSettingsDefinitions=CMItem.prototype.GetSettingsDefinitions;CMLayer.prototype.GetSettingsDefinitions=function(){var a=this.CMItem_GetSettingsDefinitions();for(Key in CMLayer.SettingDefintions)a[Key]=CMLayer.SettingDefintions[Key];return a};CMLayer.prototype.GetSelectable=function(){return this.GetSetting("Item","Selectable",!0)};
CMLayer.prototype.IsVisible=function(){var a=this.GetVisible();if(a){var b=this.GetSetting("Layer","MinZoom"),c=this.GetSetting("Layer","MaxZoom");CMUtilities.IsDefined(b)&&(a=this.InZoomRange([b,c]))}return a};CMLayer.prototype.InZoomRange=function(a){var b=!0,c=this.GetScene();null!=a&&null!=c&&null!=c.GetView(0)&&(c=c.GetView(0).GetZoomLevel(),c<a[0]||c>a[1])&&(b=!1);return b};
CMLayer.prototype.IsFeatureVisible=function(a){var b=this.IsVisible();if(b){var c=this.GetFeatureSetting("Layer","MinZoom",a);a=this.GetFeatureSetting("Layer","MaxZoom",a);null!=c&&(b=this.InZoomRange([c,a]))}return b};CMLayer.prototype.SetBounds=function(a){this.TheBounds=a};CMLayer.prototype.GetBounds=function(){return this.TheBounds};CMLayer.prototype.GetScene=function(){return this.GetParent(CMScene)};CMLayer.prototype.SetInfoWindowWidth=function(a){this.InfoWindowWidth=a};
CMLayer.prototype.GetInfoWindowWidth=function(){return this.InfoWindowWidth};CMLayer.prototype.SetSelectedFeature=function(a){};CMLayer.prototype.SetMouseOverFeature=function(a){};CMLayer.prototype.ResetMouseOverFeature=function(){};CMLayer.prototype.SetSettingAttribute=function(a,b,c){null==this.SettingsAttributes&&(this.SettingsAttributes={});0==a in this.SettingsAttributes&&(this.SettingsAttributes[a]={});this.SettingsAttributes[a][b]=c};
CMLayer.prototype.GetSettingsAttribute=function(a,b){var c=null;null!==this.SettingsAttributes&&a in this.SettingsAttributes&&(c=this.SettingsAttributes[a][b]);return c};CMLayer.prototype.SetFeatureSettings=function(a,b){null==this.FeatureSettings&&(this.FeatureSettings=[]);this.FeatureSettings[a]=b;this.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED,null)};
CMLayer.prototype.SetFeatureSettingGroup=function(a,b,c){null==this.FeatureSettings&&(this.FeatureSettings=[]);void 0==this.FeatureSettings[b]&&(this.FeatureSettings[b]={});void 0==this.FeatureSettings[b][a]&&(this.FeatureSettings[b][a]={});this.FeatureSettings[b][a]=c;this.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED,null)};
CMLayer.prototype.GetFeatureSettingGroup=function(a,b,c){null!=this.FeatureSettings&&void 0!=this.FeatureSettings[b]&&void 0!=this.FeatureSettings[b][a]&&(c=this.FeatureSettings[b][a]);return c};
CMLayer.prototype.SetFeatureSetting=function(a,b,c,d){null==this.FeatureSettings&&(this.FeatureSettings=[]);void 0==this.FeatureSettings[c]&&(this.FeatureSettings[c]={});0==a in this.FeatureSettings[c]&&(this.FeatureSettings[c][a]={});this.FeatureSettings[c][a][b]=d;this.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED,null)};
CMLayer.prototype.GetFeatureSetting=function(a,b,c,d){d=this.GetSetting(a,b,d);null!==this.FeatureSettings&&(c=this.FeatureSettings[c],void 0!=c&&a in c&&(a=c[a],b in a&&(d=a[b])));return d};CMLayer.prototype.RequestData=function(){var a=this.GetSetting("Dataset","URL",null);this.SetURL(a)};CMLayer.prototype.SetURL=function(a){CMMainContainer("Sorry, this function must be overriden")};
CMLayer.prototype.SetIconImage=function(a,b,c){var d=new Image;d.Loaded=!1;d.TheURL=a;d.TheLayer=this;d.OffsetX=b;d.OffsetY=c;d.onload=function(){this.Loaded=!0;this.TheLayer.SetSetting("IconImage","URL",this.TheURL);this.TheLayer.SetSetting("IconImage","TheImage",this);this.TheLayer.SetSetting("IconImage","OffsetX",this.OffsetX);this.TheLayer.SetSetting("IconImage","OffsetY",this.OffsetY);this.TheLayer.Repaint()};d.src=a};
CMLayer.prototype.SetFeatureIconImage=function(a,b,c,d){var e=new Image;e.FeatureIndex=a;e.Loaded=!1;e.TheLayer=this;e.OffsetX=c;e.OffsetY=d;e.onload=function(){this.Loaded=!0;this.TheLayer.SetFeatureSetting("IconImage","URL",this.FeatureIndex,this.TheURL);this.TheLayer.SetFeatureSetting("IconImage","TheImage",this.FeatureIndex,this);this.TheLayer.SetFeatureSetting("IconImage","OffsetX",this.FeatureIndex,this.OffsetX);this.TheLayer.SetFeatureSetting("IconImage","OffsetY",this.FeatureIndex,this.OffsetY);
this.TheLayer.Repaint()};e.src=b};CMLayer.prototype.SetupLabelFont=function(a,b){b=this.GetFeatureSetting("Text","font",b,"Arial 12px");var c=20;if(null!=b&&void 0!=b){var d=b.indexOf("px");-1!=d&&(c=b.substring(0,d),d=c.lastIndexOf(" "),-1!=d&&(c=c.substring(d+1)),c=parseInt(c))}a.GetContext().font=b;return c};
CMLayer.prototype.PaintPoint=function(a,b,c,d,e,f){if(this.IsFeatureVisible(b)){var g=a.GetPixelFromRef(c,d),h=g.PixelX;g=g.PixelY;var k=this.GetSettingGroup("IconImage");k=this.GetFeatureSettingGroup("IconImage",b,k);if(void 0!==k.TheImage)e={XMin:h+k.OffsetX,XMax:h+k.OffsetX+k.TheImage.width,YMin:g+k.OffsetY,YMax:g+k.OffsetY+k.TheImage.height},0==a.CheckCollision(e)&&(a.AddToCollisions(e),a.PaintImage(k.TheImage,h+k.OffsetX,g+k.OffsetY));else{e?f=this.GetStyle(a,0,"SelectedStyle"):f?f=this.GetStyle(a,
0,"MouseOverStyle"):(f=this.GetStyle(a),f=this.GetFeatureSettingGroup("Style",b,f));null!==f&&a.SetStyle(f,!0);k=this.GetFeatureSetting("Mark","Size",b,5);var l=this.GetFeatureSetting("Mark","Type",b,CMLayer.MARK_CIRCLE),m=k/2;e={XMin:h-m,XMax:h+m,YMin:g-m,YMax:g+m};if(0==a.CheckCollision(e))switch(a.AddToCollisions(e),l){case CMLayer.MARK_CIRCLE:a.PaintCircle(h,g,m);break;case CMLayer.MARK_SQUARE:a.PaintRect(h-m,h+m,g-m,g+m);break;case CMLayer.MARK_TRIANGLE:e=a.GetRefWidthFromPixelWidth(k);e=CMUtilities.GetRegularPolygon(3,
e/2,c,d,180);a.PaintRefPoly(e[0],e[1],!0);break;case CMLayer.MARK_STAR:e=a.GetRefWidthFromPixelWidth(k),e=CMUtilities.GetStar(5,e,c,d,0),a.PaintRefPoly(e[0],e[1],!0)}void 0!=f&&a.RestoreStyle()}e=this.GetFeatureSetting("Text","Text",b,null);if(null!=e){e=""+e;c=this.GetStyle(a,0,"Text");void 0!=c&&a.SetStyle(c);d=this.SetupLabelFont(a,b);f=a.GetContext();var n=10,p=10;k=this.GetFeatureSetting("LabelBox","Position",b,"T");n=this.GetFeatureSetting("LabelBox","OffsetX",b,n);p=this.GetFeatureSetting("LabelBox",
"OffsetY",b,p);b=e.split("<br>");e=b.length*d;l=[];for(var q=m=0;q<b.length;q++)b[q]=b[q].trim(),l.push(f.measureText(b[q]).width),l[q]>m&&(m=l[q]);switch(k){case "TL":case "L":case "BL":h=h-n-m;break;default:h-=m/2;break;case "BR":case "TR":case "R":h+=p}switch(k){case "TL":case "T":case "TR":p=g-p-e;break;default:p=g-e/2;break;case "BR":case "B":case "BL":p=g+p}g=h;p+=d;e={XMin:g,XMax:g+m,YMin:p-e,YMax:p};if(0==a.CheckCollision(e))for(a.AddToCollisions(e),f.textBaseline="bottom",q=0;q<b.length;q++){switch(k){case "TL":case "L":case "BL":g=
h+m-l[q];break;default:g=h+(m-l[q])/2;break;case "BR":case "TR":case "R":g=h}f.fillText(b[q],g,p);f.strokeText(b[q],g,p);p+=d}void 0!=c&&a.RestoreStyle()}}};
CMLayer.prototype.PaintRefArea=function(a,b,c,d,e,f){this.IsFeatureVisible(b)&&(b=e?this.GetStyle(a,0,"SelectedStyle"):f?this.GetStyle(a,0,"MouseOverStyle"):this.GetFeatureSettingGroup("Style",b,null),null!==b&&a.SetStyle(b,!0),e=this.GetParent(CMGeo),e.GetProjectorType()==CMGeo.PROJECTOR_DYNAMIC?(e=e.GetProjector(),d==CMDatasetVector.TYPE_POLYGONS?(c=e.ProjectAreaFromGeographic(c,d),a.PaintRefArea(c,!0)):(c=e.ProjectAreaFromGeographic(c,d),a.PaintRefArea(c,!1,!1,!0))):d==CMDatasetVector.TYPE_POLYGONS?
a.PaintRefArea(c,!0):a.PaintRefArea(c,!1),null!==b&&a.RestoreStyle(b))};CMLayer.prototype.OnLoad=function(){null==this.GetScene()?alert("Sorry, you'll need to add the layer to the CanvasMap before you can load data."):(this.GetScene().SetBoundsDirty(),1==this.GetSetting("Layer","ZoomToBoundsOnLoad")&&this.GetParent(CMMainContainer).ZoomToBounds(this.GetBounds()),this.GetScene().Repaint())};CMLayer.prototype.In=function(a,b,c){return-1};
CMLayer.prototype.MouseDown=function(a,b,c){var d=!1;if(this.IsVisible()&&this.GetSelectable()&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)){var e=this.In(a,b,c);-1!=e&&(this.SetSelectedFeature(e),this.ShowInfoWindow(e,a,b,c),d=!0)}return d};CMLayer.prototype.MouseMove=function(a,b,c){if(this.GetSelectable()){var d=this.GetSettingGroup("MouseOverStyle");void 0!=d&&0<Object.keys(d).length&&(d=this.In(a,b,c),-1!==d?this.MouseOver(a,b,c,d):this.ResetMouseOverFeature())}return!1};
CMLayer.prototype.MouseUp=function(a,b,c){return!1};CMLayer.prototype.MouseOver=function(a,b,c,d){this.SetMouseOverFeature(d);return!1};CMLayer.prototype.Resize=function(a){};CMLayer.prototype.ProjectBounds=function(a){var b=this.GetParent(CMGeo);if(b.GetProjectorType()==CMGeo.PROJECTOR_DYNAMIC){b=b.GeProjector();var c=b.ProjectToGeographic(a.XMin,a.YMin);a.XMin=c[0];a.YMin=c[1];c=b.ProjectToGeographic(a.XMax,a.YMax);a.XMax=c[0];a.YMax=c[1]}return a};
CMLayer.prototype.ProjectCoordinate=function(a,b,c){var d=[a,b,c],e=this.GetParent(CMGeo);e.GetProjectorType()==CMGeo.PROJECTOR_DYNAMIC&&(d=e.GetProjector().ProjectToGeographic(a,b,c));return d};CMLayer.prototype.ProjectorChanged=function(){this.Repaint()};CMLayer.prototype.GetSearchResults=function(a,b){};CMLayer.prototype.ShowInfoWindow=function(a,b,c,d){a=this.GetFeatureSetting("Layer","InfoText",a,null);null!=a&&(b=b.CreateInfoWindow("CMLayer.InfoWindow",c,d,this.GetInfoWindowWidth(),30,a),CMMainContainer.SetPopupWindow(b))};
CMLayer.prototype.GetMarkIcon=function(a,b,c){TheIcon=document.createElement("CANVAS");TheIcon.className="CM_LayerListIconClass";TheIcon.TheLayer=this;TheIcon.style.borderColor="rgba(0,0,0,0)";TheIcon.width=16;TheIcon.height=16;var d=new CMView2D;d.Setup(TheIcon);d.SetStyle({fillStyle:b,strokeStyle:c});switch(a){case CMLayer.MARK_CIRCLE:d.PaintCircle(8,8,7);break;case CMLayer.MARK_SQUARE:d.PaintRect(1,14,1,14);break;case CMLayer.MARK_TRIANGLE:a=CMUtilities.GetRegularPolygon(3,9,8,-9,180);d.PaintRefPoly(a[0],
a[1],!0);break;case CMLayer.MARK_STAR:a=CMUtilities.GetStar(5,14,8,-8,36),d.PaintRefPoly(a[0],a[1],!0)}return TheIcon};
CMLayer.prototype.GetIcon=function(){var a=this.GetSetting("IconImage","TheImage");if(null==a){a=this.GetSetting("Mark","Type",void 0);var b=this.GetSetting("Style","fillStyle"),c=this.GetSetting("Style","strokeStyle");0==CMUtilities.IsDefined(a)?(a=document.createElement("div"),a.className="CM_LayerListIconClass",a.TheLayer=this,CMUtilities.IsDefined(b)?a.style.backgroundColor=b:a.style.backgroundColor=void 0,CMUtilities.IsDefined(c)?a.style.borderColor=c:a.style.borderColor=void 0):a=this.GetMarkIcon(a,
b,c)}return a};
CMLayer.prototype.FillPopupMenu=function(a){var b=document.createElement("div");b.setAttribute("id","CM_DeleteElementMenuItem");b.className="CM_LayerListPopupMenuItem";b.innerHTML="Delete";b.TheLayer=this;b.ThePopupMenu=a;b.addEventListener("click",function(a){var b=this.TheLayer.GetParent(CMScene);this.ThePopupMenu.style.visibility="hidden";var c=b.GetLayerIndex(this.TheLayer);b.DeleteLayer(c);a.stopPropagation()});a.appendChild(b);null!=this.GetBounds()&&(b=document.createElement("div"),b.className=
"CM_LayerListPopupMenuItem",b.setAttribute("id","CM_ZoomToExtentMenuItem"),b.innerHTML="Zoom To This Layer",b.TheLayer=this,b.ThePopupMenu=a,b.addEventListener("click",function(a){this.ThePopupMenu.style.visibility="hidden";var b=this.TheLayer.GetBounds();this.TheLayer.GetParent(CMScene).GetView(0).ZoomToBounds(b);a.stopPropagation()}),a.appendChild(b));void 0!=this.GetSetting("Layer","Metadata",void 0)&&(b=document.createElement("div"),b.className="CM_LayerListPopupMenuItem",b.setAttribute("id",
"CM_ZoomToExtentMenuItem"),b.innerHTML="Metadata",b.TheLayer=this,b.ThePopupMenu=a,b.addEventListener("click",function(a){this.ThePopupMenu.style.visibility="hidden";var b=(new CMDialog("CMMetadataDialog",400,200,!1,"Metadata")).GetBodyElement(),c=document.createElement("div");c.style.margin="10px";c.innerHTML=this.TheLayer.GetSetting("Layer","Metadata",void 0);b.appendChild(c);a.stopPropagation()}),a.appendChild(b))};CMLayerDataset.SettingDefintions={Dataset:{URL:{Name:"URL",Type:CMBase.DATA_TYPE_STRING,Default:null},Format:{Name:"Format",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMDataset.GEOJSON,CMDataset.PYRAMID,CMDataset.PYRAMID_OPEN_FORMAT,CMDataset.RASTER,CMDataset.SQL],Default:CMDataset.GEOJSON}}};function CMLayerDataset(){CMLayer.call(this);this.TheDataset=null;this.TimeSlices[0].Settings.Dataset={}}CMLayerDataset.prototype=Object.create(CMLayer.prototype);CMLayerDataset.prototype.contructor=CMLayerDataset;
CMLayerDataset.prototype.CMLayer_SetParent=CMLayer.prototype.SetParent;CMLayerDataset.prototype.SetParent=function(a){this.CMLayer_SetParent(a);null!=this.TheDataset&&this.TheDataset.SetParent(this.GetParent(CMScene))};CMLayerDataset.prototype.CMLayer_UnselectAll=CMLayer.prototype.UnselectAll;CMLayerDataset.prototype.UnselectAll=function(a){this.CMLayer_UnselectAll(a);null!=this.TheDataset&&-1!=this.TheDataset.GetSelectedFeature()&&this.TheDataset.UnselectAll(a)};
CMLayerDataset.prototype.CMLayer_SetVisible=CMLayer.prototype.SetVisible;CMLayerDataset.prototype.SetVisible=function(a){this.CMLayer_SetVisible(a);null!=this.TheDataset&&this.TheDataset.SetVisible(this,a)};CMLayerDataset.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheDataset){var b=this.GetStyle(a);null!==b&&a.SetStyle(b);this.TheDataset.Paint(this,a,!1);null!==b&&a.RestoreStyle()}};
CMLayerDataset.prototype.PaintSelected=function(a){if(this.IsVisible()&&null!=this.TheDataset){var b=this.GetStyle(a,void 0,"MouseOverStyle");CMUtilities.IsDefined(b)&&(a.SetStyle(b),this.TheDataset.Paint(this,a,!1,!0),a.RestoreStyle());b=this.GetStyle(a,void 0,"SelectedStyle");CMUtilities.IsDefined(b)&&(a.SetStyle(b),this.TheDataset.Paint(this,a,!0),a.RestoreStyle())}};CMLayerDataset.prototype.CMLayer_GetSettingsDefinitions=CMLayer.prototype.GetSettingsDefinitions;
CMLayerDataset.prototype.GetSettingsDefinitions=function(){var a=this.CMLayer_GetSettingsDefinitions();for(Key in CMLayerDataset.SettingDefintions)a[Key]=CMLayerDataset.SettingDefintions[Key];return a};CMLayerDataset.prototype.SetBounds=function(a){void 0!=this.GetDataset()&&(this.GetDataset().SetBounds(a),this.GetParent(CMScene).SetBoundsDirty())};CMLayerDataset.prototype.GetBounds=function(){var a=void 0;void 0!=this.GetDataset()&&(a=this.GetDataset().GetBounds(),a=this.ProjectBounds(a));return a};
CMLayerDataset.prototype.SetProjector=function(a){this.TheProjector=a;null!=this.TheDataset&&this.TheDataset.SetProjector(a)};CMLayerDataset.prototype.SetSelectedFeature=function(a){null!=this.TheDataset&&a!=this.TheDataset.GetSelectedFeature()&&(this.TheDataset.SetSelectedFeature(a),this.GetParent(CMScene).SelectionChanged(this))};CMLayerDataset.prototype.SetMouseOverFeature=function(a){null!=this.TheDataset&&this.TheDataset.GetMouseOverFeature()!=a&&this.TheDataset.SetMouseOverFeature(a)};
CMLayerDataset.prototype.ResetMouseOverFeature=function(){null!=this.TheDataset&&-1!=this.TheDataset.GetMouseOverFeature()&&this.TheDataset.SetMouseOverFeature(-1)};
CMLayerDataset.prototype.In=function(a,b,c){var d=-1;if(null!=this.TheDataset){var e=this.ProjectCoordinate(b,c);if(null!=e){b=e[0];c=e[1];for(var f=this.GetRefTolerance(a),g=this.TheDataset.GetNumFeatures(),h=0;h<g&&-1==d;h++)this.GetFeatureSetting("Item","Visible",h,!0)&&(e=this.TheDataset.InFeature(a,b,c,h,f))&&(d=h);d=this.TheDataset.In(a,b,c,f)}}return d};CMLayerDataset.prototype.GetSearchResults=function(a,b){null!=this.TheDataset&&this.TheDataset.GetSearchResults(a,b)};
CMLayerDataset.prototype.CMLayer_GetIcon=CMLayer.prototype.GetIcon;CMLayerDataset.prototype.GetIcon=function(){var a=this.CMLayer_GetIcon();null!=this.TheDataset&&(a=this.TheDataset.GetIcon(this,a));return a};CMLayerDataset.prototype.RequestData=function(){var a=this.GetSetting("Dataset","URL",null),b=this.GetSetting("Dataset","Format",CMDataset.GEOJSON);this.SetURL(a,b)};
CMLayerDataset.prototype.SetURL=function(a,b){this.GetParent(CMScene);null==this.TheDataset&&(b=CMDataset.GetDataObject(a,b),this.SetDataset(b));this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_TILE_LOADED,this,function(a,b,e){b.GetScene().Repaint()});this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_LOADED,this,function(a,b,e){b.OnLoad();b.GetScene().LayerListChanged();if(null!=b.SettingsAttributes)for(var c in b.SettingsAttributes){e=b.SettingsAttributes[c];for(var d in e){var h=e[d],k=
a.GetAttributeIndexFromHeading(h);-1==k?CMMainContainer.Error("Sorry, the attribute "+h+" was not found"):a.LoadAttributeColumn(k)}}});this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_SELECTION_CHANGED,this,function(a,b,e){b.GetScene().SelectionChanged(a)});this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_MOUSE_OVER_FEATURE_CHANGED,this,function(a,b,e){b.GetScene().Repaint()});this.TheDataset.AddListener(CMDataset.MESSAGE_ATTRIBUTES_CHANGED,this,function(a,b,e){if(null!=b.SettingsAttributes){for(var c in b.SettingsAttributes){e=
b.SettingsAttributes[c];for(var d in e){var h=e[d],k=a.GetAttributeIndexFromHeading(h);if(-1==k)b.GetParent(CMMainContainer),CMMainContainer.Error("Sorry, the attribute "+h+" in "+b.GetName()+" is not available");else{h=a.GetNumAttributeRows();for(var l=0;l<h;l++){a.GetNumAttributeRows();var m=a.GetAttributeCell(k,l);if(void 0!==m&&""!==m){if("IconImage"==c&&"URL"==d){var n=new Image;n.Loaded=!1;n.TheLayer=this;n.onload=function(){This.Loaded=!0;This.TheLayer.Repaint()};n.src=m}else"Mark"==c&&"Type"==
d?("MARK_CIRCLE"===m&&(m=CMLayer.MARK_CIRCLE),"MARK_TRIANGLE"===m&&(m=CMLayer.MARK_TRIANGLE),"MARK_SQUARE"===m&&(m=CMLayer.MARK_SQUARE),"MARK_STAR"===m&&(m=CMLayer.MARK_STAR)):"Mark"==c&&"Size"==d&&(m=parseInt(m));b.SetFeatureSetting(c,d,l,m);void 0!=b.CallbackFunction&&b.CallbackFunction(b.CallbackParameters)}}}}}b.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED,null)}});this.TheDataset.SetURL(a)};
CMLayerDataset.prototype.SetData=function(a,b){var c=this.GetParent(CMScene);this.TheDataset=CMDataset.GetDataObject(null,b);this.TheDataset.SetParent(c);this.GetDataset();this.TheDataset.SetData(a)};CMLayerDataset.prototype.GetDataset=function(){if(null==this.TheDataset){var a=this.GetSetting("Dataset","Format",null);null!=a&&(a=CMDataset.GetDataObject(null,a),this.SetDataset(a));null!=this.TheDataset&&this.TheDataset.AddListener(CMDataset.MESSAGE_DATASET_LOADED,this,function(a,c,d){c.OnLoad()})}return this.TheDataset};
CMLayerDataset.prototype.SetDataset=function(a){this.TheDataset=a;null!=this.TheDataset&&this.TheDataset.SetParent(this.GetParent(CMScene));void 0!=this.TheProjector&&this.TheDataset.SetProjector(this.TheProjector)};CMLayerGraticule.MAX_SPACING_DEGREES=15;
CMLayerGraticule.SettingDefintions={Graticule:{East:{Name:"East",Type:CMBase.DATA_TYPE_FLOAT,Default:-180},West:{Name:"West",Type:CMBase.DATA_TYPE_FLOAT,Default:180},North:{Name:"North",Type:CMBase.DATA_TYPE_FLOAT,Default:90},South:{Name:"South",Type:CMBase.DATA_TYPE_FLOAT,Default:-90},Spacing:{Name:"Spacing",Type:CMBase.DATA_TYPE_FLOAT,Default:200},DegreeSpacing:{Name:"Degree Spacing",Type:CMBase.DATA_TYPE_FLOAT,Default:-1}},Border:{strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,
Default:"rgb(0,0,0)"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:3},BorderWidth:{Name:"Border Width",Type:CMBase.DATA_TYPE_FLOAT,Default:12}},BorderText:{font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"14px Arial"},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},fillStyle:{Name:"Fill Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"}}};
function CMLayerGraticule(){CMLayer.call(this);this.TimeSlices[0].Settings.Graticule={};this.TimeSlices[0].Settings.Border={};this.TimeSlices[0].Settings.BorderText={};this.Lines3D=this.RightIntersectionCoordinates=this.LeftIntersectionCoordinates=this.BottomIntersectionCoordinates=this.TopIntersectionCoordinates=this.ClippingBoxProjectedSouthCoordinates=this.ClippingBoxProjectedNorthCoordinates=this.ClippingBoxProjectedEastCoordinates=this.ClippingBoxProjectedWestCoordinates=this.ClippingBoxProjectedNorthings=
this.ClippingBoxProjectedEastings=this.Bounds=null}CMLayerGraticule.prototype=Object.create(CMLayer.prototype);CMLayerGraticule.prototype.contructor=CMLayerGraticule;CMLayerGraticule.DegreeQuantized=[30,15,10,5,2,1,.5,.25,1/6,1/12,1/30,1/60,1/120,1/240,1/360,1/720,1/1800,1/3600];
CMLayerGraticule.SegmentIntersectsAVertical=function(a,b,c,d,e,f,g,h,k){a<e&&c<e||a>e&&c>e||b<g&&d<g||b>f&&d>f||(c==a?a==e&&h.push({Easting:e,Northing:b}):a==c?h.push({Easting:e,Northing:b,Longitude:Longitude}):(c=(d-b)/(c-a),a=c*e+(b-c*a),a<f&&a>g&&h.push({Easting:e,Northing:a,Latitude:k})));return null};
CMLayerGraticule.SegmentIntersectsAHorizontal=function(a,b,c,d,e,f,g,h,k){a<e&&c<e||a>f&&c>f||b<g&&d<g||b>g&&d>g||(d==b?b==g&&h.push({Easting:a,Northing:g,Longitude:k}):a==c?h.push({Easting:a,Northing:g,Longitude:k}):(c=(d-b)/(c-a),a=(g-(b-c*a))/c,a>=e&&a<=f&&h.push({Easting:a,Northing:g,Longitude:k})));return null};
CMLayerGraticule.GetPolyIntersectionsWithVertical=function(a,b,c,d,e,f){for(var g=a.length-1,h=0;h<g;h++)CMLayerGraticule.SegmentIntersectsAVertical(a[h],b[h],a[h+1],b[h+1],c,d,e,f);return CMLayerGraticule.SegmentIntersectsAVertical(a[g],b[g],a[0],b[0],c,d,e,f)};
CMLayerGraticule.GetPolyIntersectionsWithHorizontal=function(a,b,c,d,e,f){for(var g=a.length-1,h=0;h<g;h++)CMLayerGraticule.SegmentIntersectsAHorizontal(a[h],b[h],a[h+1],b[h+1],c,d,e,f);return CMLayerGraticule.SegmentIntersectsAHorizontal(a[g],b[g],a[0],b[0],c,d,e,f)};
CMLayerGraticule.prototype.AddEastWestCoordinate=function(a,b,c,d){c=a.ProjectFromGeographic(c,b);a=a.ProjectFromGeographic(d,b);null!=c&&this.ClippingBoxProjectedWestCoordinates.push({Easting:c[0],Northing:c[1]});null!=a&&this.ClippingBoxProjectedEastCoordinates.push({Easting:a[0],Northing:a[1]})};
CMLayerGraticule.prototype.AddNorthSouthCoordinate=function(a,b,c,d){c=a.ProjectFromGeographic(b,c);a=a.ProjectFromGeographic(b,d);null!=c&&this.ClippingBoxProjectedNorthCoordinates.push({Easting:c[0],Northing:c[1]});null!=a&&this.ClippingBoxProjectedSouthCoordinates.push({Easting:a[0],Northing:a[1]})};
CMLayerGraticule.prototype.SetupBoundsPoly=function(a){var b=CMLayerGraticule.MAX_SPACING_DEGREES,c=this.GetParent(CMGeo).GetProjector();this.ClippingBoxProjectedEastings=[];this.ClippingBoxProjectedNorthings=[];this.ClippingBoxProjectedWestCoordinates=[];this.ClippingBoxProjectedEastCoordinates=[];this.ClippingBoxProjectedNorthCoordinates=[];this.ClippingBoxProjectedSouthCoordinates=[];var d=CMUtilities.GetMinMax(a.Xs);a=CMUtilities.GetMinMax(a.Ys);var e=a.Min,f=a.Max-a.Min,g=f/10;for(f=0;10>=f;f++)this.AddEastWestCoordinate(c,
e,d.Min,d.Max),e+=g;f=e%b;0!=f&&(this.AddEastWestCoordinate(c,e,d.Min,d.Max),e-=f);for(;e<=a.Max;)this.AddEastWestCoordinate(c,e,d.Min,d.Max),e+=b;e=a.Max%b;0!=e&&(e=a.Max,this.AddEastWestCoordinate(c,e,d.Min,d.Max));e=d.Min;f=d.Max-d.Min;g=f/10;for(f=0;10>=f;f++)this.AddNorthSouthCoordinate(c,e,a.Max,a.Min),e+=g;f=e%b;0!=f&&(this.AddNorthSouthCoordinate(c,e,a.Max,a.Min),e-=f);for(;e<=d.Max;)this.AddNorthSouthCoordinate(c,e,a.Max,a.Min),e+=b;e=d.Max%b;0!=e&&(e=d.Max,this.AddNorthSouthCoordinate(c,
e,a.Max,a.Min));for(f=0;f<this.ClippingBoxProjectedWestCoordinates.length;f++)this.ClippingBoxProjectedEastings.push(this.ClippingBoxProjectedWestCoordinates[f].Easting),this.ClippingBoxProjectedNorthings.push(this.ClippingBoxProjectedWestCoordinates[f].Northing);for(f=0;f<this.ClippingBoxProjectedNorthCoordinates.length;f++)this.ClippingBoxProjectedEastings.push(this.ClippingBoxProjectedNorthCoordinates[f].Easting),this.ClippingBoxProjectedNorthings.push(this.ClippingBoxProjectedNorthCoordinates[f].Northing);
for(f=0;f<this.ClippingBoxProjectedEastCoordinates.length;f++)b=this.ClippingBoxProjectedEastCoordinates.length-1-f,this.ClippingBoxProjectedEastings.push(this.ClippingBoxProjectedEastCoordinates[b].Easting),this.ClippingBoxProjectedNorthings.push(this.ClippingBoxProjectedEastCoordinates[b].Northing);for(f=0;f<this.ClippingBoxProjectedSouthCoordinates.length;f++)b=this.ClippingBoxProjectedSouthCoordinates.length-1-f,this.ClippingBoxProjectedEastings.push(this.ClippingBoxProjectedSouthCoordinates[b].Easting),
this.ClippingBoxProjectedNorthings.push(this.ClippingBoxProjectedSouthCoordinates[b].Northing)};CMLayerGraticule.prototype.PaintMeridianSegment=function(a,b,c,d,e,f,g,h,k,l){a.PaintRefLine(b,c,d,e);CMLayerGraticule.SegmentIntersectsAHorizontal(b,c,d,e,f,g,h,this.TopIntersectionCoordinates,l);CMLayerGraticule.SegmentIntersectsAHorizontal(b,c,d,e,f,g,k,this.BottomIntersectionCoordinates,l)};
CMLayerGraticule.prototype.PaintParallelSegment=function(a,b,c,d,e,f,g,h,k,l){a.PaintRefLine(b,c,d,e);CMLayerGraticule.SegmentIntersectsAVertical(b,c,d,e,f,h,k,this.LeftIntersectionCoordinates,l);CMLayerGraticule.SegmentIntersectsAVertical(b,c,d,e,g,h,k,this.RightIntersectionCoordinates,l)};CMLayerGraticule.prototype.CMLayer_SettingsChanged=CMLayer.prototype.SettingsChanged;CMLayerGraticule.prototype.SettingsChanged=function(){this.CMLayer_SettingsChanged();this.ClippingBoxProjectedEastings=null};
CMLayerGraticule.prototype.CMLayer_GetSettingsDefinitions=CMLayer.prototype.GetSettingsDefinitions;CMLayerGraticule.prototype.GetSettingsDefinitions=function(){var a=this.CMLayer_GetSettingsDefinitions();for(Key in CMLayerGraticule.SettingDefintions)a[Key]=CMLayerGraticule.SettingDefintions[Key];return a};
CMLayerGraticule.prototype.GetSpacing=function(a,b,c,d,e){var f=c+e/10;c=b.ProjectFromGeographic(c-e/10,d);d=b.ProjectFromGeographic(f,d);b=0;if(null!=c&&null!=d){e/=5;c=d[0]-c[0];0>c&&(c=-c);a=a.GetPixelWidthFromRefWidth(c);for(a=e/a*this.GetSetting("Graticule","Spacing",200);CMLayerGraticule.DegreeQuantized[b]>a&&b+1<CMLayerGraticule.DegreeQuantized.length;)b++;b+1<CMLayerGraticule.DegreeQuantized.length&&0>b&&b--}return CMLayerGraticule.DegreeQuantized[b]};
CMLayerGraticule.prototype.GetVisibleBounds=function(a,b){var c=a.GetCanvasElement();var d=a.GetRefXFromPixelX(0);var e=a.GetRefXFromPixelX(c.width),f=a.GetRefYFromPixelY(0);c=a.GetRefYFromPixelY(c.height);a=[];CMLayerGraticule.GetPolyIntersectionsWithVertical(this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,d,f,c,a);CMLayerGraticule.GetPolyIntersectionsWithVertical(this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,e,f,c,a);CMLayerGraticule.GetPolyIntersectionsWithHorizontal(this.ClippingBoxProjectedEastings,
this.ClippingBoxProjectedNorthings,d,e,f,a);CMLayerGraticule.GetPolyIntersectionsWithHorizontal(this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,d,e,c,a);CMUtilities.InsideAPolygon(d,f,this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,this.ClippingBoxProjectedEastings.length)&&a.push({Easting:d,Northing:f});CMUtilities.InsideAPolygon(e,f,this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,this.ClippingBoxProjectedEastings.length)&&a.push({Easting:e,
Northing:f});CMUtilities.InsideAPolygon(e,c,this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,this.ClippingBoxProjectedEastings.length)&&a.push({Easting:e,Northing:c});CMUtilities.InsideAPolygon(d,c,this.ClippingBoxProjectedEastings,this.ClippingBoxProjectedNorthings,this.ClippingBoxProjectedEastings.length)&&a.push({Easting:d,Northing:c});e=[];for(d=0;d<a.length;d++)f=b.ProjectToGeographic(a[d].Easting,a[d].Northing),null!=f&&e.push({Longitude:f[0],Latitude:f[1]});return e};
CMLayerGraticule.prototype.GetLatLonRangeFromClippingBounds=function(a,b,c,d){b=null;this.SetupBoundsPoly(c);var e=CMUtilities.GetMinMax(c.Xs);c=CMUtilities.GetMinMax(c.Ys);d=this.GetVisibleBounds(a,d);for(var f=0;f<d.length;f++){var g=d[f];180==e.Max&&-179>g.Longitude&&(g.Longitude=180);-180==e.Min&&179<g.Longitude&&(g.Longitude=-180)}var h=a.GetCanvasElement();f=a.GetRefXFromPixelX(0);var k=a.GetRefXFromPixelX(h.width);g=a.GetRefYFromPixelY(0);h=a.GetRefYFromPixelY(h.height);f=[f,k,k,f];var l=[g,
g,h,h];SWCoordinate=this.ClippingBoxProjectedWestCoordinates[0];NWCoordinate=this.ClippingBoxProjectedWestCoordinates[this.ClippingBoxProjectedWestCoordinates.length-1];SECoordinate=this.ClippingBoxProjectedEastCoordinates[0];NECoordinate=this.ClippingBoxProjectedEastCoordinates[this.ClippingBoxProjectedEastCoordinates.length-1];g=CMUtilities.InsideAPolygon(NWCoordinate.Easting,NWCoordinate.Northing,f,l,f.length);k=CMUtilities.InsideAPolygon(NECoordinate.Easting,NECoordinate.Northing,f,l,f.length);
h=CMUtilities.InsideAPolygon(SECoordinate.Easting,SECoordinate.Northing,f,l,f.length);l=CMUtilities.InsideAPolygon(SWCoordinate.Easting,SWCoordinate.Northing,f,l,f.length);a.SetStyle({fillStyle:"Black"});if(0<d.length){var m=d[0].Latitude;var n=d[0].Latitude;var p=d[0].Longitude;var q=d[0].Longitude;for(f=1;f<d.length;f++)d[f].Latitude<m&&(m=d[f].Latitude),d[f].Latitude>n&&(n=d[f].Latitude),d[f].Longitude<p&&(p=d[f].Longitude),d[f].Longitude>q&&(q=d[f].Longitude)}g|k&&(void 0==n||isNaN(n)||c.Max>
n)&&(n=c.Max);l|h&&(void 0==m||isNaN(m)||c.Min<m)&&(m=c.Min);g|l&&(void 0==p||isNaN(p)||e.Min<p)&&(p=e.Min);k|h&&(void 0==q||isNaN(q)||e.Max>q)&&(q=e.Max);void 0!=m&&void 0!=n&&void 0!=p&&void 0!=q&&(b={MinLon:p,MaxLon:q,MinLat:m,MaxLat:n});return b};
CMLayerGraticule.prototype.GetProjectedCoordinateGrid=function(a,b,c){a=b.MinLon;var d=b.MaxLon,e=b.MinLat,f=b.Spacing,g=[],h=0;for(b=b.MaxLat;b>=e;){g[h]=[];for(var k=0,l=a;l<=d;){var m=c.ProjectFromGeographic(l,b);null!=m&&(m={Easting:m[0],Northing:m[1]},m.Longitude=l,m.Latitude=b,g[h][k]=m);0==k?l!=d&&(m=l%f,0!=m?l=Math.ceil(l/f)*f:(l+=f,l>d&&(l=d))):l!=d?(l+=f,l>d&&(l=d)):l+=f;k++}0==h?(m=b%f,b=0!=m?Math.floor(b/f)*f:b-f):b!=e?(b-=f,b<e&&(b=e)):b-=f;h++}return g};
CMLayerGraticule.prototype.PaintCoordinateGrid=function(a,b,c,d){var e=b.MinLon,f=b.MaxLat;b=b.Spacing;var g=a.GetCanvasElement(),h=this.GetSetting("Border","BorderWidth"),k=a.GetRefXFromPixelX(h),l=a.GetRefXFromPixelX(g.width-h),m=a.GetRefYFromPixelY(h);g=a.GetRefYFromPixelY(g.height-h);h=this.GetStyle(a);void 0!=h&&a.SetStyle(h,!1);if(0!=c.length){var n=e;e=c[0].length;h=c.length;for(var p=0;p<e;p++){if(2<=c.length)for(var q=0;q<h-1;q++){var r=c[q][p],t=c[q+1][p],u=r.Latitude;r=r.Longitude;var v=
(t.Latitude-u)/10;t=d.ProjectFromGeographic(r,u);for(var w=0;10>w;w++){u+=v;var x=d.ProjectFromGeographic(r,u);this.PaintMeridianSegment(a,t[0],t[1],x[0],x[1],k,l,m,g,n);t=x}}n+=b}for(q=0;q<h;q++){if(2<=c.length)for(p=0;p<e-1;p++)for(r=c[q][p],t=c[q][p+1],u=r.Latitude,r=r.Longitude,t=t.Longitude,n=(t-r)/10,v=r,t=d.ProjectFromGeographic(r,u),w=0;10>w;w++)v+=n,x=d.ProjectFromGeographic(v,u),this.PaintParallelSegment(a,t[0],t[1],x[0],x[1],k,l,m,g,f),t=x;f-=b}}};
CMLayerGraticule.prototype.PaintGridLabels=function(a,b,c,d){var e=b.MinLon,f=b.MaxLon,g=b.MinLat;b=b.MaxLat;if(0!=c.length){var h=this.GetSettingGroup("Text");a.SetStyle(h,!1);h=this.SetupLabelFont(a,-1);var k=c[0].length,l=c.length,m=a.GetRefHeightFromPixelHeight(h),n=-m/2,p=CMUtilities.GetMinMax(d.Xs);d=CMUtilities.GetMinMax(d.Ys);if(e==p.Min)for(var q=0;q<l;q++)if(e=c[q][0],void 0!=e){a.GetTextWidthInPixels(r);try{var r=CMUtilities.GetDMSFromDD(e.Latitude,!1,!0);a.PaintRefText(r,e.Easting-n,e.Northing+
m/2,h,"right",0)}catch(t){throw t;}}if(f==p.Max)for(q=0;q<l;q++)e=c[q][k-1],void 0!=e&&(r=CMUtilities.GetDMSFromDD(e.Latitude,!1,!0),a.PaintRefText(r,e.Easting+n,e.Northing+m/2,h,"",0));if(g==d.Min)for(f=0;f<k;f++)e=c[l-1][f],void 0!=e&&(r=CMUtilities.GetDMSFromDD(e.Longitude,!0,!0),a.PaintRefText(r,e.Easting,e.Northing+m,h,"center",0));if(b==d.Max)for(f=0;f<k;f++)e=c[0][f],void 0!=e&&(r=CMUtilities.GetDMSFromDD(e.Longitude,!0,!0),a.PaintRefText(r,e.Easting,e.Northing-m/4,h,"center",0))}};
CMLayerGraticule.prototype.PaintBorder=function(a){var b=this.GetSetting("Border","BorderWidth",10);if(0<b){var c=a.GetCanvasElement(),d=c.width;c=c.height;var e={fillStyle:this.GetSetting("Border","fillStyle","rgba(255,255,255)"),strokeStyle:"rgba(0,0,0,0)"};a.SetStyle(e,!1);a.PaintRect(0,b,0,c);a.PaintRect(0,d,0,b);a.PaintRect(d-b,d,0,c);a.PaintRect(0,d,c-b,c);e={fillStyle:"rgba(0,0,0,0)",strokeStyle:this.GetSetting("Border","strokeStyle","rgba(0,0,0)")};a.SetStyle(e,!1);a.PaintRect(b,d-b,b,c-b)}};
CMLayerGraticule.prototype.PaintBorderLabels=function(a){if(0<this.GetSetting("Border","BorderWidth",10)){var b=this.GetSettingGroup("BorderText"),c=this.SetupLabelFont(a,-1);a.SetStyle(b,!1);a.ResetCollisions();b=.2*a.GetRefHeightFromPixelHeight(c);if(null!=this.TopIntersectionCoordinates)for(var d=0;d<this.TopIntersectionCoordinates.length;d++){var e=this.TopIntersectionCoordinates[d],f=CMUtilities.GetDMSFromDD(e.Longitude,!0,!0);a.PaintRefText(f,e.Easting,e.Northing-b,c,"center",0)}var g=a.GetRefHeightFromPixelHeight(c);
if(null!=this.BottomIntersectionCoordinates)for(d=0;d<this.BottomIntersectionCoordinates.length;d++)e=this.BottomIntersectionCoordinates[d],f=CMUtilities.GetDMSFromDD(e.Longitude,!0,!0),a.PaintRefText(f,e.Easting,e.Northing+.9*g,c,"center",0);if(null!=this.LeftIntersectionCoordinates)for(d=0;d<this.LeftIntersectionCoordinates.length;d++)e=this.LeftIntersectionCoordinates[d],f=CMUtilities.GetDMSFromDD(e.Latitude,!1,!0),a.PaintRefText(f,e.Easting+b,e.Northing,c,"center",-Math.PI/2);if(null!=this.RightIntersectionCoordinates)for(d=
0;d<this.RightIntersectionCoordinates.length;d++)e=this.RightIntersectionCoordinates[d],f=CMUtilities.GetDMSFromDD(e.Latitude,!1,!0),a.PaintRefText(f,e.Easting-b,e.Northing,c,"center",Math.PI/2)}};
CMLayerGraticule.prototype.Paint=function(a){if(this.IsVisible()&&a instanceof CMView2D){var b=this.GetParent(CMGeo).GetProjector();null==b&&(b=new CMProjector);b.Projection=null;b.Initialize();var c=b.GetClippingPolys();if(void 0!=c){for(var d=[],e=0;e<c.length;e++){var f=c[e];d.push(this.GetLatLonRangeFromClippingBounds(a,l,f,b))}f=-1;var g=0,h=0,k=0;for(e=0;e<c.length;e++){var l=d[e];if(null!=l){var m=l.MaxLon-l.MinLon;m>g&&(g=m,h=(l.MaxLon+l.MinLon)/2,k=(l.MaxLat+l.MinLat)/2);f+=m}}Spacing=this.GetSpacing(a,
b,h,k,f);if(.001<Spacing){var n=this.GetStyle();for(e=0;e<c.length;e++)l=d[e],null!=l&&(f=c[e],g=CMUtilities.GetMinMax(f.Xs),f=CMUtilities.GetMinMax(f.Ys),l.Spacing=Spacing,l.MinLon=Math.floor(l.MinLon/Spacing-1)*Spacing,l.MaxLon=Math.ceil(l.MaxLon/Spacing+1)*Spacing,l.MinLat=Math.floor(l.MinLat/Spacing-1)*Spacing,l.MaxLat=Math.ceil(l.MaxLat/Spacing+1)*Spacing,l.MinLon<g.Min&&(l.MinLon=g.Min),l.MaxLon>g.Max&&(l.MaxLon=g.Max),l.MinLat<f.Min&&(l.MinLat=f.Min),l.MaxLat>f.Max&&(l.MaxLat=f.Max));this.BottomIntersectionCoordinates=
[];this.TopIntersectionCoordinates=[];this.LeftIntersectionCoordinates=[];this.RightIntersectionCoordinates=[];g=this.GetSetting("Text","Visible",!0);for(e=0;e<c.length;e++)l=d[e],null!=l&&(f=c[e],null!=l&&(h=this.GetProjectedCoordinateGrid(a,l,b),this.PaintCoordinateGrid(a,l,h,b),g&&(a.ResetCollisions(),this.PaintGridLabels(a,l,h,f))));this.PaintBorder(a);this.PaintBorderLabels(a)}}a.SetStyle(n)}};function CMToolHandler(a){this.ObjectType=a}
CMToolHandler.prototype.MouseDown=function(a,b,c,d){a=-1;switch(this.ObjectType){case "Rectangle":d=new CMItemRect(CMItemRect.RECTANGLE);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "RoundedRectangle":d=new CMItemRect(CMItemRect.ROUNDED_RECTANGLE);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "Oval":d=new CMItemRect(CMItemRect.OVAL);a=this.TheLayer.AddObject(d);d.SetControlBounds(b,b,c,c);break;case "Polygon":d=new CMItemPoly;a=this.TheLayer.AddObject(d);
var e=[b,b],f=[c,c],g=[!1,!1];d.SetControlPoints(0,e,f,g);break;case "Curve":d=new CMItemPoly;a=this.TheLayer.AddObject(d);e=[b,b];f=[c,c];g=[!0,!0];d.SetControlPoints(0,e,f,g);break;case "Arrow":d=new CMItemPolyArrow,a=this.TheLayer.AddObject(d),e=[b,b],f=[c,c],g=[!0,!0],d.SetControlPoints(0,e,f,g)}this.TheLayer.TheItems[a].StartCreating(b,c);this.TheLayer.TheItems[a].SetSelected(!0);this.TheLayer.SelectedItemIndex=a;return!0};CMToolHandler.prototype.MouseMove=function(a,b,c){return!1};
CMToolHandler.prototype.MouseUp=function(a,b,c){return!1};function CMLayerItems(){CMLayer.call(this);this.TheItems=[];this.SelectedItemIndex=-1;this.ToolGroupElement=null}CMLayerItems.prototype=Object.create(CMLayer.prototype);CMLayerItems.prototype.contructor=CMLayerItems;
CMLayerItems.prototype.Unselected=function(){if(null!=this.ToolGroupElement){var a=this.GetParent(CMMainContainer),b=a.GetToolPanel();b.RemoveTool("CMLayerObjects_RectImage");b.RemoveTool("CMLayerObjects_RoundedRectImage");b.RemoveTool("CMLayerObjects_OvalImage");b.RemoveTool("CMLayerObjects_CurveImage");b.RemoveTool("CMLayerObjects_ArrowImage");b.RemoveToolGroupElement(this.ToolGroupElement);this.ToolGroupElement=null;a.GetView().SetToolHandler(null)}};CMLayerItems.prototype.GetNumChildren=function(){return this.TheItems.length};
CMLayerItems.prototype.GetChild=function(a){return this.TheItems[a]};CMLayerItems.prototype.DeleteAllChildren=function(){this.TheItems=[]};CMLayerItems.prototype.CMLayer_UnselectAll=CMLayer.prototype.UnselectAll;CMLayerItems.prototype.UnselectAll=function(a){this.CMLayer_UnselectAll(a);for(var b=0;b<this.TheItems.length;b++)this.TheItems[b].UnselectAll(a);this.Unselected()};CMLayerItems.prototype.CMLayer_SetSelected=CMLayer.prototype.SetSelected;
CMLayerItems.prototype.SetSelected=function(a){if(a!=this.GetSelected()){this.CMLayer_SetSelected(a);var b=this.GetParent(CMMainContainer),c=b.GetToolPanel();if(a){var d=b.GetSetting("MainContainer","ImageFolder");a=c.AddTool("CMLayerObjects_RectImage",d+"Icon_Rect_Default.png",d+"Icon_Rect_Selected.png");CMLayerItems.SetupTool(a,this,"Rectangle");b=c.AddTool("CMLayerObjects_RoundedRectImage",d+"Icon_RoundedRect_Default.png",d+"Icon_RoundedRect_Selected.png");CMLayerItems.SetupTool(b,this,"RoundedRectangle");
var e=c.AddTool("CMLayerObjects_OvalImage",d+"Icon_Oval_Default.png",d+"Icon_Oval_Selected.png");CMLayerItems.SetupTool(e,this,"Oval");var f=c.AddTool("CMLayerObjects_PolygonImage",d+"Icon_Polygon_Default.png",d+"Icon_Polygon_Selected.png");CMLayerItems.SetupTool(f,this,"Polygon");var g=c.AddTool("CMLayerObjects_CurveImage",d+"Icon_Curve_Default.png",d+"Icon_Curve_Selected.png");CMLayerItems.SetupTool(g,this,"Curve");d=c.AddTool("CMLayerObjects_ArrowImage",d+"Icon_Arrow_Default.png",d+"Icon_Arrow_Selected.png");
CMLayerItems.SetupTool(d,this,"Arrow");this.ToolGroupElement=c.MakeToolGroup([a,b,e,g,d,f])}else this.Unselected()}};CMLayerItems.SetupTool=function(a,b,c){a.TheLayer=b;a.ObjectType=c;a.Original_onclick=a.onclick;a.onclick=function(){a.Original_onclick();var b=this.TheLayer.GetParent(CMMainContainer);b.GetToolPanel();b=b.GetView();var c=new CMToolHandler(this.ObjectType);c.TheLayer=this.TheLayer;b.SetToolHandler(c)};a.UnselectFunction=function(){this.TheLayer.GetParent(CMMainContainer).GetView().SetToolHandler(null)}};
CMLayerItems.prototype.CMLayer_GetTimeSlices=CMLayer.prototype.GetTimes;CMLayerItems.prototype.GetTimes=function(a){a=this.CMLayer_GetTimeSlices(a);for(var b=0;b<this.TheItems.length;b++)a=this.TheItems[b].GetTimes(a);return a};CMLayerItems.prototype.In=function(a,b,c){var d=-1;if(this.IsVisible()&&null!=this.TheItems)for(var e=this.GetRefTolerance(a),f=0;f<this.TheItems.length&&-1==d;f++)-1!=this.TheItems[f].InPart(a,b,c,e)&&(d=f);return d};
CMLayerItems.prototype.MouseDown=function(a,b,c,d){var e=!1;if(this.IsVisible()&&this.GetSelectable()&&0==e&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)){var f=this.In(a,b,c);-1!=f&&(this.TheItems[f].MouseDown(a,b,c,d),this.TheItems[f].GetSelected()&&(this.SelectedItemIndex=f,e=!0))}return e};
CMLayerItems.prototype.MouseMove=function(a,b,c,d){var e=!1;if(this.GetSelectable())for(var f=0;f<this.TheItems.length&&0==e;f++)this.TheItems[f].GetSelected()&&(e=this.TheItems[f].MouseMove(a,b,c,d));return e};CMLayerItems.prototype.MouseUp=function(a,b,c,d){var e=!1;if(this.GetSelectable())for(var f=0;f<this.TheItems.length&&0==e;f++)this.TheItems[f].GetSelected()&&(e=this.TheItems[f].MouseUp(a,b,c,d));return e};
CMLayerItems.prototype.ShowInfoWindow=function(a,b,c,d){a=this.GetFeatureSetting("Layer","InfoText",a,null);null!=a&&(b=b.CreateInfoWindow("CMLayerItems.InfoWindow",c,d,this.GetInfoWindowWidth(),30,a),CMMainContainer.SetPopupWindow(b))};
CMLayerItems.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheItems){this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Starting Paint:"+CMUtilities.GetSeconds());var b=this.GetStyle(a);void 0!=b&&a.SetStyle(b);for(var c=0;c<this.TheItems.length;c++)this.TheItems[c].Paint(a);void 0!=b&&a.RestoreStyle();this.GetParent(CMMainContainer).AddToDebugPanel(this.GetName()+" Leaving Paint:"+CMUtilities.GetSeconds())}};
CMLayerItems.prototype.PaintSelected=function(a){if(this.IsVisible()){a.SaveStyle();for(var b=0;b<this.TheItems.length;b++)this.TheItems[b].PaintSelected(a);a.RestoreStyle()}};CMLayerItems.prototype.AddObject=function(a){this.TheItems.push(a);a.SetParent(this);this.Repaint();this.GetParent(CMScene).LayerContentChanged(this);return this.TheItems.length-1};CMLayerRaster.SettingDefintions={Raster:{Bounds:{Name:"URL",Type:CMBase.DATA_TYPE_BOUNDS,Default:null}}};function CMLayerRaster(){CMLayer.call(this);this.TheImage=null}CMLayerRaster.prototype=Object.create(CMLayer.prototype);CMLayerRaster.prototype.contructor=CMLayerRaster;CMLayerRaster.prototype.SetURL=function(a){this.TheImage=new Image;this.TheImage.Loaded=!1;this.TheImage.TheLayer=this;this.TheImage.onload=function(){this.Loaded=!0;this.TheLayer.OnLoad()};this.TheImage.src=a};
CMLayerRaster.prototype.SetImage=function(a){this.TheImage=a};CMLayerRaster.prototype.In=function(a,b,c){return-1};CMLayerRaster.prototype.Paint=function(a){if(this.IsVisible()&&null!=this.TheImage&&1==this.TheImage.Loaded){var b=a.GetContext(),c=this.TheBounds,d=this.GetStyle(a);void 0!=d&&a.SetStyle(d);null!=c?a.PaintRefImageScaled(this.TheImage,this.TheBounds):b.drawImage(this.TheImage,0,0,this.TheImage.width,this.TheImage.height);void 0!=d&&a.RestoreStyle()}};function CMLayerGrid(){CMLayer.call(this);this.TheImage=null}CMLayerGrid.prototype=Object.create(CMLayer.prototype);CMLayerGrid.prototype.contructor=CMLayerGrid;CMLayerGrid.prototype.RequestData=function(){var a=this.GetSetting("Dataset","URL",null),b=this.GetSetting("Dataset","Format",CMDataset.GEOJSON);this.SetURL(a,b)};
CMLayerGrid.prototype.SetURL=function(a){var b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.TheLayer=this;b.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(b.responseText);this.TheLayer.NumBands=a.NumBands;this.TheLayer.NumColumns=a.WidthInPixels;this.TheLayer.NumRows=a.HeightInPixels;this.TheLayer.MinPixelValues=a.MinPixelValues;this.TheLayer.MaxPixelValues=a.MaxPixelValues;this.TheLayer.TheData=a.Data;this.TheLayer.TheBounds=a.Bounds;this.TheLayer.OnLoad()}else alert("HTTP error "+
this.status+" "+this.statusText+" ("+this.TheURL+")")};b.send()};CMLayerGrid.prototype.In=function(a,b,c){return-1};
CMLayerGrid.prototype.Paint=function(a){if(void 0!=this.TheData&&null==this.TheImageData){var b=255/(this.MaxPixelValues-this.MinPixelValues),c=a.GetCanvasElement();c=c.getContext("2d");c=c.createImageData(this.NumColumns,this.NumRows);for(var d=0,e=0;e<this.NumRows;e++)for(var f=0;f<this.NumColumns;f++){var g=this.TheData[e][f];g=(g-this.MinPixelValues)*b;c.data[d+0]=g;c.data[d+1]=g;c.data[d+2]=g;c.data[d+3]=255;d+=4}this.TheImageData=c}this.IsVisible()&&null!=this.TheImageData&&(c=a.GetContext(),
d=this.TheBounds,b=this.GetStyle(a),void 0!=b&&a.SetStyle(b),null!=d?(RefX=d.XMin,RefY=d.YMax,RefWidth=d.XMax-d.XMin,RefHeight=d.YMin-d.YMax,c=a.GetPixelFromRef(RefX,RefY),d=Math.round(c.PixelX),e=Math.round(c.PixelY),f=a.GetPixelWidthFromRefWidth(RefWidth),g=a.GetPixelHeightFromRefHeight(RefHeight),f=Math.round(f),g=Math.round(g),c=a.GetCanvasElement(),c=c.getContext("2d"),c.putImageData(this.TheImageData,d,e,0,0,f,g)):c.drawImage(this.TheImageData,0,0,this.TheImage.width,this.TheImage.height),void 0!=
b&&a.RestoreStyle())};document.onmousedown=function(a){for(var b=!1,c=!1,d=0;d<CMMainContainer.PopupWindow.length;d++)b=jQuery.contains(CMMainContainer.PopupWindow[d],a.target),a.target===CMMainContainer.PopupWindow[d]&&(c=!0);!1===b&&!1===c&&CMMainContainer.HidePopupWindows()};
document.onmousemove=function(a){if(void 0!=CMMainContainer.DraggingItem){a||(a=window.event);var b=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,CMMainContainer.DraggingItem);a=b.x;b=b.y;CMMainContainer.DraggingItem.getBoundingClientRect();"s"==CMMainContainer.Dragging?(CMMainContainer.DraggingItem.style.height=b+"px",CMMainContainer.DraggingItem.TheCanvasMap.Resize()):"e"==CMMainContainer.Dragging&&(CMMainContainer.DraggingItem.style.width=a+"px",CMMainContainer.DraggingItem.TheCanvasMap.Resize())}};
document.onmouseup=function(a){void 0!=CMMainContainer.DraggingItem&&(CMMainContainer.DraggingItem=void 0,CMMainContainer.Dragging=void 0,document.body.style.cursor="default")};CMMainContainer.SetPopupWindow=function(a){CMMainContainer.HidePopupWindows();CMMainContainer.PopupWindow.push(a)};CMMainContainer.AddPopupWindow=function(a){CMMainContainer.PopupWindow.push(a)};
CMMainContainer.HidePopupWindows=function(){for(var a=0;a<CMMainContainer.PopupWindow.length;a++)CMMainContainer.PopupWindow[a].style.visibility="hidden";CMMainContainer.PopupWindow=[]};CMMainContainer.MAP_CONTAINER="MapContainer";CMMainContainer.TOOL_CONTAINER="ToolContainer";CMMainContainer.TOOL_EDIT="ToolEdit";CMMainContainer.TOOL_INFO="ToolInfo";CMMainContainer.TOOL_PAN="ToolPan";CMMainContainer.CANVAS_CONTAINER="CanvasContainer";CMMainContainer.CANVAS="Canvas";CMMainContainer.LAYER_LIST="LayerList";
CMMainContainer.MAP_FOOTER="MapFooter";CMMainContainer.MAP_COORDINATES="MapCoordinates";CMMainContainer.MAP_SRS="SRS";CMMainContainer.MAP_CREDITS="Credits";CMMainContainer.NAVIGATION="Navigation";CMMainContainer.BACKGROUND_LIST="BackgroundList";CMMainContainer.SEARCH_PANEL="SearchPanel";CMMainContainer.VERTICAL_TAB_CONTAINER="TabContainer";CMMainContainer.HORIZIONAL_TAB_CONTAINER="HorizontalTabContainer";CMMainContainer.SETTINGS_PANEL="SettingsPanel";CMMainContainer.TIME_EDITOR_PANEL="TimeEditPanel";
CMMainContainer.ATTRIBUTE_PANEL="AttributePanel";CMMainContainer.TIME_SLIDER_PANEL="TimeSliderPanel";CMMainContainer.GESTURE_ZOOM=.2;CMMainContainer.GESTURE_PAN=8;CMMainContainer.NumMaps=0;CMMainContainer.PopupWindow=[];
CMMainContainer.ELEMENT_DEFS={MapContainer:{ID:"CM_MapContainer",ClassName:"CM_MapContainer"},ToolContainer:{ID:"CM_ToolContainer",ClassName:"CM_ToolContainer"},ToolEdit:{ID:"CM_ToolEdit",ClassName:"CM_Tool"},ToolInfo:{ID:"CM_ToolInfo",ClassName:"CM_Tool"},ToolPan:{ID:"CM_ToolPan",ClassName:"CM_Tool"},CanvasContainer:{ID:"CM_CanvasContainer",ClassName:"CM_CanvasContainer"},Canvas:{ID:"CM_Canvas",ClassName:"CM_Canvas",HTMLTag:"CANVAS"},LayerList:{ID:"CM_LayerList",ClassName:"CM_ButtonContent"},MapFooter:{ID:"CM_MapFooter",
ClassName:"CM_MapFooter"},MapCoordinates:{ID:"CM_MapCoordinates",ClassName:"CM_Credits"},SRS:{ID:"CM_SRS",ClassName:"CM_Credits"},Credits:{ID:"CM_Credits",ClassName:"CM_Credits"},Navigation:{ID:"CM_Navigation",ClassName:"CM_Navigation"},BackgroundList:{ID:"CM_BackgroundList",ClassName:"CM_ButtonContent"},SearchPanel:{ID:"CM_SearchPanel",ClassName:"CM_ButtonContent"},TabContainer:{ID:"CM_TabContainer",ClassName:"CM_TabContainer"},HorizontalTabContainer:{ID:"CM_HorizontalTabContainer",ClassName:"CM_HorizontalTabContainer"},
SettingsPanel:{ID:"CM_SettingsPanel",ClassName:"CM_SettingsPanel"},TimeEditPanel:{ID:"CM_TimeEditPanel",ClassName:"CM_TimeEditPanel"},AttributePanel:{ID:"CM_AttributePanel",ClassName:"CM_AttributePanel"},TimeSliderPanel:{ID:"CM_TimeSliderPanel",ClassName:"CM_TimeSliderPanel"}};
CMMainContainer.SettingDefintions={MainContainer:{AllowMouseEvents:{Name:"Allow Mouse Events",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!0},MobileSupported:{Name:"Mobile Supported",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!1},Scene3D:{Name:"3D Scene",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!1},ImageFolder:{Name:"Image Folder",Type:CMBase.DATA_TYPE_STRING,Default:"../Images/"},CoordinateUnits:{Name:"Coordinate Units",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMUtilities.COORDINATE_UNITS_DD,CMUtilities.COORDINATE_UNITS_DMS,
CMUtilities.COORDINATE_UNITS_METERS,CMUtilities.COORDINATE_UNITS_FEET,CMUtilities.COORDINATE_UNITS_PIXELS,CMUtilities.COORDINATE_UNITS_ZOOM],Default:CMUtilities.COORDINATE_UNITS_DMS}}};
function CMMainContainer(){CMBase.call(this);this.ExistingElements=!0;this.Settings={MainContainer:{}};this.Index=CMMainContainer.NumMaps;CMMainContainer.NumMaps++;this.Elements=this.TheScene=null;this.Test=!1;this.PanelSearch=this.PanelBackgrounds=this.PanelLayerList=this.PanelSettings=this.PanelFooter=this.ToolPanel=this.DebugPanel=null}CMMainContainer.prototype=Object.create(CMBase.prototype);CMMainContainer.prototype.contructor=CMMainContainer;
CMMainContainer.prototype.SetTest=function(a){this.Test=a};CMMainContainer.MouseWheel=function(a){CMMainContainer.HidePopupWindows();a=window.event||a;return this.TheCanvasMap.TheScene.GetView(0).MouseWheel(a)};
CMMainContainer.prototype.Private_CreateElements=function(){null==this.Elements&&(this.Elements={});for(var a in CMMainContainer.ELEMENT_DEFS)if(void 0===this.Elements[a]){var b=CMMainContainer.ELEMENT_DEFS[a].ID+"_"+this.Index;this.ExistingElements&&(this.Elements[a]=document.getElementById(b));if(a!=CMMainContainer.HORIZIONAL_TAB_CONTAINER){if(void 0==this.Elements[a]){var c=CMMainContainer.ELEMENT_DEFS[a].HTMLTag;void 0==c&&(c="DIV");this.Elements[a]=document.createElement(c);this.Elements[a].id=
b}void 0!=CMMainContainer.ELEMENT_DEFS[a].ClassName&&(this.Elements[a].className=CMMainContainer.ELEMENT_DEFS[a].ClassName)}}};CMMainContainer.prototype.GetSettingsDefinitions=function(){var a={};for(Key in CMItem.SettingDefintions)a[Key]=CMItem.SettingDefintions[Key];return a};CMMainContainer.prototype.SetImageFolder=function(a){this.SetSetting("MainContainer","ImageFolder",a)};
CMMainContainer.prototype.SetCoordinateUnits=function(a){this.SetSetting("MainContainer","CoordinateUnits",a);null!=this.PanelFooter&&(this.PanelFooter.CoordinateUnits=a)};CMMainContainer.prototype.SetDebugPanel=function(a){this.DebugPanel=a};CMMainContainer.prototype.AddToDebugPanel=function(a){null!=this.DebugPanel&&(this.DebugPanel.innerHTML+=a+"<br>")};
CMMainContainer.prototype.SetElement=function(a,b){null==this.Elements&&(this.Elements={});"string"==typeof b&&(b=document.getElementById(b));this.Elements[a]=b};CMMainContainer.prototype.GetElement=function(a){return this.Elements[a]};
CMMainContainer.prototype.SimpleMap=function(){this.SetElement(CMMainContainer.TOOL_CONTAINER,null);this.SetElement(CMMainContainer.NAVIGATION,null);this.SetElement(CMMainContainer.VERTICAL_TAB_CONTAINER,null);this.SetElement(CMMainContainer.LAYER_LIST,null);this.SetElement(CMMainContainer.BACKGROUND_LIST,null);this.SetElement(CMMainContainer.SEARCH_PANEL,null);this.SetElement(CMMainContainer.SETTINGS_PANEL,null);this.SetElement(CMMainContainer.MAP_FOOTER,null)};
CMMainContainer.prototype.Initialize=function(a){this.Private_CreateElements();var b=this.GetSetting("MainContainer","ImageFolder"),c=null;void 0==a||a instanceof CMView2D?(this.TheScene=new CMScene(this),c=new CMGeo(this.TheScene),void 0==a&&(a=a=new CMView2D)):(this.TheScene=new CM3Scene,c=new CM3Geo(this.TheScene),0==a instanceof CM3View&&(a=new CM3View));this.TheScene.SetParent(this);this.TheScene.AddView(a);this.TheScene.SetGeo(c);a.Setup(this.Elements[CMMainContainer.CANVAS],this.Elements[CMMainContainer.CANVAS_CONTAINER]);
c=this.Elements[CMMainContainer.MAP_CONTAINER];c.TheCanvasMap=this;c.OriginalMouseDown=c.onmousedown;var d=this.Elements[CMMainContainer.CANVAS_CONTAINER];CMUtilities.IsDefined(d)&&c.appendChild(d);var e=this.Elements[CMMainContainer.CANVAS];CMUtilities.IsDefined(e)&&d.appendChild(e);d=this.Elements[CMMainContainer.TOOL_CONTAINER];CMUtilities.IsDefined(d)&&c.appendChild(d);d=this.Elements[CMMainContainer.VERTICAL_TAB_CONTAINER];CMUtilities.IsDefined(d)&&(this.TabPanel=new CMPanelButtons(this),this.TabPanel.SetElement(d),
c.appendChild(d),d=this.Elements[CMMainContainer.LAYER_LIST],CMUtilities.IsDefined(d)&&(this.PanelLayerList=new CMPanelLayerList(this),this.TabPanel.AddTab("Layers",b+"Icon_Layers.png",void 0,d,c),this.PanelLayerList.SetElement(d)),d=this.Elements[CMMainContainer.BACKGROUND_LIST],CMUtilities.IsDefined(d)&&(this.PanelBackgrounds=new CMPanelBackgrounds(this),this.TabPanel.AddTab("Background",b+"Icon_Background_Default.png",null,d,c),this.PanelBackgrounds.SetElement(d)),d=this.Elements[CMMainContainer.SEARCH_PANEL],
CMUtilities.IsDefined(d)&&(this.PanelSearch=new CMPanelSearch(this),this.TabPanel.AddTab("Search",b+"Icon_Search.png",null,d,c),this.PanelSearch.SetElement(d)));d=this.GetElement(CMMainContainer.TOOL_CONTAINER);if(CMUtilities.IsDefined(d)){this.ToolPanel=new CMPanelTool(this);this.ToolPanel.SetElement(d);e=this.GetElement(CMMainContainer.TOOL_EDIT);CMUtilities.IsDefined(e)&&(d=this.ToolPanel.AddTool(e,b+"IconArrow_20w_Default.png",b+"IconArrow_20w_Selected.png",this,"Click to get information on features or drag the map",
function(a){a.SelectTool(CMView.TOOL_SELECT)}),d.CMMainContainer=this);var f=this.GetElement(CMMainContainer.TOOL_PAN);CMUtilities.IsDefined(f)&&(d=this.ToolPanel.AddTool(f,b+"IconHand_20w_Default.png",b+"IconHand_20pixels_Selected.png",this,"Click to get information on features or drag the map",function(a){a.SelectTool(CMView.TOOL_HAND)}),d.CMMainContainer=this);var g=this.GetElement(CMMainContainer.TOOL_INFO);CMUtilities.IsDefined(g)&&(d=this.ToolPanel.AddTool(g,b+"Icon_I_Default.png",b+"Icon_I_Selected.png",
this,"Click to get information on features or drag the map",function(a){a.SelectTool(CMView.TOOL_INFO)}),d.CMMainContainer=this);this.ToolPanel.MakeToolGroup([e,f,g]);e=document.createElement("DIV");e.id="CMZoomIn_0";e.className="CM_Tool";d=this.ToolPanel.AddTool(e,b+"Icon_ZoomIn_Small_17H.png",b+"Icon_ZoomIn_Small_17H.png",this,"Click to zoom into the map",function(a){this.CMMainContainer.GetScene().GetView(0).ZoomIn()});d.CMMainContainer=this;f=document.createElement("DIV");f.id="CMHome_0";f.className=
"CM_Tool";d=this.ToolPanel.AddTool(f,b+"Icon_HomeExtent_small_17H.png",b+"Icon_HomeExtent_small_17H.png",this,"Click to zoom into the map",function(a){this.CMMainContainer.GetScene().GetView(0).ZoomToMaxBounds()});d.CMMainContainer=this;g=document.createElement("DIV");g.id="CMZoomOut_0";d=this.ToolPanel.AddTool(g,b+"Icon_ZoomOut_Small_17H.png",b+"Icon_ZoomOut_Small_17H.png",this,"Click to zoom into the map",function(a){this.CMMainContainer.GetScene().GetView(0).ZoomOut()});d.CMMainContainer=this;
this.ToolPanel.MakeToolGroup([e,f,g])}b=this.Elements[CMMainContainer.MAP_FOOTER];CMUtilities.IsDefined(b)&&(this.PanelFooter=new CMPanelFooter(this),this.PanelFooter.SetElement(b),c.appendChild(b));b=this.Elements[CMMainContainer.HORIZIONAL_TAB_CONTAINER];CMUtilities.IsDefined(b)&&(this.HoriziontalTabContainer=new CMPanelTabs(this),this.HoriziontalTabContainer.SetElement(b),b=this.Elements[CMMainContainer.TIME_EDITOR_PANEL],CMUtilities.IsDefined(b)&&(this.PanelTimeline=new CMPanelTime(this),this.PanelTimeline.SetElement(b),
this.HoriziontalTabContainer.AddTab("Timeline","Timeline",null,b),b=this.GetPanelSettings(),this.PanelTimeline.SetSettingsPanel(b)),b=this.Elements[CMMainContainer.ATTRIBUTE_PANEL],CMUtilities.IsDefined(b)&&((new CMPanelAttributes(this)).SetElement(b),this.HoriziontalTabContainer.AddTab("Attributes","Attributes",null,b)),d=this.Elements[CMMainContainer.SETTINGS_PANEL],CMUtilities.IsDefined(d)&&(b=new CMPanelSettings(this),b.SetElement(d),this.HoriziontalTabContainer.AddTab("Settings","Settings",null,
d)));this.GetSetting("MainContainer","AllowMouseEvents",!0)&&(a.AddMouseEventHandlers(),a.AddKeyEventHandlers());c.addEventListener("mousemove",function(a){a||(a=window.event);a=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this);var b=a.x,c=this.offsetWidth;this.style.cursor=10>Math.abs(this.offsetHeight-a.y)?"s-resize":10>Math.abs(c-b)?"e-resize":"default"});c.addEventListener("mousedown",function(a){a||(a=window.event);a=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this);var b=a.x,
c=this.offsetWidth;10>Math.abs(this.offsetHeight-a.y)?(CMMainContainer.DraggingItem=this,CMMainContainer.Dragging="s",document.body.style.cursor="s-resize"):10>Math.abs(c-b)?(CMMainContainer.DraggingItem=this,CMMainContainer.Dragging="e",document.body.style.cursor="e-resize"):document.body.style.cursor="default"});d=this.GetElement(CMMainContainer.CANVAS_CONTAINER);this.GetSetting("MainContainer","MobileSupported")&&a.AddMobileEvents()};
CMMainContainer.prototype.SetSetting=function(a,b,c){try{this.Settings[a][b]=c}catch(d){CMMainContainer.Error("Sorry, we could not find the group '"+a+"' or the Key '"+b+"' in this objects settings")}};CMMainContainer.prototype.GetSetting=function(a,b,c){var d=CMMainContainer.SettingDefintions[a][b].Default;void 0!=c&&(d=c);a=this.Settings[a];void 0!=a&&b in a&&(d=a[b]);return d};CMMainContainer.prototype.GetScene=function(){return this.TheScene};CMMainContainer.prototype.GetView=function(){return this.TheScene.GetView(0)};
CMMainContainer.prototype.GetToolPanel=function(){return this.ToolPanel};CMMainContainer.prototype.GetPanelFooter=function(){return this.PanelFooter};CMMainContainer.prototype.GetPanelSettings=function(){return this.PanelSettings};CMMainContainer.prototype.SetPanelSettings=function(a){this.PanelSettings=a};CMMainContainer.prototype.GetPanelTimeline=function(){return this.PanelTimeline};CMMainContainer.prototype.SetProjector=function(a){this.TheScene.SetProjector(a)};
CMMainContainer.prototype.GetProjector=function(){return this.TheScene.GetProjector()};CMMainContainer.prototype.SelectTool=function(a){null==this.TheScene.GetView(0)&&alert("Sorry, CMMainContainer.SelectTool() cannot be called until after Initialize() is called()");this.TheScene.GetView(0).SetTool(a)};
CMMainContainer.prototype.AddLayer=function(a){var b=-1;null==this.TheScene?alert("Sorry, CMMainContainer.AddLayer() cannot be called until after Initialize() is called()"):b=this.TheScene.AddLayer(a);return b};CMMainContainer.prototype.AddBackground=function(a){null==this.TheScene?alert("Sorry, CMMainContainer.AddBackground() cannot be called until after Initialize() is called()"):this.TheScene.AddBackground(a)};
CMMainContainer.prototype.StartMap=function(a){"undefined"!=typeof CM3Scene&&this.TheScene instanceof CM3Scene&&this.TheScene.Start();CMUtilities.IsDefined(this.TabPanel);a?this.Resize():this.TheScene.Resize()};CMMainContainer.prototype.ZoomIn=function(){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomIn() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomIn()};
CMMainContainer.prototype.ZoomOut=function(){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomOut() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomOut()};CMMainContainer.prototype.ZoomToMax=function(){var a=this.TheScene.GetBounds();null!=a&&this.TheScene.GetView(0).ZoomToBounds(a)};
CMMainContainer.prototype.ZoomToBounds=function(a){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomToBounds() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomToBounds(a)};CMMainContainer.prototype.ZoomTo=function(a){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.ZoomTo() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).ZoomTo(a)};
CMMainContainer.prototype.SetRefCenter=function(a,b){null==this.TheScene.GetView(0)?alert("Sorry, CMMainContainer.SetRefCenter() cannot be called until after Setup() is called()"):this.TheScene.GetView(0).SetRefCenter(a,b)};CMMainContainer.prototype.Resize=function(){CMMainContainer.HidePopupWindows();this.TheScene.Resize()};CMMainContainer.Error=function(a){throw a;};CMNorthArrow.SettingDefintions={NorthArrow:{Scale:{Name:"Scale",Type:CMBase.DATA_TYPE_FLOAT,Default:1},ClassName:{Name:"Class Name",Type:CMBase.DATA_TYPE_STRING,Default:"CM_NorthArrow"},URL:{Name:"URL",Type:CMBase.DATA_TYPE_STRING,Default:null}}};function CMNorthArrow(){CMItem.call(this);this.TimeSlices[0].Settings.NorthArrow={};this.OriginalHeight=this.OriginalWidth=this.AngleInRadians=0}CMNorthArrow.prototype=Object.create(CMItem.prototype);CMNorthArrow.prototype.contructor=CMNorthArrow;
CMNorthArrow.prototype.SetupAngle=function(a){this.AngleInRadians=0;if(void 0!=this.TheContainer){var b=this.GetParent(CMMainContainer).GetProjector();this.TheContainer.getBoundingClientRect();var c=this.TheContainer.offsetTop+this.TheContainer.offsetHeight/2,d=a.GetRefXFromPixelX(this.TheContainer.offsetLeft+this.TheContainer.offsetWidth/2),e=a.GetRefYFromPixelY(c-5);a=a.GetRefYFromPixelY(c+5);isNaN(d)||isNaN(e)||isNaN(a)?this.AngleInRadians=0:(e=b.ProjectToGeographic(d,e),b=b.ProjectToGeographic(d,
a),null!=e&&null!=b&&(this.AngleInRadians=Math.PI-Math.atan2(b[0]-e[0],b[1]-e[1])))}};
CMNorthArrow.prototype.SetTransform=function(){if(void 0!=this.TheContainer){var a=this.TheContainer.childNodes[0];if(void 0!=a){var b=180*this.AngleInRadians/Math.PI,c=a.clientWidth,d=a.clientHeight,e=this.GetSetting("NorthArrow","Scale",1);a.setAttribute("transform"," translate("+this.OriginalWidth/2*(e-1)+","+this.OriginalHeight/2*(e-1)+") scale("+e+") rotate("+b+")");this.TheContainer.style.width=c*e+"px";this.TheContainer.style.height=d*e+"px"}}};
CMNorthArrow.prototype.SetupNorthArrow=function(){var a=this.GetParent(CMMainContainer).GetElement(CMMainContainer.CANVAS_CONTAINER);if(void 0==this.TheContainer){var b=document.createElement("div");b.className=this.GetSetting("NorthArrow","ClassName","CM_NorthArrow");a.appendChild(b);this.TheContainer=b;b.innerHTML=this.SVGText;a=this.TheContainer.childNodes[0];this.OriginalWidth=a.clientWidth;this.OriginalHeight=a.clientHeight;this.SetTransform()}};
CMNorthArrow.prototype.Paint=function(a){void 0!=this.TheContainer&&(this.SetupAngle(a),this.SetTransform())};CMNorthArrow.prototype.RequestData=function(){var a=this.GetSetting("NorthArrow","URL");this.SetURL(a)};
CMNorthArrow.prototype.SetURL=function(a){this.URL=a;var b=new XMLHttpRequest;b.open("GET",a,!0);b.TheURL=a;b.ThisNorthArrow=this;b.onreadystatechange=function(){4==this.readyState&&(200==this.status?(this.ThisNorthArrow.SVGText=b.responseText,this.ThisNorthArrow.SetupNorthArrow()):alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")"))};b.send()};CMPanelBackgrounds.LAYER_LIST_ITEM_HEIGHT=24;CMPanelBackgrounds.LAYER_POPUP_MENU_ITEM_HEIGHT=24;
function CMPanelBackgrounds(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelBackgrounds requires a CanvasMap object on construction");this.SetParent(a);a.GetScene().AddListener(CMScene.MESSAGE_BACKGROUNDS_CHANGED,this,function(a,c,d){c.Setup(a)});this.TheElement=null;this.LayerListItemHeight=CMPanelBackgrounds.LAYER_LIST_ITEM_HEIGHT;this.LayerPopupMenuItemHeight=CMPanelBackgrounds.LAYER_POPUP_MENU_ITEM_HEIGHT}CMPanelBackgrounds.prototype=Object.create(CMBase.prototype);
CMPanelBackgrounds.prototype.contructor=CMPanelBackgrounds;CMPanelBackgrounds.prototype.SetElement=function(a){this.TheElement=a};
CMPanelBackgrounds.prototype.Setup=function(a){for(var b=this.TheElement;b.firstChild;)b.removeChild(b.firstChild);var c=b.style.left,d=b.style.top;c=0;d=6;a=a.GetChild(0,CMGeo);for(var e=0;e<a.GetNumBackgrounds();e++){var f=a.GetBackground(e),g=d+e*this.LayerListItemHeight,h=document.createElement("div");h.className="CM_BackgroundListItemClass";var k=jQuery(b).outerWidth(!1);CMUtilities.AbsolutePosition(h,c+2,g,k,this.LayerListItemHeight);b.appendChild(h);g=document.createElement("input");g.className=
"CM_BackgroundListRadioButtonClass";g.name="Background";g.value=f.Name;g.type="radio";g.TheGeo=a;g.TheBackground=f;g.ThisIndex=e;g.addEventListener("click",function(){this.checked&&this.TheGeo.SetSelectedBackgroundIndex(this.ThisIndex)});g.checked=!1;a.SelectedBackgroundIndex==e&&(g.checked=!0);CMUtilities.AbsolutePosition(g,c+2,-6,14,this.LayerListItemHeight);h.appendChild(g);g=document.createElement("div");g.className="CM_BackgroundListNameClass";f=f.GetSetting("Item","Name","Unnamed");g.innerHTML=
f;CMUtilities.AbsolutePosition(g,c+30,0,150,this.LayerListItemHeight);h.appendChild(g)}};function CMPanelFooter(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelFooter requires a CanvasMap object on construction");this.SetParent(a);this.CoordinateUnits=CMUtilities.COORDINATE_UNITS_DD;var b=a.GetScene();this.TheMainContainer=a;for(a=0;a<b.GetNumViews();a++)b.GetView(a).AddListener(CMView.MESSAGE_MOUSE_MOVED,this,function(a,b,e){void 0!=b.TheCoordinates&&(a=a.GetCoordinateStringFromEvent(e,b.CoordinateUnits),""==a&&(a=" "),b.TheCoordinates.innerHTML=a)})}
CMPanelFooter.prototype=Object.create(CMBase.prototype);CMPanelFooter.prototype.contructor=CMPanelFooter;
CMPanelFooter.prototype.SetElement=function(a){this.TheElement=a;var b=document.createElement("TABLE");b.width="100%";var c=b.insertRow(0),d=c.insertCell(0);c=c.insertCell(1);this.TheCredits=document.createElement("DIV");this.TheCredits.className="CM_Credits";c.appendChild(this.TheCredits);c.style.align="right";c=document.createElement("TABLE");var e=c.insertRow(0).insertCell(0);this.TheCoordinates=document.createElement("DIV");this.TheCoordinates.className="CM_MapCoordinates";e.appendChild(this.TheCoordinates);
e=c.insertRow(1).insertCell(0);this.TheSRS=document.createElement("DIV");this.TheSRS.className="CM_SRS";e.appendChild(this.TheSRS);d.appendChild(c);a.appendChild(b)};CMPanelFooter.prototype.SetCredits=function(a){this.TheCredits.innerHTML=a};CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT=28;CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT=24;
function CMPanelLayerList(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelLayerList requires a CanvasMap object on construction");this.SetParent(a);a.GetScene().AddListener(CMScene.MESSAGE_LAYER_LIST_CHANGED,this,function(a,c,d){c.AddLayerList(a)});this.TheElement=null;this.LayerListItemHeight=CMPanelLayerList.LAYER_LIST_ITEM_HEIGHT;this.LayerPopupMenuItemHeight=CMPanelLayerList.LAYER_POPUP_MENU_ITEM_HEIGHT}CMPanelLayerList.prototype=Object.create(CMBase.prototype);
CMPanelLayerList.prototype.contructor=CMPanelLayerList;CMPanelLayerList.prototype.AddLayerToList=function(a,b,c,d,e){b=e.GetChild(0,CMGeo).GetChild(b,CMLayer);try{b.AddToList(a,c,d,this.LayerListItemHeight)}catch(f){throw f;}};CMPanelLayerList.prototype.SetElement=function(a){this.TheElement=a};CMPanelLayerList.prototype.Setup=function(a){for(a=this.TheElement;a.hasChildNodes();)a.removeChild(a.lastChild)};
CMPanelLayerList.prototype.AddLayerList=function(a){TheElement=this.TheElement;for(TheElement.LayerListPanel=this;TheElement.firstChild;)TheElement.removeChild(TheElement.firstChild);for(var b=TheElement.style.left,c=TheElement.style.top,d=c=b=0,e=a.GetChild(0,CMGeo),f=0;f<e.GetNumChildren(CMLayer);f++)d=c+f*this.LayerListItemHeight,this.AddLayerToList(TheElement,f,b,d,a);TheElement.addEventListener("mousemove",function(a){if(null!=this.DraggingDiv){var b=$(this).offset();CMUtilities.AbsolutePosition(this.DraggingDiv,
0,a.clientY-b.top,200,0);a.preventDefault();return!1}});TheElement.addEventListener("mouseup",function(a){if(null!=this.DraggingDiv){a.preventDefault();var b=this.LayerListPanel.GetParent().GetScene(),c=$(this).offset();b.MoveLayer(this.DraggingLayer,Math.floor((a.clientY-c.top)/this.LayerListPanel.LayerListItemHeight));this.DraggingDiv.style.visibility="hidden";this.DraggingDiv=null;this.LayerListPanel.AddLayerList(b)}return!1});TheElement.addEventListener("mouseleave",function(a){null!=this.DraggingDiv&&
(this.DraggingDiv.style.visibility="hidden",this.DraggingDiv=null,a.preventDefault())})};function CMPanelSearch(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelSearch requires a CanvasMap object on construction");this.SetParent(a);this.TheElement=null}CMPanelSearch.prototype=Object.create(CMBase.prototype);CMPanelSearch.prototype.contructor=CMPanelSearch;
CMPanelSearch.prototype.SetElement=function(a){this.TheElement=a;a.innerHTML="Search:";var b=document.createElement("DIV");b.id="CM_SearchResults";var c=document.createElement("INPUT");c.setAttribute("type","text");a.appendChild(c);var d=document.createElement("INPUT");d.setAttribute("type","button");d.value="Submit";d.className="CM_SearchButton";d.TextField=c;d.CanvasMap=this.GetParent();d.SearchResults=b;d.onclick=function(){var a=this.TextField.value;a=a.toLowerCase();b.innerHTML="";this.CanvasMap.TheScene.GetSearchResults(a,
b)};a.appendChild(d);a.appendChild(b)};function CMPanelTool(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelTool requires a CanvasMap object on construction");this.SetParent(a);this.Tools=[]}CMPanelTool.prototype=Object.create(CMBase.prototype);CMPanelTool.prototype.contructor=CMPanelTool;CMPanelTool.prototype.GetToolIndexFromID=function(a){for(var b=-1,c=0;c<this.Tools.length;c++)this.Tools[c].id==a&&(b=c);return b};CMPanelTool.prototype.SetElement=function(a){this.TheElement=a;this.Tools=[]};
CMPanelTool.prototype.AddTool=function(a,b,c,d,e,f){if(null!=this.TheElement){if("string"===typeof a){var g=a;a=document.createElement("DIV");a.id=g;a.className="CM_Tool"}else g=a.id;a.style.backgroundColor="none";a.title=e;a.cursor="pointer";a.innerHTML="<img id='"+g+"_Image' class='CMTool_Image' src='"+b+"'alt='ID Marker'>";a.Selected=!1;a.ToolPanel=this;a.UnselectedFilePath=b;a.SelectedFilePath=c;a.TheFunction=f;a.onclick=function(){var a=this.ToolPanel;a.GetParent(CMMainContainer);a.SelectTool(this.id);
CMMainContainer.HidePopupWindows();void 0!=this.TheFunction&&this.TheFunction(d)};this.TheElement.appendChild(a);this.Tools.push(a)}return a};
CMPanelTool.prototype.MakeToolGroup=function(a){for(var b=0;b<a.length;b++){var c=a[b];c.parentNode.removeChild(c)}var d=document.createElement("DIV");d.className="CM_ToolGroup";b=document.createElement("TABLE");d.appendChild(b);b.style.borderSpacing="0px";var e=b.insertRow(0),f=0;for(b=0;b<a.length;b++){c=a[b];c.className="CM_ToolInGroup";var g=e.insertCell(-1);b!=a.length-1&&(g.style.borderRight="thin solid #999");g.appendChild(c);f+=28}d.style.width=f+"px";this.TheElement.appendChild(d);return d};
CMPanelTool.prototype.RemoveToolGroupElement=function(a){this.TheElement.removeChild(a)};CMPanelTool.prototype.AddToolGroupElement=function(a){this.TheElement.appendChild(a)};CMPanelTool.prototype.RemoveTool=function(a){a=this.GetToolIndexFromID(a);if(-1!=a){var b=this.Tools[a];b.parentNode.removeChild(b);this.Tools.splice(a,1)}};
CMPanelTool.prototype.SelectTool=function(a){for(var b=0;b<this.Tools.length;b++){var c=this.Tools[b];if(c.id==a){c.Selected=!0;var d=document.getElementById(a+"_Image");d.src=c.SelectedFilePath}else c.Selected&&(void 0!=c.UnselectFunction&&c.UnselectFunction(),c.Selected=!1,d=document.getElementById(c.id+"_Image"),d.src=c.UnselectedFilePath)}};function CMPanelButtons(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelButtons requires a CanvasMap object on construction");this.SetParent(a);this.Tabs=[];this.TabContents=[]}CMPanelButtons.prototype=Object.create(CMBase.prototype);CMPanelButtons.prototype.contructor=CMPanelButtons;CMPanelButtons.prototype.GetTabIndexFromName=function(a){for(var b=-1,c=0;c<this.Tabs.length;c++)this.Tabs[c].Name==a&&(b=c);return b};
CMPanelButtons.prototype.SetElement=function(a){this.TheElement=a;this.TabContainer=document.createElement("DIV");this.TabContainer.className="CM_PanelButtons";this.TheElement.appendChild(this.TabContainer)};
CMPanelButtons.prototype.AddTab=function(a,b,c,d,e){if(null!=this.TheElement){var f=document.createElement("button");f.id=a+"_tab";f.className="tablinks";void 0!=c&&(f.title=c);f.innerHTML="<img src='"+b+"'></img>";f.Selected=!1;f.TabPanel=this;f.ContentID=a;f.onclick=function(){this.TabPanel.SelectTab(this.ContentID)};this.Tabs.push(f);this.TabContainer.appendChild(f);0==CMUtilities.IsDefined(d)&&(d=document.createElement("DIV"),d.id=a,d.className="CM_ButtonContent");d.style.visibility="hidden";
this.TabContents.push(d);e.appendChild(d)}return d};CMPanelButtons.prototype.SelectTab=function(a){a+="_tab";for(var b=0;b<this.Tabs.length;b++)this.Tabs[b].id==a?(this.TabContents[b].style.visibility="visible",CMMainContainer.SetPopupWindow(this.TabContents[b]),this.Tabs[b].className=this.Tabs[b].className+=" active"):(this.TabContents[b].style.visibility="hidden",this.Tabs[b].className=this.Tabs[b].className.replace(" active",""))};
CMPanelButtons.prototype.GetTabContentElement=function(a){var b=null;a=this.GetTabIndexFromName(a);-1!=a&&(b=this.TabContents[a]);return b};CMPanelButtons.prototype.RemoveTab=function(a){a=this.GetTabIndexFromName(a);if(-1!=a){var b=this.Tabs[a];b.parentNode.removeChild(b);this.Tabs.splice(a,1);this.TabContents.splice(a,1)}};function CMProjector(){CMBase.call(this)}CMProjector.prototype=Object.create(CMBase.prototype);CMProjector.prototype.contructor=CMProjector;CMProjector.prototype.ProjectPolyFromGeographicWithoutClip=function(a){var b=a[0];a=a[1];for(var c=[],d=[],e=0;e<b.length;e++)try{var f=this.ProjectFromGeographic(b[e],a[e]);CMUtilities.IsDefined(f)&&(c.push(f[0]),d.push(f[1]))}catch(g){throw g;}return[c,d]};
CMProjector.prototype.ProjectAreaFromGeographicWithoutClip=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=this.ProjectPolyFromGeographicWithoutClip(a[c]);return b};CMProjector.prototype.ProjectRegionFromGeographicWithoutClip=function(a){for(var b=[],c=0;c<a.length;c++)b[c]=this.ProjectAreaFromGeographicWithoutClip(a[c]);return b};CMProjector.prototype.Initialize=function(){};CMProjector.prototype.ProjectToGeographic=function(a,b,c){return[a,b,c]};
CMProjector.prototype.ProjectFromGeographic=function(a,b,c){return[a,b,c]};CMProjector.prototype.GetClippingPolys=function(){return Result=[{Xs:[-180,180,180,-180],Ys:[90,90,-90,-90],Outside:[!0,!0,!0,!0]}]};
CMProjector.prototype.GetRegionToDraw=function(){var a=[],b=this.GetClippingPolys();if(null==b){var c=this.ProjectAreaFromGeographicWithoutClip([[[-180,180,180,-180],[90,90,-90,-90]]]);a.push(c)}else for(var d=0;d<b.length;d++){var e=b[d],f=e.Xs,g=e.Ys;e=e.Outside;for(var h=0;h<e.length;h++)if(e[h]){c=h+1;c==e.length&&(c=0);c=[[[f[h],f[c]],[g[h],g[c]]]];var k=CMProjector.GetMinPointDistance(f,g);c=CMUtilities.AddPointsToArea(c,CMDatasetVector.TYPE_POLYGONS,k);c=this.ProjectAreaFromGeographicWithoutClip(c);
a.push(c)}}return a};CMProjector.GetMinPointDistance=function(a,b){a=CMUtilities.GetMinMax(a);var c=CMUtilities.GetMinMax(b);b=(a.Max-a.Min)/200;a=(c.Max-c.Min)/200;c=b;b>a&&(c=a);return c};
CMProjector.prototype.GetRegionToFill=function(){var a=[],b=this.GetClippingPolys();if(null==b){var c=this.ProjectAreaFromGeographicWithoutClip([[[-180,180,180,-180],[90,90,-90,-90]]]);a.push(c)}else for(var d=0;d<b.length;d++){c=b[d];var e=c.Xs,f=c.Ys;c=[[e,f]];e=CMProjector.GetMinPointDistance(e,f);c=CMUtilities.AddPointsToArea(c,CMDatasetVector.TYPE_POLYGONS,e);c=this.ProjectAreaFromGeographicWithoutClip(c);a.push(c)}return a};
CMProjector.prototype.GetProjectedBounds=function(){var a=this.GetClippingPolys();if(null!=a){for(var b=!1,c=0,d=0,e=0,f=0,g=0;g<a.length;g++){var h=a[g],k=[[h.Xs,h.Ys]];k=CMUtilities.AddPointsToArea(k,CMDatasetVector.TYPE_POLYGONS,5);k=this.ProjectAreaFromGeographicWithoutClip(k);h=k[0][0];k=k[0][1];for(var l=0;l<h.length;l++)0==b?(e=h[l],c=h[l],f=k[l],d=k[l],b=!0):(h[l]<c&&(c=h[l]),h[l]>e&&(e=h[l]),k[l]<d&&(d=k[l]),k[l]>f&&(f=k[l]))}Result={XMin:c,XMax:e,YMin:d,YMax:f}}return Result};
CMProjector.prototype.ProjectPolyFromGeographic=function(a){var b=a[0],c=a[1],d=null,e=[],f=[],g=null;2<a.length&&(d=a[2],g=[]);a=void 0;for(var h=0;h<b.length;h++){null!=d&&(a=d[h]);var k=this.ProjectFromGeographic(b[h],c[h],a);e.push(k[0]);f.push(k[1]);null!=d&&g.push(k[2])}return[e,f]};
CMProjector.prototype.ProjectAreaFromGeographic=function(a,b){this.Initialize();var c=[],d=this.GetClippingPolys();if(null==d)c=this.ProjectAreaFromGeographicWithoutClip(a);else for(var e=0;e<d.length;e++){var f=d[e];f=CMUtilities.ClipArea(a,[f.Xs[0],f.Ys[2],f.Xs[2],f.Ys[0]],b);f=CMUtilities.AddPointsToArea(f,b,5);f=this.ProjectAreaFromGeographicWithoutClip(f);for(var g=0;g<f.length;g++)c.push(f[g])}return c};
CMProjector.prototype.ProjectRegionFromGeographic=function(a,b){this.Initialize();for(var c=[],d=0;d<a.length;d++){var e=this.ProjectAreaFromGeographic(a[d],b);c.push(e)}return c};CMProjector.prototype.ProjectRegionsFromGeographic=function(a,b){this.Initialize();for(var c=[],d=0;d<a.length;d++){var e=this.ProjectRegionFromGeographic(a[d],b);c.push(e)}return c};CMProjector.prototype.GetMethods=function(){return this.GetSettingsDefinitions().Projection.Method.Options};
CMProjector.GetGeographicClippingPolys=function(a,b,c,d,e){Result=[];if(-180>a)if(-180>b){a=a+360+e;var f=b+360-e;a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!0,!0,!0]}}else a=a+360+e,f=180,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!1,!0,!0]},Result.push(a),a=-180,f=b-e,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!0,!0,!1]};else 180<b?180<a?(a=a-360+e,f=b-360-e,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!0,!0,!0]}):(a+=e,f=180,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!1,!0,!0]},Result.push(a),a=-180,f=b-360-
e,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!0,!0,!1]}):(a+=e,f=b-e,a={Xs:[a,f,f,a],Ys:[d,d,c,c],Outside:[!0,!0,!0,!0]});Result.push(a);return Result};CMProjector.DegreesToRadians=function(a){return Math.PI/180*a};CMProjector.RadiansToDegrees=function(a){return DegreeAngle=a/(Math.PI/180)};var Mercator_PixelsPerDegreee=[.71111111111111,1.4222222222222,2.8444444444444,5.6888888888889,11.377777777778,22.755555555556,45.511111111111,91.022222222222,182.04444444444,364.08888888889,728.17777777778,1456.3555555556,2912.7111111111,5825.4222222222,11650.844444444,23301.688888889,46603.377777778,93206.755555556,186413.51111111,372827.02222222],Mercator_PixelsPerRadian=[40.743665431525,81.48733086305,162.9746617261,325.9493234522,651.8986469044,1303.7972938088,2607.5945876176,5215.1891752352,
10430.37835047,20860.756700941,41721.513401882,83443.026803764,166886.05360753,333772.10721505,667544.21443011,1335088.4288602,2670176.8577204,5340353.7154409,1.0680707430882E7,2.1361414861763E7],Mercator_Offsets=[128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288,1048576,2097152,4194304,8388608,16777216,33554432,67108864],Mercator_NumColumns=[0,1,2,4,8,16,32,64,128,256,512,1024,2048,4096,8192,16384,32768,65536,131072,262144,524288];
function CMProjectorGoogleMaps(){CMProjector.call(this);this.ZoomLevel=18}CMProjectorGoogleMaps.prototype=Object.create(CMProjector.prototype);CMProjectorGoogleMaps.prototype.contructor=CMProjectorGoogleMaps;
CMProjectorGoogleMaps.prototype.ProjectFromGeographic=function(a,b){var c=Mercator_Offsets[this.ZoomLevel];a=Math.round(c+a*Mercator_PixelsPerDegreee[this.ZoomLevel]);b=Math.sin(CMProjector.DegreesToRadians(b));b=Math.max(b,-.9999);b=Math.min(b,.9999);return[a,-Math.round(c+.5*Math.log((1+b)/(1-b))*-Mercator_PixelsPerRadian[this.ZoomLevel])]};
CMProjectorGoogleMaps.prototype.ProjectToGeographic=function(a,b){var c=Mercator_Offsets[this.ZoomLevel];a=(a-c)/Mercator_PixelsPerDegreee[this.ZoomLevel];b=CMProjector.RadiansToDegrees(2*Math.atan(Math.exp((-b-c)/-Mercator_PixelsPerRadian[this.ZoomLevel]))-Math.PI/2);return[a,b]};CMProjectorGoogleMaps.prototype.GetClippingPolys=function(){return Result=CMProjector.GetGeographicClippingPolys(-180,180,-85,85,.001)};CMProjectorGoogleMaps.prototype.SetZoomLevel=function(a){this.ZoomLevel=a};CMProjectorProj4JS2.SettingDefintions={Projection:{lon_0:{Name:"Longitude Of Origin",Type:CMBase.DATA_TYPE_FLOAT,Default:0,Min:-180,Max:180},lon_1:{Name:"First Meridian",Type:CMBase.DATA_TYPE_FLOAT,Default:-40,Min:-180,Max:180},lon_2:{Name:"Second Merdian",Type:CMBase.DATA_TYPE_FLOAT,Default:40,Min:-180,Max:180},lat_ts:{Name:"Latitude Of True Scale",Type:CMBase.DATA_TYPE_FLOAT,Default:0,Min:-90,Max:90},lat_0:{Name:"Latitude Of Origin",Type:CMBase.DATA_TYPE_FLOAT,Default:0,Min:-90,Max:90},lat_1:{Name:"First Parallel",
Type:CMBase.DATA_TYPE_FLOAT,Default:20,Min:-90,Max:90},lat_2:{Name:"Second Parallel",Type:CMBase.DATA_TYPE_FLOAT,Default:40,Min:-90,Max:90},Method:{Name:"Method",Type:CMBase.DATA_TYPE_ENUMERATED,Options:"Albers Equal Area;Cylindrical Equal-Area;Cylindrical Equal-Area Projection;Equidistant Cylindrical (Plate Carree);Equidistant conic projection;Gnomonic;Lambert Conformal Conic;Mercator;Miller;Mollweide;Oblique Stereographic Alternative;Sinusoidal;Stereographic;Swiss Oblique Mercator".split(";"),Default:"Albers Equal Area"}}};
CMProjectorProj4JS2.MethodIDs="aea cea equi eqc eqdc gnom lcc merc mill moll sterea sinu stere somerc".split(" ");
function CMProjectorProj4JS2(){CMProjector.call(this);this.Settings={Projection:{lon_0:0,lon_1:0,lon_2:0,lat_0:0,lat_1:40,lat_2:-40,lat_ts:0,Method:"Albers Equal Area"}};this.ProjectionName="aea";this.LongitudeOfOrigin=this.LatitudeOfOrigin=0;this.ScalingFactor=1;this.SemiMinor=this.SemiMajor=6371E3;this.EccentrictySquared=.08181881201777498;this.Eccentricty=.006694318;this.ReciprocalOfEllipsoidFlattening=298;this.XRange=180;this.YMax=90;this.YMin=-90;this.Projection=null}
CMProjectorProj4JS2.prototype=Object.create(CMProjector.prototype);CMProjectorProj4JS2.prototype.contructor=CMProjectorProj4JS2;CMProjectorProj4JS2.prototype.SetupProjectionName=function(a){this.ProjectionName=CMProjectorProj4JS2.GetProjectionCodeFromProjectionName(a)};
CMProjectorProj4JS2.prototype.SetupRanges=function(){this.XRange=180;this.YMax=90;this.YMin=-90;switch(this.ProjectionName){case "aea":this.XRange=120;this.YMax=this.GetSetting("Projection","lat_1")+40;this.YMin=this.GetSetting("Projection","lat_2")-40;break;case "aeqd":this.XRange=80;TheLatitude=this.GetSetting("Projection","lat_0");this.YMax=TheLatitude+50;this.YMin=TheLatitude-50;break;case "cass":this.XRange=70;TheLatitude=this.GetSetting("Projection","lat_0");this.YMax=TheLatitude+80;this.YMin=
TheLatitude-80;break;case "eqc":TheLatitude=this.GetSetting("Projection","lat_0");this.YMax=TheLatitude+80;this.YMin=TheLatitude-80;break;case "eqdc":TheLatitude=this.GetSetting("Projection","lat_0");this.XRange=120;this.YMax=TheLatitude+80;this.YMin=TheLatitude-80;break;case "gnom":TheLatitude=this.GetSetting("Projection","lat_0");this.XRange=180;TheLatitude=this.GetSetting("Projection","lat_0");0<=TheLatitude?(this.YMax=90,this.YMin=40):(this.YMax=-40,this.YMin=-90);break;case "gstmerc":this.XRange=
70;TheLatitude=this.GetSetting("Projection","lat_0");this.YMax=TheLatitude+80;this.YMin=TheLatitude-80;break;case "krovak":this.XRange=70;TheLatitude=this.GetSetting("Projection","lat_0");this.YMax=80;this.YMin=0;break;case "laea":this.XRange=120;TheLatitude=this.GetSetting("Projection","lat_1");this.YMax=TheLatitude+90;this.YMin=TheLatitude-90;break;case "lcc":this.XRange=120;this.YMax=this.GetSetting("Projection","lat_1")+40;this.YMin=this.GetSetting("Projection","lat_2")-40;break;case "merc":this.XRange=
180;this.YMax=85;this.YMin=-85;break;case "omerc":this.Projection=omerc;case "ortho":this.XRange=180;this.YMax=90;this.YMin=-90;break;case "poly":this.XRange=120;break;case "somerc":this.YMax=this.XRange=80;this.YMin=-80;break;case "stere":this.XRange=90;break;case "sterea":this.XRange=100;this.YMax=80;this.YMin=-80;break;case "tmerc":this.XRange=40;break;case "utm":alert("UTM is only supported through tmerc");break;case "vandg":this.XRange=120,this.YMax=80,this.YMin=-80}90<this.YMax&&(this.YMax=
90);-90>this.YMin&&(this.YMin=-90)};CMProjectorProj4JS2.prototype.GetSettingsDefinitions=function(){var a={};for(Key in CMProjectorProj4JS2.SettingDefintions)a[Key]=CMProjectorProj4JS2.SettingDefintions[Key];return a};CMProjectorProj4JS2.prototype.CMProjector_SettingsChanged=CMProjector.prototype.SettingsChanged;CMProjectorProj4JS2.prototype.SettingsChanged=function(){this.CMProjector_SettingsChanged();this.SendMessageToListeners(CMBase.MESSAGE_SETTINGS_CHANGED);this.Projection=null};
CMProjectorProj4JS2.prototype.Initialize=function(){if(null==this.Projection){var a=this.GetSetting("Projection","Method");this.LongitudeOfOrigin=this.GetSetting("Projection","lon_0");this.LatitudeOfOrigin=this.GetSetting("Projection","lat_0");this.SetupProjectionName(a);switch(this.ProjectionName){case "aea":this.Projection=aea;break;case "aeqd":this.Projection=aeqd;break;case "cass":this.Projection=cass;break;case "cea":this.Projection=cea;break;case "eqc":this.Projection=eqc;break;case "eqdc":this.Projection=
eqdc;break;case "equi":this.Projection=equi;break;case "gauss":this.Projection=gauss;break;case "gnom":this.Projection=gnom;break;case "gstmerc":this.Projection=gstmerc;break;case "krovak":this.Projection=krovak;break;case "laea":this.Projection=laea;break;case "lcc":this.Projection=lcc;break;case "longlat":this.Projection=longlat;break;case "merc":this.Projection=merc;break;case "mill":this.Projection=mill;break;case "moll":this.Projection=moll;break;case "nzmg":this.Projection=nzmg;break;case "omerc":this.Projection=
omerc;break;case "ortho":this.Projection=ortho;break;case "poly":this.Projection=poly;break;case "sinu":this.Projection=sinu;break;case "somerc":this.Projection=somerc;break;case "stere":this.Projection=stere;break;case "sterea":this.Projection=sterea;break;case "tmerc":this.Projection=tmerc;break;case "utm":alert("UTM is only supported through tmerc");break;case "vandg":this.Projection=vandg}this.Projection.sphere=!0;this.Projection.a=this.SemiMajor;this.Projection.b=this.SemiMinor;this.Projection.ep2=
(this.Projection.a-this.Projection.b)/this.Projection.b;this.Projection.x0=0;this.Projection.y0=0;this.Projection.lat_ts=CMProjector.DegreesToRadians(this.GetSetting("Projection","lat_ts"));this.Projection.lat0=CMProjector.DegreesToRadians(this.GetSetting("Projection","lat_0"));this.Projection.lat1=CMProjector.DegreesToRadians(this.GetSetting("Projection","lat_1"));this.Projection.lat2=CMProjector.DegreesToRadians(this.GetSetting("Projection","lat_2"));this.Projection==gnom&&(0<=this.GetSetting("Projection",
"lat_0")?this.Projection.lat0=Math.PI/2:this.Projection.lat0=-Math.PI/2);this.Projection.long0=CMProjector.DegreesToRadians(this.GetSetting("Projection","lon_0"));this.Projection.long1=CMProjector.DegreesToRadians(this.GetSetting("Projection","lon_1"));this.Projection.long2=CMProjector.DegreesToRadians(this.GetSetting("Projection","lon_2"));this.Projection.k0=this.ScalingFactor;this.Projection.e=this.Eccentricty;this.Projection.es=this.EccentrictySquared;this.Projection.rf=this.ReciprocalOfEllipsoidFlattening;
this.Projection.init();this.SetupRanges()}};CMProjectorProj4JS2.prototype.ProjectFromGeographic=function(a,b,c){if(void 0==a)throw"something went wrong with the coordinates in CMProjectorProj4JS2.ProjectFromGeographic()";this.Initialize();90<=b&&(b=89.99999);-90>=b&&(b=-89.99999);-180>=a&&(a=-179.99999);180<=a&&(a=179.99999);b=CMProjector.DegreesToRadians(b);a={x:CMProjector.DegreesToRadians(a),y:b};a=this.Projection.forward(a);b=null;null!=a&&0==isNaN(a.x)&&0==isNaN(a.x)&&(b=[a.x,a.y,c]);return b};
CMProjectorProj4JS2.prototype.ProjectToGeographic=function(a,b,c){var d=null;this.Initialize();a={x:a,y:b};a=this.Projection.inverse(a);null!=a&&95!==a&&(d=CMProjector.RadiansToDegrees(a.x),a=CMProjector.RadiansToDegrees(a.y),d=[d,a,c]);return d};
CMProjectorProj4JS2.prototype.GetClippingPolys=function(){this.Initialize();var a=this.LongitudeOfOrigin-this.XRange;var b=this.LongitudeOfOrigin+this.XRange;if(0!=this.LongitudeOfOrigin)a=CMProjector.GetGeographicClippingPolys(a,b,this.YMin,this.YMax,1E-5);else{var c=this.YMax,d=this.YMin;a=[{Xs:[a,b,b,a],Ys:[c,c,d,d],Outside:[!0,!0,!0,!0]}]}return a};CMProjectorProj4JS2.prototype.CMProjector_GetRegionToDraw=CMProjector.prototype.GetRegionToDraw;
CMProjectorProj4JS2.prototype.GetRegionToDraw=function(){var a=[];if("ortho"==this.ProjectionName){var b=[CMUtilities.GetRegularPolygon(100,2*this.SemiMajor,0,0,0)];a.push(b)}else a=this.CMProjector_GetRegionToDraw();return a};CMProjectorProj4JS2.prototype.CMProjector_GetRegionToFill=CMProjector.prototype.GetRegionToFill;
CMProjectorProj4JS2.prototype.GetRegionToFill=function(){var a=[];if("ortho"==this.ProjectionName){var b=[CMUtilities.GetRegularPolygon(100,2*this.SemiMajor,0,0,0)];a.push(b)}else a=this.CMProjector_GetRegionToFill();return a};CMProjectorProj4JS2.prototype.CMProjector_GetProjectedBounds=CMProjector.prototype.GetProjectedBounds;CMProjectorProj4JS2.prototype.GetProjectedBounds=function(){return"ortho"==this.ProjectionName?{XMin:-6371E3,XMax:6371E3,YMin:-6371E3,YMax:6371E3}:this.CMProjector_GetProjectedBounds()};
CMProjectorProj4JS2.prototype.ResetSettings=function(){this.SetSetting("Projection","lon_0",0);this.SetSetting("Projection","lon_1",0);this.SetSetting("Projection","lon_2",0);this.SetSetting("Projection","lat_0",0);this.SetSetting("Projection","lat_1",40);this.SetSetting("Projection","lat_2",-40);this.SetSetting("Projection","lat_ts",0)};CMProjectorProj4JS2.prototype.GetClass=function(){return CMProjectorProj4JS2};
CMProjectorProj4JS2.GetProjectionCodeFromProjectionName=function(a){a=CMProjectorProj4JS2.SettingDefintions.Projection.Method.Options.indexOf(a);return CMProjectorProj4JS2.MethodIDs[a]};CMProjectorProj4JS2.ControlDefinitions={lon_0:{Name:"lon_0",Values:[-180,180]},lon_1:{Name:"lon_1",Values:[-180,180]},lon_2:{Name:"lon_2",Values:[-180,180]},lat_0:{Name:"lat_0",Values:[-90,90]},lat_1:{Name:"lat_1",Values:[-90,90]},lat_2:{Name:"lat_2",Values:[-90,90]},lat_ts:{Name:"lat_ts",Values:[-90,90]}};
CMProjectorProj4JS2.GetControlInformation=function(a){var b=null,c=CMProjectorProj4JS2.ControlDefinitions;switch(a){case "aea":b=[c.lon_0,c.lat_1,c.lat_2];break;case "aeqd":b=[c.lon_0,c.lat_0];break;case "cass":b=[c.lon_0,c.lat_0];break;case "cea":b=[c.lon_0,c.lat_ts];break;case "eqc":b=[c.lon_0,c.lat_0,c.lat_ts];break;case "eqdc":b=[c.lon_0,c.lat_1,c.lat_2];break;case "equi":b=[c.lon_0];break;case "gnom":b=[c.lon_0,c.lat_0];break;case "gstmerc":b=[c.lon_0,c.lat_0];break;case "krovak":b=[c.lon_0,
c.lat_0];break;case "laea":b=[c.lon_0,c.lat_1];break;case "lcc":b=[c.lon_0,c.lat_1,c.lat_2];break;case "merc":b=[c.lon_0,c.lat_ts];break;case "mill":b=[c.lon_0];break;case "moll":b=[c.lon_0];break;case "nzmg":b=[];break;case "omerc":b=[c.lon_1,c.lon_2,c.lat_1,c.lat_2];break;case "ortho":b=[c.lon_0,c.lat_0];break;case "poly":b=[c.lon_0];break;case "sinu":b=[c.lon_0];break;case "somerc":b=[c.lon_0];break;case "stere":b=[c.lon_0,c.lat_ts];break;case "sterea":b=[c.lon_0,c.lat_0];break;case "tmerc":b=
[c.lon_0,c.lat_0];break;case "utm":alert("UTM is only supported through tmerc");break;case "vandg":b=[c.lon_0]}return b};CMProjectorUTM.SettingDefintions={UTM:{Datum:{Name:"Datum",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMProjector.WGS_84,CMProjector.NAD_27,CMProjector.NAD_83]},Zone:{Name:"Zone",Type:CMBase.DATA_TYPE_INTEGER,Default:10},South:{Name:"South",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!1}}};function CMProjectorUTM(){CMProjector.call(this);this.Settings={}}CMProjectorUTM.prototype=Object.create(CMProjector.prototype);CMProjectorUTM.prototype.contructor=CMProjectorUTM;CMProjector.WGS_84=1;
CMProjector.NAD_27=2;CMProjector.NAD_83=3;CMProjectorUTM.EPSG_WGS84_UTM_1_NORTH=32601;CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH=32701;CMProjectorUTM.PI=3.14159265;CMProjectorUTM.deg2rad=CMProjectorUTM.PI/180;CMProjectorUTM.rad2deg=180/CMProjectorUTM.PI;CMProjectorUTM.EquatorialRadii=[6378135,6378137,6378206,6378137];CMProjectorUTM.SquaresOfEccentricity=[.006694318,.00669438,.006768658,.00669438];
CMProjectorUTM.prototype.ProjectFromGeographic=function(a,b){-180>a&&(a=-180);180<a&&(a=180);-90>b&&(b=-90);90<b&&(b=90);var c=null;var d=this.GetSetting("UTM","Datum",CMProjector.WGS_84);if(0<=d&&4>d){c=CMProjectorUTM.EquatorialRadii[d];d=CMProjectorUTM.SquaresOfEccentricity[d];parseInt((a+180)/360*360-180);b*=CMProjectorUTM.deg2rad;var e=a*CMProjectorUTM.deg2rad;var f=(6*(this.GetSetting("UTM","Zone",10)-1)-180+3)*CMProjectorUTM.deg2rad;a=d/(1-d);var g=c/Math.sqrt(1-d*Math.sin(b)*Math.sin(b));var h=
Math.tan(b)*Math.tan(b);var k=a*Math.cos(b)*Math.cos(b);f=Math.cos(b)*(e-f);d=c*((1-d/4-3*d*d/64-5*d*d*d/256)*b-(3*d/8+3*d*d/32+45*d*d*d/1024)*Math.sin(2*b)+(15*d*d/256+45*d*d*d/1024)*Math.sin(4*b)-35*d*d*d/3072*Math.sin(6*b));c=.9996*g*(f+(1-h+k)*f*f*f/6+(5-18*h+h*h+72*k-58*a)*f*f*f*f*f/120)+5E5;b=.9996*(d+g*Math.tan(b)*(f*f/2+(5-h+9*k+4*k*k)*f*f*f*f/24+(61-58*h+h*h+600*k-330*a)*f*f*f*f*f*f/720));this.GetSetting("UTM","South",!1)&&(b+=1E7);c=[c,b]}return c};
CMProjectorUTM.prototype.ProjectToGeographic=function(a,b){var c=this.GetSetting("UTM","Datum",CMProjector.WGS_84);void 0==c&&alert("Sorry, the datum must be defined to call ProjectToGeographic in the CMProjectorUTM class");var d=null;if(0<=c&&4>c&&-4E6<a&&45E5>a){d=CMProjectorUTM.EquatorialRadii[c];c=CMProjectorUTM.SquaresOfEccentricity[c];var e=(1-Math.sqrt(1-c))/(1+Math.sqrt(1-c));var f=a-5E5;var g=b;1==this.GetSetting("UTM","South",!1)&&(g-=1E7);b=this.GetSetting("UTM","Zone",10);a=c/(1-c);g=
g/.9996/(d*(1-c/4-3*c*c/64-5*c*c*c/256));var h=g+(3*e/2-27*e*e*e/32)*Math.sin(2*g)+(21*e*e/16-55*e*e*e*e/32)*Math.sin(4*g)+151*e*e*e/96*Math.sin(6*g);var k=d/Math.sqrt(1-c*Math.sin(h)*Math.sin(h));e=Math.tan(h)*Math.tan(h);g=a*Math.cos(h)*Math.cos(h);d=d*(1-c)/Math.pow(1-c*Math.sin(h)*Math.sin(h),1.5);c=f/(.9996*k);d=h-k*Math.tan(h)/d*(c*c/2-(5+3*e+10*g-4*g*g-9*a)*c*c*c*c/24+(61+90*e+298*g+45*e*e-252*a-3*g*g)*c*c*c*c*c*c/720);d*=CMProjectorUTM.rad2deg;a=(c-(1+2*e+g)*c*c*c/6+(5-2*g+28*e-3*g*g+8*a+
24*e*e)*c*c*c*c*c/120)/Math.cos(h);a=6*(b-1)-180+3+a*CMProjectorUTM.rad2deg;-180>a&&(a=-180);180<a&&(a=180);-90>d&&(d=-90);90<d&&(d=90);d=[a,d]}return d};CMProjectorUTM.prototype.GetBounds2=function(){var a=6*(this.GetSetting("UTM","Zone",10)-1)-180+3;return{XMax:a+30,XMin:a-30,YMax:80,YMin:-80}};CMProjectorUTM.prototype.GetClippingPolys=function(){var a=this.GetBounds2();return CMProjector.GetGeographicClippingPolys(a.XMin,a.XMax,a.YMin,a.YMax,.001)};
CMProjectorUTM.prototype.GetUTMZoneFromLonLat=function(a,b){LongTemp=a+180-360*parseInt((a+180)/360)-180;a=parseInt((LongTemp+180)/6)+1;56<=b&&64>b&&3<=LongTemp&&12>LongTemp&&(a=32);72<=b&&84>b&&(0<=LongTemp&&9>LongTemp?a=31:9<=LongTemp&&21>LongTemp?a=33:21<=LongTemp&&33>LongTemp?a=35:33<=LongTemp&&42>LongTemp&&(a=37));return a};CMProjectorUTM.prototype.GetSouthFromLat=function(a){var b=!1;0>a&&(b=!0);return b};
CMProjectorUTM.prototype.GetUTMZoneFromEPSG=function(a){var b=0;a>=CMProjectorUTM.EPSG_WGS84_UTM_1_NORTH&&a<=CMProjectorUTM.EPSG_WGS84_UTM_1_NORTH+59?b=a-CMProjectorUTM.EPSG_WGS84_UTM_1_NORTH+1:a>=CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH&&a<=CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH+59&&(b=a-CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH+1);return b};CMProjectorUTM.prototype.GetSouthFromEPSG=function(a){var b=!1;a>=CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH&&a<=CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH+59&&(b=!0);return b};
CMProjectorUTM.prototype.GetEPSGFromUTM=function(a,b){return 0==b?CMProjectorUTM.EPSG_WGS84_UTM_1_NORTH+a-1:CMProjectorUTM.EPSG_WGS84_UTM_1_SOUTH+a-1};CMScaleBar.UNITS_ISO=0;CMScaleBar.UNITS_ENGLISH=1;
CMScaleBar.SettingDefintions={ScaleBar:{ClassName:{Name:"Class Name",Type:CMBase.DATA_TYPE_STRING,Default:"CM_ScaleBar"},strokeStyle:{Name:"Line Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},lineWidth:{Name:"Line Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"},fillStyle:{Name:"Fill Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},shadowColor:{Name:"Shadow Color",Type:CMBase.DATA_TYPE_COLOR,Default:"rgb(0,0,0)"},shadowBlur:{Name:"Shadow Blur",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetX:{Name:"Shadow X",Type:CMBase.DATA_TYPE_FLOAT,Default:1},shadowOffsetY:{Name:"Shadow Y",Type:CMBase.DATA_TYPE_FLOAT,Default:1}},UnitText:{Text:{Name:"Text",Type:CMBase.DATA_TYPE_STRING,Default:null},font:{Name:"Font",Type:CMBase.DATA_TYPE_FONT,Default:"12px Arial"},strokeStyle:{Name:"Line Style",
Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(0,0,0)"},fillStyle:{Name:"Fill Style",Type:CMBase.DATA_TYPE_CSS_STYLE,Default:"rgb(255,255,255)"},lineWidth:{Name:"Width",Type:CMBase.DATA_TYPE_INTEGER,Default:1},lineCap:{Name:"Line Cap",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["butt","round","square"],Default:"round"},lineJoin:{Name:"Line Join",Type:CMBase.DATA_TYPE_ENUMERATED,Options:["bevel","round","miter"],Default:"round"}},Factors:{UnitFontHeightFactor:{Name:"Corner Width",Type:CMBase.DATA_TYPE_FLOAT,
Default:.35},LabelFontHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.3},ScaleBarHeightFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.3},ScaleBarBaseLineFromBottomFactor:{Name:"Corner Height",Type:CMBase.DATA_TYPE_FLOAT,Default:.2},Units:{Name:"Units",Type:CMBase.DATA_TYPE_ENUMERATED,Options:[CMScaleBar.UNITS_ISO,CMScaleBar.UNITS_ENGLISH],Default:CMScaleBar.UNITS_ISO},Margin:{Name:"Margin",Type:CMBase.DATA_TYPE_FLOAT,Default:4}}};
function CMScaleBar(a,b,c,d){CMItem.call(this);this.TimeSlices[0].Settings.UnitText={};this.TimeSlices[0].Settings.ScaleBar={};this.TimeSlices[0].Settings.Factors={UnitFontHeightFactor:.35,LabelFontHeightFactor:.3,ScaleBarHeightFactor:.3,ScaleBarBaseLineFromBottomFactor:.2,Units:CMScaleBar.UNITS_ISO,Margin:4}}CMScaleBar.prototype=Object.create(CMItem.prototype);CMScaleBar.prototype.contructor=CMScaleBar;
CMScaleBar.RemovePixels=function(a){var b="";if(null!=a){a=a.split(" ");for(var c=0;c<a.length;c++)-1==a[c].indexOf("px")&&(""!=b&&(b+=" "),b+=a[c])}return b};
CMScaleBar.prototype.SetupScaleBar=function(){if(void 0==this.TheContainer){var a=this.GetParent(CMMainContainer).GetElement(CMMainContainer.CANVAS_CONTAINER),b=document.createElement("div");b.className=this.GetSetting("ScaleBar","ClassName","CM_ScaleBar");a.appendChild(b);this.TheContainer=b;this.TheCanvas=document.createElement("CANVAS");b.appendChild(this.TheCanvas);this.TheView=new CMView2D;this.TheView.Setup(this.TheCanvas)}};CMLog10=Math.log10||function(a){return Math.log(a)*Math.LOG10E};
CMScaleBar.prototype.Paint=function(a){this.SetupScaleBar();this.GetParent(CMScene).GetView(0);var b=this.TheView;var c=this.TheContainer.offsetWidth,d=this.TheContainer.offsetHeight;this.TheCanvas.width!=c&&(this.TheCanvas.width=c);this.TheCanvas.height!=d&&(this.TheCanvas.height=d);var e=this.TheContainer.offsetLeft,f=e+c,g=this.TheContainer.offsetTop+d/2;e=a.GetRefXFromPixelX(e);g=a.GetRefYFromPixelY(g);f=a.GetRefXFromPixelX(f);var h=g,k=this.GetParent(CMMainContainer).GetProjector();null!=k&&
(a=k.ProjectToGeographic(e,g),k=k.ProjectToGeographic(f,h),null!=a&&null!=k&&(e=a[0],g=a[1],f=k[0],h=k[1]));e=e/180*Math.PI;g=g/180*Math.PI;f=f/180*Math.PI;h=h/180*Math.PI;a=this.GetSettingGroup("Factors");var l=a.Units,m=6371*Math.acos(Math.sin(g)*Math.sin(h)+Math.cos(g)*Math.cos(h)*Math.cos(Math.abs(f-e)));l==CMScaleBar.UNITS_ENGLISH&&(m*=.621371);var n=a.UnitFontHeightFactor;f=a.LabelFontHeightFactor;e=a.ScaleBarHeightFactor;k=a.ScaleBarBaseLineFromBottomFactor;g=a.Margin;a=this.GetSetting("Text",
"font","12px Arial");a=CMScaleBar.RemovePixels(a);h=""+d*f+"px "+a;a=b.TheContext;a.font=h;f=a.measureText("0").width;var p=c-f/2-2*g,q=m/c;c=CMLog10(q*p);c=Math.ceil(c);c=Math.pow(10,c);var r=1;m="km";l==CMScaleBar.UNITS_ENGLISH&&(m="miles");l=this.GetSetting("UnitText","font","12px Arial");l=CMScaleBar.RemovePixels(l);l=""+d*n+"px "+l;a.font=l;for(var t=a.measureText(m).width,u=!1,v=0;0==u&&100>v;){1>c&&("km"==m||"miles"==m)&&("km"==m?(c*=1E3,m="m",q*=1E3):(c*=1E4,m="ft",q*=5280),a.font=l,t=a.measureText(m).width);
n=""+c;a.font=h;var w=a.measureText(n).width;n=c/q;n=w/2>t?n+w/2:n+t;n<p?u=!0:("m"==m||"ft"==m)&&.01>=c?u=!0:1==r?(r=5,c/=2):5==r?(r=2,c=2*c/5):(r=1,c/=2);v+=1}n=c/q;q=g+f/2;p=q+n;k=d-d*k;this.GetStyle(b,0,"Style");r=this.GetStyle(b,0,"Text");w=this.GetStyle(b,0,"UnitText");t=this.GetStyle(b,0,"ScaleBar");a.clearRect(0,0,this.TheCanvas.width,this.TheCanvas.height);b.RestoreStyle();b.SetStyle(w);a.font=l;a.fillText(m,q+n+g,k);b.RestoreStyle();b.SetStyle(t);a.beginPath();a.moveTo(q,k);a.lineTo(p,k);
a.stroke();d*=e;a.beginPath();a.moveTo(q,k);a.lineTo(q,k-d);a.stroke();a.beginPath();a.moveTo(p,k);a.lineTo(p,k-d);a.stroke();b.RestoreStyle();b.SetStyle(r);a.font=h;d=k-d-g;a.fillText("0",q-f/2,d);n=""+c;w=a.measureText(n).width;a.fillText(n,p-w/2,d);b.RestoreStyle()};CMGeo.NumGeos=0;CMGeo.PROJECTOR_NONE=0;CMGeo.PROJECTOR_COORDINATES=1;CMGeo.PROJECTOR_LOAD=1;CMGeo.PROJECTOR_DYNAMIC=2;
function CMGeo(a){CMItem.call(this);this.SetName("Geo"+CMGeo.NumGeos);CMGeo.NumGeos++;this.SetParent(a);this.Layers=[];this.Backgrounds=[];this.SelectedBackgroundIndex=-1;this.TheProjector=null;this.ProjectorType=CMGeo.PROJECTOR_NONE;this.MinTime=0;this.SetSetting("Style","fillStyle","rgb(210,220,255)");this.Times=[0];this.TheBounds=null;this.NumRepaintBlocks=0;this.NeedRepaint=!1}CMGeo.prototype=Object.create(CMItem.prototype);CMGeo.prototype.contructor=CMGeo;CMGeo.prototype.GetTimes=function(a){return this.Times};
CMGeo.prototype.GetNumChildren=function(a){a=0;void 0!=this.Layers&&(a=this.Layers.length);return a};CMGeo.prototype.GetChild=function(a,b){return this.Layers[a]};CMGeo.prototype.AddBackground=function(a){a.SetParent(this);var b=this.Backgrounds.length;this.Backgrounds[b]=a;-1==this.SelectedBackgroundIndex&&(this.SelectedBackgroundIndex=0);this.GetParent(CMScene).BackgroundListChanged();return b};
CMGeo.prototype.SetSelectedBackgroundIndex=function(a){a!=this.SelectedBackgroundIndex&&(-1!=this.SelectedBackgroundIndex&&this.Backgrounds[this.SelectedBackgroundIndex].SetVisible(!1),this.SelectedBackgroundIndex=a,-1!=a&&this.Backgrounds[a].SetVisible(!0),this.GetParent(CMScene).BackgroundListChanged(),this.Repaint())};CMGeo.prototype.GetNumBackgrounds=function(){return this.Backgrounds.length};CMGeo.prototype.GetBackground=function(a){return this.Backgrounds[a]};
CMGeo.prototype.AddLayer=function(a){a.SetParent(this);var b=this.Layers.length;this.Layers[b]=a;a=a.GetTimes(this.Times);for(Time in a)-1==this.Times.indexOf(Time)&&this.InsertTime(Time);this.GetParent(CMScene).LayerListChanged();return b};CMGeo.prototype.GetLayerIndex=function(a){for(var b=-1,c=0;c<this.Layers.length;c++)this.Layers[c]==a&&(b=c);return b};CMGeo.prototype.GetLayer=function(a){return this.Layers[a]};
CMGeo.prototype.MoveLayerUp=function(a){var b=this.Layers[a];0<=a&&(this.Layers[a]=this.Layers[a-1],this.Layers[a-1]=b);this.GetParent(CMScene).LayerListChanged();this.Repaint()};CMGeo.prototype.MoveLayerDown=function(a){var b=this.Layers[a];a<this.Layers.length&&(this.Layers[a]=this.Layers[a+1],this.Layers[a+1]=b);this.GetParent(CMScene).LayerListChanged();this.Repaint()};CMGeo.prototype.DeleteLayer=function(a){a=this.Layers.splice(a,1);this.GetParent(CMScene).LayerListChanged();this.Repaint();return a};
CMGeo.prototype.MoveLayer=function(a,b){var c=this.GetLayerIndex(a);0>b&&(b=0);b>=this.Layers.length&&(b=this.Layers.length-1);if(b<c){for(;c>b;c--)this.Layers[c]=this.Layers[c-1];this.Layers[b]=a}else if(b>c){for(;c<b;c++)this.Layers[c]=this.Layers[c+1];this.Layers[b]=a}this.GetParent(CMScene).LayerListChanged();this.Repaint()};CMGeo.prototype.GetSearchResults=function(a,b){for(var c=this.GetNumChildren(CMLayer),d=0;d<c;d++)this.GetChild(d,CMLayer).GetSearchResults(a,b)};
CMGeo.prototype.ProjectionChanged=function(){for(var a=this.GetNumChildren(CMLayer),b=0;b<a;b++)this.GetChild(b,CMLayer).ProjectionChanged()};CMGeo.prototype.In=function(a,b,c,d){for(var e=null,f=this.GetNumChildren(CMLayer)-1;0<=f&&null==e;f--){var g=this.GetChild(f).In(a,b,c,d);-1!=g&&(e={LayerIndex:f,FeatureIndex:g})}return e};CMGeo.prototype.MouseDown=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMLayer)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseDown(a,b,c,d);return e};
CMGeo.prototype.MouseMove=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMLayer)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseMove(a,b,c,d);return e};CMGeo.prototype.MouseUp=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMLayer)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseUp(a,b,c,d);return e};CMGeo.prototype.Resize=function(a){for(var b=this.GetNumChildren(CMLayer),c=0;c<b;c++)this.GetChild(c).Resize(a);this.Repaint()};
CMGeo.prototype.Paint=function(a){if("undefined"==typeof CM3View||0==a instanceof CM3View){var b=this.GetStyle(a,0,"Style");if(void 0!=b){a.SetStyle(b);if(null!=this.TheProjector){b=this.TheProjector.GetRegionToFill();var c=this.TheProjector.GetRegionToDraw();a.PaintRefRegion(b,!1,!0,!1);a.PaintRefRegion(c,!1,!1,!0)}a.RestoreStyle()}}-1!=this.SelectedBackgroundIndex&&this.Backgrounds[this.SelectedBackgroundIndex].Paint(a);b=this.GetNumChildren(CMLayer);for(c=0;c<b;c++){var d=this.GetChild(c);d.Paint(a)}for(c=
0;c<b;c++)d=this.GetChild(c),d.PaintSelected(a)};CMGeo.prototype.SetProjector=function(a){this.TheProjector=a;a.AddListener(CMBase.MESSAGE_SETTINGS_CHANGED,this,function(a,c,d){a=c.GetNumChildren(CMLayer);for(d=0;d<a;d++)c.GetChild(d).ProjectorChanged()})};CMGeo.prototype.GetProjector=function(){return this.TheProjector};CMGeo.prototype.SetProjectorType=function(a){this.ProjectorType=a};CMGeo.prototype.GetProjectorType=function(){return this.ProjectorType};
CMGeo.prototype.SetBoundsDirty=function(){this.TheBounds=null};CMGeo.prototype.GetBounds=function(){var a=this.GetNumChildren(CMLayer);if(0<a&&null==this.TheBounds)for(var b=0;b<a;b++){var c=this.GetChild(b,CMLayer),d=c.GetBounds();null==this.TheBounds&&null!=d?this.TheBounds=CMUtilities.CloneBounds(d):null!=c.TheBounds&&CMUtilities.AddToBounds(this.TheBounds,d)}return this.TheBounds};CMGeo.prototype.InsertTime=function(a){a=parseFloat(a);CMUtilities.InsertIntoSortedArray(this.Times,a);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};
CMGeo.prototype.DeleteTime=function(a){a=parseFloat(a);a=this.Times.indexOf(a);-1!=a&&this.Times.splice(a,1);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};CMGeo.prototype.CMItem_UnselectAll=CMItem.prototype.UnselectAll;CMGeo.prototype.UnselectAll=function(a){this.CMItem_UnselectAll(a);for(var b=this.GetNumChildren(CMLayer),c=0;c<b;c++)this.GetChild(c).UnselectAll(a)};function CMRenderScenes(){for(var a=0;a<CMScene.TheScenes.length;a++){var b=CMScene.TheScenes[a],c=b.GetView(0);b.Paint(c)}requestAnimationFrame(CMRenderScenes)}requestAnimationFrame(CMRenderScenes);CMScene.TheScenes=[];CMScene.NumScenes=0;CMScene.MESSAGE_LAYER_LIST_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_LAYER_CONTENT_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_LAYER_SETTINGS_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_BACKGROUNDS_CHANGED=CMBase.GetUniqueNumber();
CMScene.MESSAGE_TIME_SLICES_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_TIME_RANGE_CHANGED=CMBase.GetUniqueNumber();CMScene.MESSAGE_SELECTION_CHANGED=CMBase.GetUniqueNumber();
function CMScene(a){CMItem.call(this);CMScene.TheScenes.push(this);CMScene.NumScenes++;this.SetParent(a);this.Views=[];this.Geos=null;this.MinTime=0;this.Times=[0];this.TheBounds=null;this.NumRepaintBlocks=0;this.NeedRepaint=!1;this.SetSetting("Style","fillStyle","rgb(210,220,255)");this.SetName("Scene_"+CMScene.NumScenes)}CMScene.prototype=Object.create(CMItem.prototype);CMScene.prototype.contructor=CMScene;CMScene.prototype.GetView=function(a){void 0==a&&(a=0);return this.Views[a]};
CMScene.prototype.GetNumViews=function(){return this.Views.length};CMScene.prototype.SetView=function(a,b){b.SetParent(this);this.Views[a]=b};CMScene.prototype.GetTimes=function(a){return this.Times};CMScene.prototype.GetNumChildren=function(a){a=0;null!=this.Geos&&(a=this.Geos.length);return a};CMScene.prototype.GetChild=function(a,b){return this.Geos[a]};CMScene.prototype.AddBackground=function(a){return this.Geos[0].AddBackground(a)};CMScene.prototype.SetSelectedBackgroundIndex=function(a){this.Geos[0].SetSelectedBackgroundIndex(a)};
CMScene.prototype.SetGeo=function(a,b){void 0==b&&(b=0);null==this.Geos&&(this.Geos=[]);this.Geos[b]=a};CMScene.prototype.GetGeo=function(a){void 0==a&&(a=0);return this.Geos[a]};CMScene.prototype.AddLayer=function(a,b){void 0==b&&(b=0);return this.Geos[b].AddLayer(a)};CMScene.prototype.GetLayerIndex=function(a,b){void 0==b&&(b=0);return this.Geos[b].GetLayerIndex(a)};CMScene.prototype.GetLayer=function(a,b){void 0==b&&(b=0);return this.Geos[b].GetLayer(a)};
CMScene.prototype.MoveLayerUp=function(a,b){void 0==b&&(b=0);this.Geos[b].MoveLayerUp(a)};CMScene.prototype.MoveLayerDown=function(a,b){void 0==b&&(b=0);this.Geos[b].MoveLayerDown(a)};CMScene.prototype.DeleteLayer=function(a,b){void 0==b&&(b=0);return this.Geos[b].DeleteLayer(a)};CMScene.prototype.MoveLayer=function(a,b,c){void 0==c&&(c=0);this.Geos[c].MoveLayer(a,b)};CMScene.prototype.GetSearchResults=function(a,b){this.Geos[0].GetSearchResults(a,b)};CMScene.prototype.AddMapElement=function(a){this.Views[0].AddMapElement(a)};
CMScene.prototype.AddView=function(a){this.SetView(this.Views.length,a);this.SetTimeRange(0)};CMScene.prototype.SetTimeRange=function(a){this.MinTime=a;this.SendMessageToListeners(CMScene.MESSAGE_TIME_RANGE_CHANGED)};CMScene.prototype.GetTimeRange=function(){return this.MinTime};CMScene.prototype.In=function(a,b,c,d){for(var e=null,f=this.GetNumChildren(CMGeo)-1;0<=f&&null==e;f--)e=this.GetChild(f).In(a,b,c,d),null!=e&&(e.GeoIndex=f);return e};
CMScene.prototype.MouseDown=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMGeo)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseDown(a,b,c,d);return e};CMScene.prototype.MouseMove=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMGeo)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseMove(a,b,c,d);return e};CMScene.prototype.MouseUp=function(a,b,c,d){for(var e=!1,f=this.GetNumChildren(CMGeo)-1;0<=f&&0==e;f--)e=this.GetChild(f).MouseUp(a,b,c,d);return e};
CMScene.prototype.Resize=function(a){for(var b=this.GetNumChildren(CMGeo),c=0;c<b;c++)this.GetChild(c).Resize(a);for(c=0;c<this.Views.length;c++)this.Views[c].Resize();this.Repaint()};
CMScene.prototype.Paint=function(a){var b=this.NeedRepaint;"undefined"!==typeof CM3Scene&&this instanceof CM3Scene&&(b=!0);if(0==this.NumRepaintBlocks&&b){this.GetParent(CMMainContainer).AddToDebugPanel("CMScene.Paint Starting:"+CMUtilities.GetSeconds());this.NeedRepaint=!1;this.IncrementRepaintBlocks();a.PaintStart();b=this.GetStyle(a,0);void 0!=b&&(a.SetStyle(b),a.PaintBackground(),a.RestoreStyle());b=this.GetNumChildren(CMGeo);for(var c=0;c<b;c++)this.GetChild(c).Paint(a);a.PaintEnd();this.DecrementRepaintBlocks();
this.GetParent(CMMainContainer).AddToDebugPanel("CMScene.Paint Done: "+CMUtilities.GetSeconds());this.NeedRepaint&&this.Repaint()}else this.GetParent(CMMainContainer).AddToDebugPanel("CMScene.Paint NeedRepaint=true: "+CMUtilities.GetSeconds())};CMScene.prototype.Repaint=function(){if(null!=this.Views)for(var a=0;a<this.Views.length;a++)this.NeedRepaint=!0};CMScene.prototype.IncrementRepaintBlocks=function(){this.NumRepaintBlocks++};CMScene.prototype.DecrementRepaintBlocks=function(){this.NumRepaintBlocks--};
CMScene.prototype.LayerListChanged=function(){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_LIST_CHANGED,this)};CMScene.prototype.LayerContentChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_CONTENT_CHANGED,a)};CMScene.prototype.LayerSettingsChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_LAYER_SETTINGS_CHANGED,a);this.Repaint()};CMScene.prototype.SelectionChanged=function(a){this.SendMessageToListeners(CMScene.MESSAGE_SELECTION_CHANGED,a);this.Repaint()};
CMScene.prototype.BackgroundListChanged=function(){this.SendMessageToListeners(CMScene.MESSAGE_BACKGROUNDS_CHANGED,this)};CMScene.prototype.SetProjector=function(a){null!=this.Geos?this.Geos[0].SetProjector(a):alert("Sorry, the Geo must be setup before the projector can be set")};CMScene.prototype.GetProjector=function(){var a=null;null!=this.Geos&&(a=this.Geos[0].GetProjector());return a};CMScene.prototype.SetBoundsDirty=function(){this.TheBounds=null};
CMScene.prototype.GetBounds=function(){var a=this.GetNumChildren(CMGeo);if(0<a&&null==this.TheBounds)for(var b=0;b<a;b++){var c=this.GetChild(b,CMGeo).GetBounds();null!=c&&(null==this.TheBounds?this.TheBounds=CMUtilities.CloneBounds(c):CMUtilities.AddToBounds(this.TheBounds,c))}return this.TheBounds};CMScene.prototype.InsertTime=function(a){a=parseFloat(a);CMUtilities.InsertIntoSortedArray(this.Times,a);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};
CMScene.prototype.DeleteTime=function(a){a=parseFloat(a);a=this.Times.indexOf(a);-1!=a&&this.Times.splice(a,1);this.SendMessageToListeners(CMScene.MESSAGE_TIME_SLICES_CHANGED)};CMScene.prototype.CMItem_UnselectAll=CMItem.prototype.UnselectAll;CMScene.prototype.UnselectAll=function(a){this.CMItem_UnselectAll(a);for(var b=this.GetNumChildren(CMGeo),c=0;c<b;c++)this.GetChild(c).UnselectAll(a)};CMTile.UPPER_RIGHT=-1;CMTile.LOWER_RIGHT=-2;CMTile.LOWER_LEFT=-3;CMTile.UPPER_LEFT=-4;CMTile.NumTilesLoaded=0;function CMTile(a,b,c,d){this.GlobalRow=d;this.GlobalColumn=c;this.ZoomLevel=b;this.ChildTiles=this.TheRasterRequest=this.TheRaster=this.TheData=null;this.TheDataset=a;this.LoadStatus=CMDataset.LOAD_STATUS_NONE;this.TheRequest=null;this.PaintTileInfo=!1;this.TheMesh=null;this.MeshIsInGeo=!1}
CMTile.prototype.GetTileImageFilePath=function(a){return this.TheDataset.URL+("Tiles_"+this.ZoomLevel+"/"+this.GlobalColumn+"/"+this.GlobalRow+a)};
CMTile.prototype.LoadTileRaster=function(){this.TheRaster=new Image;this.TheRaster.TheTile=this;var a=this.GetTileImageFilePath(".png");this.TheRasterRequest={LoadStatus:CMDataset.LOAD_STATUS_NONE,Type:CMDataset.REQUEST_TYPE_IMAGE,TheImage:this.TheRaster,src:a,TheFunction:function(){this.TheTile.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_TILE_LOADED,this.TheTile)}};this.TheRasterRequest.TheTile=this;CMDataset.MakeRequest(this.TheRasterRequest)};
CMTile.GetDistanceToView=function(a,b){var c=a.GetPosition();a=c.x-(b.XMin+b.XMax)/2;b=c.y+(b.YMin+b.YMax)/2;c=c.z-0;return Math.sqrt(a*a+b*b+c*c)};
CMTile.prototype.CheckPaintTile=function(a,b){var c=!1;if(this.TheDataset.PaintDebugTile)this.TheDataset.DebugZoomLevel==this.ZoomLevel&&this.TheDataset.DebugGlobalColumn==this.GlobalColumn&&this.TheDataset.DebugGlobalRow==this.GlobalRow&&(c=!0);else if(0==c&&("undefined"!=typeof CM3View&&a instanceof CM3View?CMTile.GetDistanceToView(a,this.GetTileExtent())>2*b&&(c=!0):256>=a.GetPixelWidthFromRefWidth(b)&&(c=!0),null==this.ChildTiles&&(c=!0),0==c&&0<this.TheData.NumChildTiles)){for(b=NumLoadedChildTiles=
0;2>b;b++)for(var d=0;2>d;d++)if(0<this.TheData.ChildTiles[b][d]){var e=this.ChildTiles[b][d];e.LoadStatus==CMDataset.LOAD_STATUS_NONE?(e.LoadTile(a),c=!0):e.LoadStatus==CMDataset.LOAD_STATUS_LOADING?c=!0:"Features"in this.TheData?NumLoadedChildTiles++:"FillColor"in this.TheData?NumLoadedChildTiles++:"RasterExtension"in this.TheData?this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?NumLoadedChildTiles++:this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster():
"NumClusters"in this.TheData?NumLoadedChildTiles++:"RasterData"in this.TheData&&NumLoadedChildTiles++}else 0==this.TheData.ChildTiles[b][d]&&NumLoadedChildTiles++;4>NumLoadedChildTiles&&(c=!0)}return c};
CMTile.prototype.GetPolygonCoordinates=function(a,b,c,d){Result=null;var e=1/Math.pow(2,this.ZoomLevel)*256,f=this.GlobalColumn*e,g=this.GlobalRow*e,h=f+e;e=g+e;b=b.Polys[c];if(b.Closed&&1==b.EdgeIndexes.length){c=b.EdgeIndexes[0];try{var k=a[c];Result={Xs:k.Xs,Ys:k.Ys}}catch(u){throw u;}null!=d&&(d[c]=!0)}else{k=[];for(var l=[],m=0,n=0;n<b.EdgeIndexes.length;n++){c=b.EdgeIndexes[n];var p=!0;void 0!=b.EdgeDirections&&(p=b.EdgeDirections[n]);if(0<=c){for(var q=a[c].Xs,r=a[c].Ys,t=0;t<q.length;t++)p?
(k[m]=q[t],l[m]=r[t]):(k[m]=q[q.length-t-1],l[m]=r[q.length-t-1]),m++;null!=d&&(d[c]=!0)}else switch(c){case CMTile.UPPER_RIGHT:k[m]=h;l[m]=e;m++;break;case CMTile.LOWER_RIGHT:k[m]=h;l[m]=g;m++;break;case CMTile.LOWER_LEFT:k[m]=f;l[m]=g;m++;break;case CMTile.UPPER_LEFT:k[m]=f,l[m]=e,m++}}Result={Xs:k,Ys:l}}return Result};CMTile.prototype.GetTileExtent=function(){var a=1/Math.pow(2,this.ZoomLevel)*256,b=this.GlobalColumn*a,c=this.GlobalRow*a;return{XMin:b,XMax:b+a,YMax:c+a,YMin:c}};
CMTile.prototype.GetDataForTextureTile=function(a,b,c){var d=null;if(this.LoadStatus==CMDataset.LOAD_STATUS_NONE)this.LoadTile(a);else if(this.LoadStatus==CMDataset.LOAD_STATUS_LOADED){var e=b.GetTileExtent(),f=this.GetTileExtent();if(CMUtilities.BoundsIncludes(f,e))null!=this.DatasetRaster&&(d=CMTile.GetSubSample(e,this,c));else for(e=0;2>e&&0==d;e++)for(Column=0;2>Column&&0==d;Column++)d=this.Tiles[e][Column].GetDataForTextureTile(a,b,c)}return d};
CMTile.prototype.SetupMaterial=function(a){var b=new THREE.TextureLoader,c=new THREE.MeshLambertMaterial({color:16777215,side:THREE.DoubleSide,opacity:1,transparent:!1});c.map=b.load(a);return c};
CMTile.GetSubSample=function(a,b,c){var d=b.GetData(),e=d.RasterData.Bounds;b=d.RasterData.Data;d=d.RasterData.Mask;var f=(e.XMax-e.XMin)/b[0].length,g=(e.YMax-e.YMin)/b.length,h=a.XMax-a.XMin,k=a.YMax-a.YMin,l=CMUtilities.Truncate((a.XMin-e.XMin)/f);e=CMUtilities.Truncate((a.YMin-e.YMin)/g);f=h/(64*f);h/=64;k/=64;g=[];for(var m=[],n=0;64>=n;n++){g[n]=[];m[n]=[];for(var p=a.YMin+n*k,q=0;64>=q;q++){var r=a.XMin+q*h;try{var t=256-(e+n*f);t=Math.floor(t);255<t&&(t=255);0>t&&(t=0);var u=l+q*f;u=Math.floor(u);
255<u&&(u=255);0>u&&(u=0);var v=b[t][u];v*=c;-0==v&&(v=0);g[n][q]=[];g[n][q][0]=r;g[n][q][1]=p;g[n][q][2]=v;m[n][q]=d[t][u]}catch(w){}}}return[g,m]};
CMTile.prototype.LoadTile=function(){var a="Tiles_"+this.ZoomLevel+"/"+this.GlobalColumn+"/"+this.GlobalRow+".js",b=this.TheDataset.URL+a,c=new XMLHttpRequest;this.TheRequest=c;c.open("GET",b,!0);c.TheURL=b;c.TheDataset=this.TheDataset;c.TheTile=this;c.FileName=a;this.LoadStatus=CMDataset.LOAD_STATUS_LOADING;c.onreadystatechange=function(){if(4==this.readyState)if(200==this.status){var a=JSON.parse(this.responseText),b=this.TheTile;CMTile.NumTilesLoaded++;b.TheData=a;b.LoadStatus=CMDataset.LOAD_STATUS_LOADED;
"RasterExtension"in b.TheData&&b.LoadTileRaster();"RasterData"in b.TheData&&(b.DatasetRaster=new CMDatasetRaster,a=this.TheDataset.MinPixelValues,b.TheData.RasterData.MaxPixelValues=this.TheDataset.MaxPixelValues,b.TheData.RasterData.MinPixelValues=a,b.DatasetRaster.SetData(b.TheData.RasterData));if(0<b.TheData.NumChildTiles)for(a=0;2>a;a++)for(var c=0;2>c;c++)if(0<b.TheData.ChildTiles[a][c]){null==b.ChildTiles&&(b.ChildTiles=[],b.ChildTiles[0]=[null,null],b.ChildTiles[1]=[null,null]);var g=new CMTile(this.TheDataset,
b.ZoomLevel+1,2*b.GlobalColumn+c,2*b.GlobalRow+(1-a));this.PaintTileInfo&&g.SetPaintTileInfo(this.PaintTileInfo);b.ChildTiles[a][c]=g}b.TheDataset.SendMessageToListeners(CMDataset.MESSAGE_DATASET_TILE_LOADED,b)}else alert("HTTP error "+this.status+" "+this.statusText+" ("+this.TheURL+")")};c.send()};
CMTile.prototype.AddToFeatureBounds=function(a,b){if("Features"in this.TheData)for(var c=this.TheData.Features,d=this.TheData.TheEdges,e=!1,f=0;f<c.length&&0==e;f++){var g=c[f];if(g.LayerFeatureIndex==a){e=!0;g=g.Areas;for(var h=0;h<g.length;h++)for(var k=g[h],l=k.Polys,m=0;m<l.length;m++){var n=this.GetPolygonCoordinates(d,k,m,null);n=CMUtilities.GetPolygonBounds(n.Xs,n.Ys,n.Xs.length);b=CMUtilities.AddToBounds(b,n)}}}if("NumClusters"in this.TheData)for(a=this.TheData.NumClusters,c=this.TheData.ClusterCoordinates,
f=0;f<a&&0==e;f++)d=c[0][f],g=c[1][f],b=CMUtilities.AddToBounds(b,{XMax:d,XMin:d,YMax:g,YMin:g});return b};
CMTile.prototype.In=function(a,b,c,d){var e=-1;if(null!=this.TheData&&"Features"in this.TheData){a=a.GetExtent();var f=this.GetTileExtent();f=CMUtilities.CloneBounds(f);CMUtilities.ExpandBounds(f,d);if(CMUtilities.BoundsOverlap(a,f)){a=this.TheData.Features;f=this.TheData.Edges;for(var g=0;g<a.length&&-1==e;g++)for(var h=a[g],k=h.Areas,l=0;l<k.length&&-1==e;l++)for(var m=k[l],n=m.Polys,p=0;p<n.length&&-1==e;p++){var q=m.Polys[p],r=this.GetPolygonCoordinates(f,m,p,null);if(q.Closed?CMUtilities.InsideAPolygon(b,
c,r.Xs,r.Ys,r.Xs.length):CMUtilities.InPolyline(b,c,r.Xs,r.Ys,d))e=h.LayerFeatureIndex}if(-1==e&&0<this.TheData.NumChildTiles)for(b=0;2>b;b++)for(c=0;2>c;c++);}}return e};
CMTile.prototype.MouseDown=function(a,b,c,d){var e=!1;if(null!=this.TheData&&(a.GetTool()==CMView.TOOL_INFO||a.GetTool()==CMView.TOOL_SELECT)){if("Features"in this.TheData||"NumClusters"in this.TheData){var f=this.In(a,b,c,d);-1!=f&&(this.TheDataset.ShowInfoWindow(f,a,b,c),e=!0)}else if("RasterExtension"in this.TheData&&null!=this.TheRaster){var g=this.TheDataset.TileRefWidth/Math.pow(2,this.ZoomLevel),h=this.GlobalRow*g;f=parseInt((b-this.GlobalColumn*g)/g*256);g=parseInt((h-c)/g*256);0<=f&&256>
f&&0<=g&&256>g&&(e="Pixel X:"+f+" Y: "+g,h=document.createElement("canvas"),h.width=this.TheRaster.width,h.height=this.TheRaster.height,h=h.getContext("2d"),h.drawImage(this.TheRaster,0,0),f=h.getImageData(f,g,1,1),e+=" Value:"+f.data[0]+","+f.data[1]+","+f.data[2],e=a.CreateInfoWindow("CMTile.InfoWindow",b,c,200,30,e),CMMainContainer.SetPopupWindow(e),e=!0)}if(0==e&&0<this.TheData.NumChildTiles)for(f=0;2>f;f++)for(g=0;2>g;g++)0<this.TheData.ChildTiles[f][g]&&(e=this.ChildTiles[f][g].MouseDown(a,
b,c,d))}return e};
CMTile.prototype.PaintTile=function(a,b,c,d){var e=0,f=this.GlobalColumn*d,g=this.GlobalRow*d,h=this.GetTileExtent(),k=!0;if("undefined"!=typeof CM3View&&b instanceof CM3View){if(a.GetVisible()&&null!=this.TheData){if((k=this.CheckPaintTile(b,d))&&"RasterExtension"in this.TheData&&0==this.MeshIsInGeo){if(null==this.TheMesh){h=a.GetDEMDataset();var l=a.GetSetting("Elevation","Exaggeration",1);h=h.GetDataForTextureTile(b,this,l);null!=h&&(l=h[0],h=new CM3SurfaceGeometry(l[0].length-1,l.length-1,h[1]),
h.SetPositions(l),l=this.GetTileImageFilePath(".png"),l=this.SetupMaterial(l),this.TheMesh=new THREE.Mesh(h,l))}null!=this.TheMesh&&(h=a.GetParent(CMGeo),h.AddOGLObjectToGeo(this.TheMesh),this.MeshIsInGeo=!0)}0==k&&this.MeshIsInGeo&&(h=a.GetParent(CMGeo),h.RemoveOGLObjectFromGeo(this.TheMesh),this.MeshIsInGeo=!1)}}else if(CMUtilities.BoundsOverlap(h,b.GetExtent())&&null!=this.TheData){k=this.CheckPaintTile(b,d);var m=0;if(k){if("Features"in this.TheData){var n=this.TheData.Features,p=this.TheData.Edges;
for(l=0;l<n.length;l++){b.GetExtent();for(var q=n[l].Areas,r=0;r<q.length;r++)for(var t=q[r],u=t.Polys,v=0;v<u.length;v++)if(u[v].Closed){var w=this.GetPolygonCoordinates(p,t,v,null);if(2<w.Xs.length){w=[w.Xs,w.Ys];w=[w];var x=CMDatasetVector.TYPE_POLYLINES;u[v].Closed&&(x=CMDatasetVector.TYPE_POLYGONS);a.PaintRefArea(b,l,w,x,!1,!1)}}}if(void 0!=p)for(n=0;n<p.length;n++)q=p[n].Xs,r=p[n].Ys,2<q.length&&(w=[q,r],w=[w],a.PaintRefArea(b,l,w,CMDatasetVector.TYPE_POLYLINES,!1,!1))}"RasterExtension"in this.TheData&&
null!=this.TheRasterRequest&&(this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_LOADED?b.PaintRefImageScaled(this.TheRaster,f,g+d,d,-d):this.TheRasterRequest.LoadStatus==CMDataset.LOAD_STATUS_CANCELED&&this.LoadTileRaster());"FillColor"in this.TheData&&(l=this.TheData.TheColor,null!==l&&(l={fillStyle:""+("rgb("+l[0]+","+l[1]+","+l[2]+")")+"",lineWidth:0},null!=l&&b.SetStyle(l),b.PaintRefBounds(h),null!=l&&b.RestoreStyle()));"RasterData"in this.TheData&&this.DatasetRaster.Paint(b);if("NumClusters"in
this.TheData)for(h=this.TheData.NumClusters,p=this.TheData.ClusterCoordinates,l=0;l<h;l++)b.PaintRefCircle(p[0][l],p[1][l],10)}}if(null!=this.TheData){k&&this.PaintTileInfo&&(l={font:"20px Arial",fillStyle:"red",lineWidth:1,strokeColor:"red",strokeStyle:"#000"},null!=l&&b.SetStyle(l),b.PaintRefText(this.ZoomLevel+"_"+this.GlobalColumn+"_"+this.GlobalRow,f+d/2,g+d/2,20),b.PaintRefLine(f,g,f,g+d),b.PaintRefLine(f+d,g,f+d,g+d),b.PaintRefLine(f,g,f+d,g),b.PaintRefLine(f,g+d,f+d,g+d),null!=l&&b.RestoreStyle());
if(0==k&&0<this.TheData.NumChildTiles)for(f=0;2>f;f++)for(g=0;2>g;g++)0<this.TheData.ChildTiles[f][g]&&(m+=this.ChildTiles[f][g].PaintTile(a,b,c,d/2));e++}return e};CMTile.prototype.SetPaintTileInfo=function(a){this.PaintTileInfo=a};CMTile.prototype.GetData=function(){return this.TheData};function CMUtilities(){}CMUtilities.COORDINATE_UNITS_DD=0;CMUtilities.COORDINATE_UNITS_DMS=1;CMUtilities.COORDINATE_UNITS_METERS=2;CMUtilities.COORDINATE_UNITS_FEET=3;CMUtilities.COORDINATE_UNITS_PIXELS=4;CMUtilities.COORDINATE_UNITS_ZOOM=5;CMUtilities.QUANTILES=1;CMUtilities.IsDefined=function(a){var b=!0;if(void 0==a||null==a)b=!1;return b};CMUtilities.AbsolutePosition=function(a,b,c,d,e){a.style.position="absolute";a.style.left=b+"px";a.style.top=c+"px";a.style.width=d+"px";a.style.height=e+"px"};
CMUtilities.GetPopupMenu=function(a,b,c){var d=document.getElementById("LayerPopupMenu");null==d&&(d=document.createElement("DIV"),d.className=a,d.id="LayerPopupMenu",document.body.appendChild(d));for(;d.firstChild;)d.removeChild(d.firstChild);this.ThePopupMenu=d;d.style.position="absolute";d.style.left=b+"px";d.style.top=c+"px";CMMainContainer.AddPopupWindow(d);d.style.visibility="visible";return d};
CMUtilities.GetElementCoordinate=function(a,b,c){c=c.getBoundingClientRect();return{x:Math.round(a-c.left),y:Math.round(b-c.top)}};CMUtilities.GetCSSHSL=function(a,b,c){return"hsl(240,50%,80%)"};CMUtilities.HSLToRGB=function(a,b,c){b*=1-Math.abs(2*c-1);var d=a/60,e=b*(1-Math.abs(d%2-1)),f;isNaN(a)?f=[0,0,0]:1>=d?f=[b,e,0]:2>=d?f=[e,b,0]:3>=d?f=[0,b,e]:4>=d?f=[0,e,b]:5>=d?f=[e,0,b]:6>=d&&(f=[b,0,e]);a=c-.5*b;return[Math.round(255*(f[0]+a)),Math.round(255*(f[1]+a)),Math.round(255*(f[2]+a))]};
CMUtilities.GetTwoDigitHex=function(a){a=parseInt(a);a=a.toString(16);2>a.length&&(a="0"+a);return a};CMUtilities.GetRGBColorFromNamedColor=function(a){a=$("<div></div>").appendTo("body").css("background-color",a);var b=window.getComputedStyle(a[0]).backgroundColor;a.remove();return b};
CMUtilities.GetRGBAValuesFromRGBA=function(a){var b={Red:255,Green:255,Blue:255,Transparency:1};if("undefined"!=typeof a){if(-1<a.indexOf("rgb")){var c=a.indexOf("(");a=a.substring(c+1);c=a.indexOf(")");a=a.substring(0,c)}a=a.split(",");b.Red=parseFloat(a[0]);b.Green=parseFloat(a[1]);b.Blue=parseFloat(a[2]);3<a.length&&(b.Transparency=parseFloat(a[3]))}return b};
CMUtilities.GetHexFromRGB=function(a){var b=CMUtilities.GetRGBAValuesFromRGBA(a);a=CMUtilities.GetTwoDigitHex(b.Red);var c=CMUtilities.GetTwoDigitHex(b.Green);b=CMUtilities.GetTwoDigitHex(b.Blue);return"#"+a+c+b};CMUtilities.GetHexColorFromColor=function(a){void 0!=a&&(a=""+a,-1<a.indexOf("rgb")?a=CMUtilities.GetHexFromRGB(a):"0"<=a.charAt(0)&&"9">=a.charAt(0)?a=CMUtilities.GetHexFromRGB(a):-1==a.indexOf("#")&&(a=CMUtilities.GetRGBColorFromNamedColor(a),a=CMUtilities.GetHexFromRGB(a)));return a};
CMUtilities.GetRGBFromHex=function(a){var b=a.substring(1,3),c=a.substring(3,5);a=a.substring(5,7);return{Red:parseInt(b,16),Green:parseInt(c,16),Blue:parseInt(a,16),Transparency:1}};
CMUtilities.GetColorsFromAnyColor=function(a,b){var c={Red:255,Green:255,Blue:255};void 0!=a&&(a=""+a,-1<a.indexOf("rgb")?c=CMUtilities.GetRGBAValuesFromRGBA(a):"0"<=a.charAt(0)&&"9">=a.charAt(0)?(a=a.split(","),c.Red=parseFloat(a[0]),c.Green=parseFloat(a[1]),c.Blue=parseFloat(a[2]),3<a.length&&(c.Transparency=parseFloat(a[3]))):-1!=a.indexOf("#")?c=CMUtilities.GetRGBFromHex(a):-1==a.indexOf("#")&&(c=CMUtilities.GetRGBColorFromNamedColor(a),c=CMUtilities.GetRGBAValuesFromRGBA(c)),void 0!=b&&(c.Transparency=
b));return c};CMUtilities.GetRGBAFromAnyColor=function(a,b){a=CMUtilities.GetColorsFromAnyColor(a,b);return a=void 0==a.Transparency?"rgb("+a.Red+","+a.Green+","+a.Blue+")":"rgba("+a.Red+","+a.Green+","+a.Blue+","+a.Transparency+")"};
CMUtilities.GetColorsFromArrays=function(a,b,c){for(var d=CMUtilities.GetHistogram(a,1E3),e=[],f=[],g=[],h=0;h<b.length;h++){var k=CMUtilities.GetRGBFromHex(b[h]);e[h]=k.Red;f[h]=k.Green;g[h]=k.Blue}k=[];var l=[];if(void 0!=c){for(h=0;h<a.length;h++){var m=0;for(b=a[h];b>c[m+1]&&m<c.length-1;)m++;m>=e.length&&(m=e.length-1);var n=e[m],p=f[m];m=g[m];m="rgb("+n+","+p+","+m+")";k[h]=m}for(h=0;h<c.length;h++)l[h]=Math.round(c[h])+" to "+Math.round(c[h+1])}else{c=d.Min;d=d.Max-c;for(h=0;h<a.length;h++)m=
0,0!=d&&(m=parseInt((a[h]-c)/d*b.length)),n=e[m],p=f[m],m=g[m],m="rgb("+n+","+p+","+m+")",k[h]=m;for(h=0;h<b.length;h++)a=c+h*d,l[h]=a+" to "+(a+d)}return{LegendLabels:l,FeatureColors:k}};
CMUtilities.AddLegend=function(a,b,c,d,e,f,g){var h=document.createElement("DIV");var k="<div><table>";for(var l=0;l<b.length;l++)k+="<tr>",k+="<td>",k+="<div style='border:solid black 1px;background-color:"+b[l]+";width:12px;height:12px'></div>",k+="</td>",k+="<td>",k+="<div>"+c[l]+"</div>",k+="</td>",k+="<tr>";h.innerHTML=k+"</table>";a.appendChild(h);CMUtilities.AbsolutePosition(h,d,e,f,g);return h};CMUtilities.GetMean=function(a){for(var b=0,c=0;c<a.length;c++)b+=a[c];return b/a.length};
CMUtilities.GetStdDev=function(a){for(var b=CMUtilities.GetMean(a),c=0,d,e=0;e<a.length;e++)d=a[e]-b,c+=d*d;return Math.sqrt(c/(a.length-1))};CMUtilities.GetMinMax=function(a){for(var b,c,d,e=0;e<a.length;e++)b=a[e],0==e?d=c=b:(b<c&&(c=b),b>d&&(d=b));return{Min:c,Max:d}};
CMUtilities.GetHistogram=function(a,b){var c=CMUtilities.GetMinMax(a),d=c.Min;c=c.Max;for(var e=c-d,f=[],g=[],h=0;h<b;h++)f[h]=0,g[h]=d+e*h;if(0!=e)for(h=0;h<a.length;h++)Bin=Math.round((a[h]-d)/e*b),Bin>=b&&(Bin=b-1),f[Bin]++;return{Min:d,Max:c,Bins:f,Labels:g}};CMUtilities.GetQuantiles=function(a,b){for(var c=a.Bins,d=0,e=0;e<c.length;e++)d+=c[e];d/=b;b=(a.Max-a.Min)/b;var f=[];f[0]=a.Min;var g=d,h=0;for(e=0;e<c.length;e++)h+=c[e],h>=g&&(f.push(a.Min+b*e),g+=d);f.push(a.Max);return f};
CMUtilities.FlipArray=function(a){for(var b=[],c=a.length-1,d=0;d<=c;d++)b.push(a[c-d]);return b};CMUtilities.Sort=function(a){var b,c=a.length;for(b=!0;b;){b=!1;for(var d=0;d<c-1;d++)a[d+1]<a[d]&&(b=a[d],a[d]=a[d+1],a[d+1]=b,b=!0)}};CMUtilities.InsertIntoSortedArray=function(a,b,c){void 0==c&&(c=!1);var d=a.indexOf(b);if(-1!=d)c&&a.splice(d,0,b);else{for(d=0;d<a.length&&a[d]<b;)d++;a.splice(d,0,b)}};
CMUtilities.GetRegularPolygon=function(a,b,c,d,e){var f=null;if(0<a){f=[[],[]];var g=2*Math.PI/a;e=(e-180)*Math.PI*2/360;b=b/2/Math.cos(g/2);var h=e;for(var k=0;k<a;k++){e=b*Math.sin(h);var l=b*Math.cos(h);f[0][k]=c+e;f[1][k]=d+l;h+=g}}return f};
CMUtilities.GetStar=function(a,b,c,d,e){var f=null;if(0<a){f=[[],[]];var g=2*Math.PI/a/2;e=(e-180)*Math.PI*2/360;b=b/2/Math.cos(g/2);var h=b/2.5;var k=e;for(var l=0;l<a;l++){e=b*Math.sin(k);var m=b*Math.cos(k);f[0][2*l]=c+e;f[1][2*l]=d+m;k+=g;e=h*Math.sin(k);m=h*Math.cos(k);f[0][2*l+1]=c+e;f[1][2*l+1]=d+m;k+=g}}return f};CMUtilities.PositionControl=function(a,b,c,d){void 0!=b&&(a.style.position=b,a.style.left=c+"px",a.style.top=d+"px")};
CMUtilities.CreateSelectControl=function(a,b,c,d,e){for(var f=document.createElement("SELECT"),g=-1,h=0;h<a.length;h++){b==a[h]&&(g=h);var k=document.createElement("option");k.text=a[h];f.add(k)}-1!=g&&(f.selectedIndex=g);CMUtilities.PositionControl(f,c,d,e);return f};CMUtilities.CreateSliderControl=function(a,b,c,d,e,f){var g=document.createElement("input");g.type="range";g.min=a;g.max=b;g.value=c;CMUtilities.PositionControl(g,d,e,f);return g};
CMUtilities.CreateCheckboxControl=function(a,b,c,d){var e=document.createElement("input");e.type="checkbox";e.value=a;CMUtilities.PositionControl(e,b,c,d);return e};CMUtilities.CreateLabelControl=function(a,b,c,d){var e=document.createElement("div");e.innerHTML=a;CMUtilities.PositionControl(e,b,c,d);return e};
CMUtilities.CreateInfoWindow=function(a,b,c,d,e,f,g){e=document.getElementById(a);null!=e&&(document.body.removeChild(e),e=null);null==e&&(e=document.createElement("DIV"),e.id=a,document.body.appendChild(e));var h=window.innerHeight,k=$(window).scrollTop(),l=window.innerWidth,m=$(window).scrollLeft();a=!0;c<h/2&&(a=!1);var n=!1;b<l/2&&(n=!0);e.style.position="absolute";e.style.width=d+"px";e.style.left=n?b-28+m+"px":b+28+m-d+"px";a?e.style.bottom=h-c-k+10+"px":e.style.top=c+10+k+"px";b=document.createElement("div");
b.className="CM_InfoBox";b.innerHTML=f;b.style.padding="10px";e.appendChild(b);f=document.createElement("div");e.appendChild(f);f.style.position="absolute";n?f.style.left="20px":f.style.right="20px";0==a?(f.style.top="-13px",f.innerHTML="<img src='"+g+"Triangle_Up.png'></img>"):(f.style.bottom="-13px",f.innerHTML="<img src='"+g+"Triangle_Down.png'></img>");e.style.visibility="visible";return e};
CMUtilities.CreateInfoWindow2=function(a,b,c,d,e,f,g){d=document.getElementById(a);null!=d&&(document.body.removeChild(d),d=null);null==d&&(d=document.createElement("DIV"),d.className="CM_InfoContainer",d.id=a,document.body.appendChild(d));var h=window.innerHeight,k=$(window).scrollTop(),l=window.innerWidth,m=$(window).scrollLeft();a=!0;c<h/2&&(a=!1);e=!1;b<l/2&&(e=!0);e?d.style.left=b+m-20+"px":d.style.right=l-(b+m)-20+"px";a?d.style.bottom=h-c-k+"px":d.style.top=c+k+"px";b=document.createElement("div");
b.innerHTML=f;d.appendChild(b);f=document.createElement("div");a?(b.className="CM_InfoBoxAboveTriangle",f.innerHTML="<img src='../../../CanvasMap/Includes/"+g+"Triangle_Down.png'></img>",f.className=e?"CM_InfoArrowSW":"CM_InfoArrowSE"):(b.className="CM_InfoBoxBelowTriangle",f.innerHTML="<img src='../../../CanvasMap/Includes/"+g+"Triangle_Up.png'></img>",f.className=e?"CM_InfoArrowNW":"CM_InfoArrowNE");d.appendChild(f);d.style.visibility="visible";return d};
CMUtilities.InPolyline=function(a,b,c,d,e){var f=!1;if(void 0!=c)for(var g=c[0],h=d[0],k=1;k<c.length&&0==f;k++){var l=c[k],m=d[k];CMUtilities.DistanceToSegment(g,h,l,m,a,b)<=e&&(f=!0);g=l;h=m}return f};CMUtilities.GetSymbol=function(a,b){var c="N";b&&(c="E");0>a&&(c="S",b&&(c="W"));return c};
CMUtilities.GetDMSFromDD=function(a,b,c,d){b=CMUtilities.GetSymbol(a,b);0>a&&(a=-a);var e=Math.floor(a),f="\u00b0";!0===c&&(f="\u00b0");c=e+f;a=60*(a-e);e=Math.floor(a);if(!1===d||0!=e)if(c+=e+"' ",a=Math.floor(60*(a-e)),!1===d||0!=a)c+=a+'"';return c+(" "+b)};CMUtilities.GetDMSFromLonLat=function(a,b,c){a=CMUtilities.GetDMSFromDD(a,!0,c);return CMUtilities.GetDMSFromDD(b,!1,c)+" "+a};
CMUtilities.GetDMSFromLonLatJSObject=function(a,b){a=CMUtilities.GetDMSFromDD(a,!0);return{Latitude:CMUtilities.GetDMSFromDD(b,!1),Longitude:a}};CMUtilities.GetTextFromEastingNorthing=function(a,b){var c=CMUtilities.GetSymbol(a,!0),d=CMUtilities.GetSymbol(b,!1);0>a&&(a=-a);0>b&&(b=-b);return a+" "+c+" "+b+" "+d};
CMUtilities.BoundsIncludes=function(a,b){var c=!1;CMUtilities.IsDefined(a)&&CMUtilities.IsDefined(b)&&b.XMax<=a.XMax&&b.XMin>=a.XMin&&b.YMax<=a.YMax&&b.YMin>=a.YMin&&(void 0!=b.ZMin&&void 0!=a.ZMin?b.ZMin<=a.ZMax&&b.ZMax>=a.ZMin&&(c=!0):c=!0);return c};CMUtilities.BoundsOverlap=function(a,b){var c=!1;CMUtilities.IsDefined(a)&&CMUtilities.IsDefined(b)&&a.XMin<=b.XMax&&a.XMax>=b.XMin&&a.YMin<=b.YMax&&a.YMax>=b.YMin&&(void 0!=a.ZMin&&void 0!=b.ZMin?a.ZMin<=b.ZMax&&a.ZMax>=b.ZMin&&(c=!0):c=!0);return c};
CMUtilities.CloneBounds=function(a){var b={XMin:a.XMin,XMax:a.XMax,YMin:a.YMin,YMax:a.YMax};void 0!=a.ZMin&&(b.ZMin=a.ZMin,b.ZMax=a.ZMax);return b};CMUtilities.AddToBounds=function(a,b){null==a?a=b:null!=b&&(b.XMin<a.XMin&&(a.XMin=b.XMin),b.XMax>a.XMax&&(a.XMax=b.XMax),b.YMin<a.YMin&&(a.YMin=b.YMin),b.YMax>a.YMax&&(a.YMax=b.YMax),void 0!=b.ZMin&&(void 0==a.ZMin?(a.ZMin=b.ZMin,a.ZMax=b.ZMax):(b.ZMin<a.ZMin&&(a.ZMin=b.ZMin),b.ZMax>a.ZMax&&(a.ZMax=b.ZMax))));return a};
CMUtilities.ExpandBounds=function(a,b){a.XMin-=b;a.XMax+=b;a.YMin-=b;a.YMax+=b};
CMUtilities.DistanceToSegment=function(a,b,c,d,e,f){var g=(d-b)/(c-a),h=d-g*c,k=g*g+1,l=(-1*(-1*e-g*f)-g*h)/k;g=(g*(1*e+g*f)- -1*h)/k;b>d&&(h=b,b=d,d=h,h=a,a=c,c=h);h=null;g<b?h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b)):g>d?h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d)):g==b&&g==d&&(a<c?l<a?h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b)):l>c&&(h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d))):l<c?h=Math.sqrt((e-c)*(e-c)+(f-d)*(f-d)):l>a&&(h=Math.sqrt((e-a)*(e-a)+(f-b)*(f-b))));null===h&&(h=Math.sqrt((l-e)*(l-e)+(g-f)*(g-f)));return h};
CMUtilities.GetLineFactors=function(a,b,c,d){var e=[2];b==d?(a=b,c=0):a==c?(c=Double.POSITIVE_INFINITY,a=Double.NaN):(c=(d-b)/(c-a),a=b-a*c);e[0]=c;e[1]=a;return e};CMUtilities.FindNumLineCrossingsToTheRight=function(a,b,c,d,e,f){var g=0;b!=d&&(a>e||c>e)&&(b<f&&d>f||b>f&&d<f)&&(a==c?e<a&&g++:(Factors=CMUtilities.GetLineFactors(a,b,c,d),e<(f-Factors[1])/Factors[0]&&g++));return g};
CMUtilities.InsideAPolygon=function(a,b,c,d,e){for(var f=!1,g=0,h=0,k=0,l=0;l<e-1;l++)d[l+1]>d[l]?h=1:d[l+1]<d[l]&&(h=-1);var m=!1;d[e-1]==d[0]&&b==d[0]&&a<c[0]&&a<c[e-1]&&(m=!0);for(l=0;l<e;l++){var n=l+1;n==e&&(n=0);d[l]==d[n]?b==d[l]&&a<c[l]&&a<c[n]&&(m=!0):(d[n]>d[l]?k=1:d[n]<d[l]&&(k=-1),m?k==h&&g++:d[l]==b?a<c[l]&&k==h&&g++:g+=CMUtilities.FindNumLineCrossingsToTheRight(c[l],d[l],c[n],d[n],a,b),m=!1,h=k)}1==g%2&&(f=!0);return f};
CMUtilities.GetPolygonBounds=function(a,b,c){var d=null;if(0<c){d=a[0];for(var e=a[0],f=b[0],g=b[0],h=1;h<c;h++)a[h]<d&&(d=a[h]),a[h]>e&&(e=a[h]),b[h]<f&&(f=b[h]),b[h]>g&&(g=b[h]);d={XMin:d,XMax:e,YMin:f,YMax:g}}return d};CMUtilities.GetLength=function(a,b,c,d){return Math.sqrt((c-a)*(c-a)+(d-b)*(d-b))};CMUtilities.GetSeconds=function(){return(new Date).getTime()/1E3};
CMUtilities.Clone=function(a){var b=a;if(null!=a&&"object"===typeof a&&0=="isActiveClone"in a){b=a instanceof Date?new a.constructor:a.constructor();for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(a.isActiveClone=null,b[c]=CMUtilities.Clone(a[c]),delete a.isActiveClone)}return b};
CMUtilities.GetCoordinateString=function(a,b,c,d,e){var f="";switch(c){case CMUtilities.COORDINATE_UNITS_DD:null!=d&&(c=d.ProjectToGeographic(a,b),null!=c?(a=c[0],b=c[1]):f="Undefined Back Projection");""==f&&(a=Math.floor(1E4*a)/1E4,b=Math.floor(1E4*b)/1E4,c=CMUtilities.GetSymbol(a,!0),d=CMUtilities.GetSymbol(b,!1),0>a&&(a=-a),0>b&&(b=-b),f+=""+b+"\u00b0 "+d+" "+a+"\u00b0 "+c);break;case CMUtilities.COORDINATE_UNITS_DMS:null!=d&&(c=d.ProjectToGeographic(a,b),null!=c?(a=c[0],b=c[1],f+=CMUtilities.GetDMSFromLonLat(a,
b,!0)):f="Undefined Back Projection");break;case CMUtilities.COORDINATE_UNITS_FEET:case CMUtilities.COORDINATE_UNITS_METERS:f+=CMUtilities.GetTextFromEastingNorthing(a,b);break;case CMUtilities.COORDINATE_UNITS_PIXELS:PixelX=e.GetPixelXFromRefX(a);PixelY=e.GetPixelYFromRefY(b);f+=""+PixelX+", "+PixelY;break;case CMUtilities.COORDINATE_UNITS_ZOOM:f+=e.GetZoomLevel()}return f};CMUtilities.AppendElement=function(a,b){a=document.createElement(a);b.appendChild(a);return a};
CMUtilities.GetFontSizeFromFont=function(a){var b=12,c=a.indexOf("px");-1!=c&&(a=a.substring(0,c),c=a.lastIndexOf(" "),-1!=c&&(a=a.substring(c+1)),b=parseFloat(a));return b};CMUtilities.ClipArea=function(a,b,c){var d=[];a=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a,c);try{var e=c==CMDatasetVector.TYPE_POLYGONS?turf.polygon(a):turf.multiLineString(a);e=turf.bboxClip(e,b);var f=e.geometry,g=f.coordinates;"LineString"==f.type&&(g=[g]);d=CMDatasetGeoJSON.GetAreaFromGeoJSON(g)}catch(h){throw h;}return d};
CMUtilities.BufferArea=function(a,b,c){var d=[];try{switch(b){case CMDatasetVector.TYPE_POINTS:var e=turf.point(a[0][0][0],a[0][1][0]);break;case CMDatasetVector.TYPE_POLYLINES:var f=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a,b);e=turf.multiLineString(f);break;case CMDatasetVector.TYPE_POLYGONS:f=CMDatasetGeoJSON.GetGeoJSONCoordinatesFromArea(a,b),e=turf.polygon(f)}e=turf.buffer(e,c);d=CMDatasetGeoJSON.GetAreaFromGeoJSON(e.geometry.coordinates)}catch(g){throw g;}return d};
CMUtilities.AddPointsToArea=function(a,b,c){for(var d=[],e=0;e<a.length;e++){var f=a[e][0],g=a[e][1],h=[f[0]],k=[g[0]],l=f.length-1;b==CMDatasetVector.TYPE_POLYGONS&&l++;for(var m=1;m<=l;m++){var n=f[m-1];var p=g[m-1];if(m==f.length){var q=f[0];var r=g[0]}else q=f[m],r=g[m];var t=q-n,u=r-p,v=Math.sqrt(t*t+u*u);t/=v;for(u/=v;v>c;)n+=t*c,p+=u*c,h.push(n),k.push(p),v-=c;h.push(q);k.push(r)}d.push([h,k])}return d};CMUtilities.Truncate=function(a){return a=0>a?Math.ceil(a):Math.floor(a)};function CMUtilityBezier(){}CMUtilityBezier.GetThreePoint3D=function(a,b,c,d,e,f,g,h,k,l){return CMUtilityBezier.GetOneSlope3D(a,b,c,d,e,f,g,(h-b)/2,(k-c)/2,(l-d)/2)};CMUtilityBezier.GetOneSlope3D=function(a,b,c,d,e,f,g,h,k,l){var m=a-1,n=[];n[0]=[m];n[1]=[m];n[2]=[m];h=-h;k=-k;l=-l;b=b-h-e;c=c-k-f;d=d-l-g;for(var p,q,r,t=0,u=1;u<a;u++)q=1-u/a,r=q*q,m=b*r+h*q+e,p=c*r+k*q+f,q=d*r+l*q+g,n[0][t]=m,n[1][t]=p,n[2][t]=q,t++;return n};
CMUtilityBezier.GetFourPoint3D=function(a,b,c,d,e,f,g,h,k,l,m,n,p){return CMUtilityBezier.GetTwoSlope2D(a,e,f,g,h,k,l,(h-b)/2,(k-c)/2,(l-d)/2,(m-e)/2,(n-f)/2,(p-g)/2)};CMUtilityBezier.GetTwoSlope3D=function(a,b,c,d,e,f,g,h,k,l,m,n,p){var q=a-1,r=[];r[0]=[q];r[1]=[q];r[2]=[q];q=2*(b-e)+h+m;e=3*(e-b)-2*h-m;m=2*(c-f)+k+n;f=3*(f-c)-2*k-n;n=2*(d-g)+l+p;g=3*(g-d)-2*l-p;for(var t,u,v,w,x=0,y=1;y<a;y++)u=y/a,v=u*u,w=v*u,p=q*w+e*v+h*u+b,t=m*w+f*v+k*u+c,u=n*w+g*v+l*u+d,r[0][x]=p,r[1][x]=t,r[2][x]=u,x++;return r};
CMUtilityBezier.GetFourPoint2D=function(a,b,c,d,e,f,g,h,k){return CMUtilityBezier.GetTwoSlope2D(a,d,e,f,g,(f-b)/2,(g-c)/2,(h-d)/2,(k-e)/2)};CMUtilityBezier.GetTwoSlope2D=function(a,b,c,d,e,f,g,h,k){var l=a-1,m=[];m[0]=[l];m[1]=[l];l=2*(b-d)+f+h;d=3*(d-b)-2*f-h;h=2*(c-e)+g+k;e=3*(e-c)-2*g-k;for(var n,p,q,r=0,t=1;t<a;t++)n=t/a,p=n*n,q=p*n,k=l*q+d*p+f*n+b,n=h*q+e*p+g*n+c,m[0][r]=k,m[1][r]=n,r++;return m};CMView.TOOL_HAND=1;CMView.TOOL_INFO=2;CMView.TOOL_EDIT=3;CMView.TOOL_ADD=4;CMView.TOOL_SELECT=5;CMView.MESSAGE_MOUSE_MOVED=CMBase.GetUniqueNumber();CMView.UniqueNumber=0;function CMView(){CMBase.call(this);this.UniqueNumber=CMView.UniqueNumber;CMView.UniqueNumber++;this.Settings={};this.CurrentTool=CMView.TOOL_SELECT;this.CollisionChecking=!0;this.MapElements=[];this.CollisionArray=this.TheContext=this.ToolHandler=this.TheCanvasElement=null}CMView.prototype=Object.create(CMBase.prototype);
CMView.prototype.contructor=CMView;CMView.SettingDefintions={View:{CollisionChecking:{Name:"Collision Checking",Type:CMBase.DATA_TYPE_BOOLEAN,Default:!0}}};CMView.prototype.GetSettingsDefinitions=function(){return CMView.SettingDefintions};CMView.prototype.CMBase_SetSettings=CMBase.prototype.SetSettings;CMView.prototype.SetSettings=function(a,b){void 0!=a.View&&void 0!=a.View.CollisionChecking&&(this.CollisionChecking=a.View.CollisionChecking);this.CMBase_SetSettings(a,b)};
CMView.prototype.Repaint=function(){var a=this.GetParent(CMScene);null!=a&&a.Repaint()};CMView.prototype.GetContext=function(){return this.TheContext};CMView.prototype.MouseDown=function(a){CMMainContainer.HidePopupWindows();return!1};CMView.prototype.MouseMove=function(a){a||(a=window.event);this.SendMessageToListeners(CMView.MESSAGE_MOUSE_MOVED,a);return!1};CMView.prototype.MouseUp=function(a){a||(a=window.event);CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement);return!1};
CMView.prototype.MouseWheel=function(a){CMMainContainer.HidePopupWindows();a||(a=window.event);a.preventDefault&&a.preventDefault();return!1};CMView.prototype.KeyDown=function(a){CMMainContainer.HidePopupWindows();return!1};CMView.prototype.KeyUp=function(a){CMMainContainer.HidePopupWindows();return!1};CMView.prototype.GetCoordinateStringFromEvent=function(a,b){return Text};CMView.prototype.AddMapElement=function(a){this.MapElements.push(a);a.SetParent(this)};
CMView.prototype.Setup=function(a){this.TheCanvasElement=a;this.TheContext=this.TheCanvasElement.getContext("2d");this.TheCanvasElement.style.cursor="crosshair";this.SetTool(CMView.TOOL_SELECT)};CMView.prototype.Resize=function(){var a=this.TheCanvasElement,b=a.parentNode,c=jQuery(b).width();b=jQuery(b).height();a.width=c;a.height=b;for(a=0;a<this.MapElements.length;a++);};CMView.prototype.SetToolHandler=function(a){this.ToolHandler=a};CMView.prototype.GetToolHandler=function(){return this.ToolHandler};
CMView.prototype.GetCanvasElement=function(){return this.TheCanvasElement};
CMView.prototype.AddMouseEventHandlers=function(){var a=this.GetCanvasElement();a.TheView=this;a.addEventListener("mousedown",function(a){null!=this.TheView&&(this.TheView.MouseDown(a),a.stopPropagation())});a.addEventListener("mousemove",function(a){null!=this.TheView&&this.TheView.MouseMove(a)});a.addEventListener("mouseup",function(a){null!=this.TheView&&this.TheView.MouseUp(a)});var b=/Firefox/i.test(navigator.userAgent)?"DOMMouseScroll":"mousewheel";a.attachEvent?a.attachEvent("on"+b,function(a){CMMainContainer.HidePopupWindows();
a=window.event||a;return this.TheView.MouseWheel(a)}):a.addEventListener&&a.addEventListener(b,function(a){CMMainContainer.HidePopupWindows();a=window.event||a;return this.TheView.MouseWheel(a)},!1)};CMView.prototype.AddKeyEventHandlers=function(){this.GetCanvasElement();window.TheView=this;window.addEventListener("keydown",function(a){null!=this.TheView&&this.TheView.KeyDown(a)},!1);window.addEventListener("keyup",function(a){null!=this.TheView&&this.TheView.KeyUp(a)},!1)};
CMView.prototype.AddMobileEvents=function(a){};CMView.prototype.SetTool=function(a){switch(a){case CMView.TOOL_HAND:this.TheCanvasElement.style.cursor="move";break;case CMView.TOOL_INFO:case CMView.TOOL_SELECT:this.TheCanvasElement.style.cursor="crosshair";break;case CMView.TOOL_EDIT:this.TheCanvasElement.style.cursor="crosshair"}this.CurrentTool=a};CMView.prototype.GetTool=function(){return this.CurrentTool};
CMView.SetStyleToContext=function(a,b,c){!1!==b&&c.save();if(null!=a&&void 0!=a){c.shadowBlur=0;for(var d in a)if("PatternImage"==d)b=c.createPattern(a[d],"repeat"),c.fillStyle=b;else if("GradientType"==d){b=a.GradientColors;var e=a.GradientCoordinates,f=a.GradientRadius;void 0==f&&(f=100);var g=0,h=0,k=500,l=500;void 0!=e&&(g=e.Xs[0],h=e.Ys[0],k=e.Xs[1],l=e.Ys[1]);e="Linear"==a[d]?c.createLinearGradient(g,h,k,l):c.createRadialGradient(g,h,k,l,f);if(void 0!=b)for(f=0;f<b.length;f++)e.addColorStop(f,
b[f]);c.fillStyle=e}else"GradientColors"!=d&&"GradientCoordinates"!=d&&"GradientRadius"!=d&&(c[d]=a[d])}};CMView.prototype.SetStyle=function(a,b){CMView.SetStyleToContext(a,b,this.TheContext)};CMView.prototype.SaveStyle=function(){this.TheContext.save()};CMView.prototype.RestoreStyle=function(){this.TheContext.restore()};CMView.prototype.PaintStart=function(){this.CollisionChecking&&(this.CollisionArray=[])};
CMView.prototype.Paint=function(){this.TheContext.clearRect(0,0,this.TheCanvasElement.width,this.TheCanvasElement.height);this.GetParent(CMScene).Paint(this)};CMView.prototype.PaintEnd=function(){for(var a=0;a<this.MapElements.length;a++)this.MapElements[a].Paint(this);this.ResetCollisions()};CMView.prototype.CheckCollision=function(a){var b=!1;if(null!==this.CollisionArray)for(var c=0;c<this.CollisionArray.length&&0==b;c++)CMUtilities.BoundsOverlap(a,this.CollisionArray[c])&&(b=!0);return b};
CMView.prototype.AddToCollisions=function(a){null!==this.CollisionArray&&this.CollisionArray.push(a)};CMView.prototype.ResetCollisions=function(){this.CollisionChecking&&(this.CollisionArray=[])};CMView.prototype.GetTextWidthInPixels=function(a){return this.TheContext.measureText(a).width};CMView.prototype.PaintImage=function(a,b,c){this.TheContext.drawImage(a,b,c)};CMView.prototype.PaintBackground=function(){this.TheContext.fillRect(0,0,this.TheCanvasElement.width,this.TheCanvasElement.height)};
CMView.prototype.PaintCircle=function(a,b,c){this.TheContext.beginPath();this.TheContext.arc(a,b,c,0,2*Math.PI);null!=this.TheContext.strokeStyle&&this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};
CMView.prototype.PaintRect=function(a,b,c,d){null!=this.TheContext.fillStyle&&this.TheContext.fillRect(a,c,b-a,d-c);if(null!=this.TheContext.strokeStyle)if(null==this.TheContext.fillStyle||void 0==this.TheContext.shadowColor)this.TheContext.stroke();else{var e=this.TheContext.shadowColor;this.TheContext.shadowColor="rgba(0,0,0,0)";this.TheContext.strokeRect(a,c,b-a,d-c);this.TheContext.shadowColor=e}};
CMView.prototype.PaintArc=function(a,b,c,d,e,f){var g=(a+b)/2,h=(c+d)/2,k=(b-a)/2;this.TheContext.save();this.TheContext.translate(g,h);this.TheContext.scale(1,(d-c)/(b-a));this.TheContext.beginPath();this.TheContext.arc(0,0,k,e,f,!1);this.TheContext.restore();null!=this.TheContext.strokeStyle&&this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};
CMView.prototype.PaintRoundedRect=function(a,b,c,d,e,f){"undefined"===typeof f&&(f=e);this.TheContext.beginPath();this.TheContext.moveTo(a+e,c);this.TheContext.lineTo(b-e,c);this.TheContext.quadraticCurveTo(b,c,b,c+f);this.TheContext.lineTo(b,d-f);this.TheContext.quadraticCurveTo(b,d,b-e,d);this.TheContext.lineTo(a+e,d);this.TheContext.quadraticCurveTo(a,d,a,d-f);this.TheContext.lineTo(a,c+f);this.TheContext.quadraticCurveTo(a,c,a+e,c);this.TheContext.closePath();null!=this.TheContext.strokeStyle&&
this.TheContext.stroke();null!=this.TheContext.fillStyle&&this.TheContext.fill()};
CMView.prototype.PaintText=function(a,b,c,d){void 0!=d?(this.TheContext.translate(a,b),this.TheContext.rotate(d),null!=this.TheContext.strokeStyle&&this.TheContext.strokeText(c,0,0),null!=this.TheContext.fillStyle&&this.TheContext.fillText(c,0,0),this.TheContext.rotate(-d),this.TheContext.translate(-a,-b)):(null!=this.TheContext.strokeStyle&&this.TheContext.strokeText(c,0,0),null!=this.TheContext.fillStyle&&this.TheContext.fillText(c,0,0))};CMView2D.SettingDefintions={View2D:{MinZoom:{Name:"Min Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:-1E5},MaxZoom:{Name:"Max Zoom",Type:CMBase.DATA_TYPE_FLOAT,Default:1E5},MaxBounds:{Name:"Max Bounds",Type:CMBase.DATA_TYPE_COORDINATES,Default:null}}};function CMView2D(){CMView.call(this);this.Settings.View2D={MinZoom:-1E5,MaxZoom:1E5,MaxBounds:null};this.RefY=this.RefX=this.ZoomLevel=0;this.MinScale=1;this.TheContext=this.ToolHandler=this.TheCanvasElement=null}CMView2D.prototype=Object.create(CMView.prototype);
CMView2D.prototype.contructor=CMView2D;CMView2D.prototype.CMView_GetSettingsDefinitions=CMView.prototype.GetSettingsDefinitions;CMView2D.prototype.GetSettingsDefinitions=function(){var a=this.CMView_GetSettingsDefinitions();for(Key in CMView2D.SettingDefintions)a[Key]=CMView2D.SettingDefintions[Key];return a};
CMView2D.prototype.CheckMaxBounds=function(){var a=this.GetScale(),b=this.TheCanvasElement.width*a;a*=-this.TheCanvasElement.height;var c=this.GetSetting("View2D","MaxBounds");null!=c&&(c.Xs[1]-c.Xs[0]<b?this.RefX=(c.Xs[1]+c.Xs[0])/2-b/2:(this.RefX<c.Xs[0]&&(this.RefX=c.Xs[0]),this.RefX+b>c.Xs[1]&&(this.RefX=c.Xs[1]-b)),c.Ys[1]-c.Ys[0]<-a?this.RefY=(c.Ys[1]+c.Ys[0])/2-a/2:(this.RefY>c.Ys[1]&&(this.RefY=c.Ys[1]),this.RefY+a<c.Ys[0]&&(this.RefY=c.Ys[0]-a)))};
CMView2D.prototype.GetScale=function(){return this.MinScale/Math.pow(2,this.ZoomLevel)};
CMView2D.prototype.AddMobileEvents=function(){var a=new Hammer(CanvasContainer);a.get("pan").set({direction:Hammer.DIRECTION_ALL});var b=new Hammer.Pinch;a.add([b]);a.TheView=this;a.on("pinch panleft panright panup pandown",function(b){var c=a.TheView,e=c.GetRefWidthFromPixelWidth(CMMainContainer.GESTURE_PAN),f=c.GetRefCenter(),g=f.RefX;f=f.RefY;MapHeader.innerHTML=b.type;"panup"==b.type?c.SetRefCenter(g,f-e):"pandown"==b.type?c.SetRefCenter(g,f+e):"panleft"==b.type?c.SetRefCenter(g+e,f):"panright"==
b.type?c.SetRefCenter(g-e,f):"pinch"==b.type&&(e=c.GetZoomLevel(),MapHeader.textContent=b.additionalEvent,"pinchin"==b.additionalEvent?c.ZoomTo(e-CMMainContainer.GESTURE_ZOOM):c.ZoomTo(e+CMMainContainer.GESTURE_ZOOM))})};
CMView2D.prototype.MouseDown=function(a){var b=!1;a||(a=window.event);CMMainContainer.HidePopupWindows();var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;var e=this.GetRefXFromPixelX(d),f=this.GetRefYFromPixelY(c);null!=this.ToolHandler&&(b=this.ToolHandler.MouseDown(this,e,f,a));0==b&&this.CurrentTool==CMView.TOOL_HAND&&(this.DragX=this.GetRefXFromPixelX(d),this.DragY=this.GetRefYFromPixelY(c),b=this.Dragging=!0);0==b&&(b=this.GetParent(CMScene).MouseDown(this,
e,f,a));0==b&&(this.DragX=this.GetRefXFromPixelX(d),this.DragY=this.GetRefYFromPixelY(c),b=this.Dragging=!0);return b};
CMView2D.prototype.MouseMove=function(a){var b=!1;a||(a=window.event);var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;this.SendMessageToListeners(CMView.MESSAGE_MOUSE_MOVED,a);1==this.Dragging?(a=this.GetRefWidthFromPixelWidth(d),c=this.GetRefHeightFromPixelHeight(c),this.RefX=this.DragX-a,this.RefY=this.DragY-c,this.CheckMaxBounds(),this.Repaint()):(d=this.GetRefXFromPixelX(d),c=this.GetRefYFromPixelY(c),null!=this.ToolHandler&&(b=this.ToolHandler.MouseMove(this,
d,c,a)),0==b&&(b=this.GetParent(CMScene).MouseMove(this,d,c,a)));return b};CMView2D.prototype.MouseUp=function(a){var b=!1;a||(a=window.event);var c=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement),d=c.x;c=c.y;this.Dragging?(this.DragY=this.DragX=0,this.Dragging=!1):(d=this.GetRefXFromPixelX(d),c=this.GetRefYFromPixelY(c),null!=this.ToolHandler&&(b=this.ToolHandler.MouseUp(this,d,c,a)),0==b&&(b=this.GetParent(CMScene).MouseUp(this,d,c,a)));return b};
CMView2D.prototype.MouseWheel=function(a){CMMainContainer.HidePopupWindows();a||(a=window.event);var b=a.detail?-120*a.detail:a.wheelDelta;if(0!=b){var c=this.ZoomLevel;c=0<b?c+1:c-1;b=this.GetSetting("View2D","MinZoom");var d=this.GetSetting("View2D","MaxZoom");c<b&&(c=b);c>d&&(c=d);if(c!=this.ZoomLevel){b=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,this.TheCanvasElement);var e=b.x,f=b.y;b=this.GetRefXFromPixelX(e);d=this.GetRefYFromPixelY(f);this.ZoomLevel=c;c=this.GetRefWidthFromPixelWidth(e);
e=this.GetRefHeightFromPixelHeight(f);this.RefX=b-c;this.RefY=d-e;CMDataset.ResetRequests();this.Repaint()}}a.preventDefault&&a.preventDefault();return!1};CMView2D.prototype.GetCoordinateStringFromEvent=function(a,b){var c=this.GetCanvasElement();a=CMUtilities.GetElementCoordinate(a.clientX,a.clientY,c);c=a.y;a=this.GetRefXFromPixelX(a.x);c=this.GetRefYFromPixelY(c);var d=this.GetParent(CMMainContainer).GetProjector();return CMUtilities.GetCoordinateString(a,c,b,d,this)};
CMView2D.prototype.GetExtent=function(){var a={},b=this.GetScale();a.XMin=this.RefX;a.YMax=this.RefY;a.XMax=this.RefX+this.TheCanvasElement.width*b;a.YMin=this.RefY-this.TheCanvasElement.height*b;return a};
CMView2D.prototype.SetRefCenter=function(a,b){var c=this.GetScale(),d=this.TheCanvasElement.width*c;c*=-this.TheCanvasElement.height;this.RefX=a-d/2;this.RefY=b-c/2;a=this.GetSetting("View2D","MaxBounds");null!=a&&(this.RefX<a.Xs[0]&&(this.RefX=a.Xs[0]),this.RefY>a.Ys[1]&&(this.RefY=a.Ys[1]),this.RefX+d>a.Xs[1]&&(this.RefX=a.Xs[1]-d),this.RefY+c<a.Ys[0]&&(this.RefY=a.Ys[0]-c));this.Repaint()};
CMView2D.prototype.GetRefCenter=function(){var a=this.GetScale();return{RefX:this.RefX+this.TheCanvasElement.width*a/2,RefY:this.RefY-this.TheCanvasElement.height*a/2}};
CMView2D.prototype.ZoomToBounds=function(a){if(null==a)alert("Sorry, you cannot call CMView2D.ZoomToBounds(NewBounds) with NewBounds=null.");else{"Xs"in a&&(a={XMin:a.Xs[0],XMax:a.Xs[1],YMin:a.Ys[0],YMax:a.Ys[1]});var b=Math.abs(a.XMax-a.XMin)/this.TheCanvasElement.width,c=Math.abs(a.YMax-a.YMin)/this.TheCanvasElement.height;b<c&&(b=c);c=this.ZoomLevel;var d=this.GetSetting("View2D","MinZoom"),e=this.GetSetting("View2D","MaxZoom");this.ZoomLevel=20;this.ZoomLevel>e&&(this.ZoomLevel=e);this.ZoomLevel<
d&&(this.ZoomLevel=d);for(;this.GetScale()<b&&this.ZoomLevel>d;)this.ZoomLevel--;this.ZoomLevel!=c&&CMDataset.ResetRequests();this.SetRefCenter((a.XMax+a.XMin)/2,(a.YMin+a.YMax)/2)}};CMView2D.prototype.ZoomToMaxBounds=function(){var a=this.GetSetting("View2D","MaxBounds");null==a&&(a=this.GetParent(CMScene).GetBounds());null!=a&&this.ZoomToBounds(a)};CMView2D.prototype.ZoomIn=function(){this.ZoomTo(this.ZoomLevel+1)};CMView2D.prototype.ZoomOut=function(){this.ZoomTo(this.ZoomLevel-1)};
CMView2D.prototype.ZoomTo=function(a){var b=this.GetSetting("View2D","MinZoom"),c=this.GetSetting("View2D","MaxZoom");a<b&&(a=b);a>c&&(a=c);a!=this.ZoomLevel&&(b=this.GetRefXFromPixelX(this.TheCanvasElement.width/2),c=this.GetRefYFromPixelY(this.TheCanvasElement.height/2),this.ZoomLevel=a,CMDataset.ResetRequests(),this.SetRefCenter(b,c))};CMView2D.prototype.GetZoomLevel=function(){return this.ZoomLevel};CMView2D.prototype.GetPixelXFromRefX=function(a){var b=this.GetScale();return(a-this.RefX)/b};
CMView2D.prototype.GetPixelYFromRefY=function(a){var b=this.GetScale();return(this.RefY-a)/b};CMView2D.prototype.GetPixelFromRef=function(a,b){a=this.GetPixelXFromRefX(a);b=this.GetPixelYFromRefY(b);return{PixelX:a,PixelY:b}};CMView2D.prototype.GetPixelWidthFromRefWidth=function(a){var b=this.GetScale();return a/b};CMView2D.prototype.GetPixelHeightFromRefHeight=function(a){var b=this.GetScale();return-a/b};CMView2D.prototype.GetRefWidthFromPixelWidth=function(a){var b=this.GetScale();return a*b};
CMView2D.prototype.GetRefHeightFromPixelHeight=function(a){var b=this.GetScale();return-a*b};CMView2D.prototype.GetRefXFromPixelX=function(a){var b=this.GetScale();return a*b+this.RefX};CMView2D.prototype.GetRefYFromPixelY=function(a){var b=this.GetScale();return-(a*b-this.RefY)};CMView2D.prototype.PaintRefBounds=function(a){this.PaintRefRect(a.XMin,a.XMax,a.YMin,a.YMax)};
CMView2D.prototype.PaintRefRect=function(a,b,c,d){a=this.GetPixelFromRef(a,d);d=a.PixelX;var e=a.PixelY;a=this.GetPixelFromRef(b,c);this.PaintRect(d,a.PixelX,e,a.PixelY)};CMView2D.prototype.PaintRefArc=function(a,b,c,d,e,f){a=this.GetPixelFromRef(a,d);d=a.PixelX;var g=a.PixelY;a=this.GetPixelFromRef(b,c);this.PaintArc(d,a.PixelX,g,a.PixelY,e,f)};
CMView2D.prototype.PaintRefRoundedRect=function(a,b,c,d,e,f){var g=this.GetPixelFromRef(a,d);a=g.PixelX;d=g.PixelY;g=this.GetPixelFromRef(b,c);b=g.PixelX;c=g.PixelY;e=this.GetPixelWidthFromRefWidth(e);f=this.GetPixelWidthFromRefWidth(f);this.PaintRoundedRect(a,b,d,c,e,f)};CMView2D.prototype.PaintRefCircle=function(a,b,c){a=this.GetPixelFromRef(a,b);this.PaintCircle(a.PixelX,a.PixelY,c)};
CMView2D.prototype.PaintRefText=function(a,b,c,d,e,f){var g=this.GetTextWidthInPixels(a),h=this.GetRefWidthFromPixelWidth(g);void 0===f&&(f=0);var k=this.GetPixelXFromRefX(b),l=this.GetPixelYFromRefY(c);if(0===f){"center"===e?k=this.GetPixelXFromRefX(b-h/2):"right"===e&&(k=this.GetPixelXFromRefX(b-h));var m={XMin:k,XMax:k+g,YMin:l-d,YMax:l}}else f===Math.PI/2?(k=this.GetPixelXFromRefX(b),l="center"===e?this.GetPixelYFromRefY(c+h/2):"right"===e?this.GetPixelYFromRefY(c+h):this.GetPixelYFromRefY(c),
m={XMin:k,XMax:k+d,YMin:l,YMax:l+g}):f===-Math.PI/2?(k=this.GetPixelXFromRefX(b),l="center"===e?this.GetPixelYFromRefY(c-h/2):"right"===e?this.GetPixelYFromRefY(c-h):this.GetPixelYFromRefY(c),m={XMin:k-d,XMax:k,YMin:l-g,YMax:l}):alert("Sorry, rotations other than 0,PI/2 and -PI/2 are not supported at this time");0==this.CheckCollision(m)&&(this.AddToCollisions(m),this.PaintText(k,l,a,f))};
CMView2D.prototype.PaintRefLine=function(a,b,c,d){var e=this.GetPixelFromRef(a,b);a=e.PixelX;b=e.PixelY;e=this.GetPixelFromRef(c,d);c=e.PixelX;d=e.PixelY;this.TheContext.beginPath();this.TheContext.moveTo(a,b);this.TheContext.lineTo(c,d);this.TheContext.stroke()};
CMView2D.prototype.CreatePath=function(a,b,c){for(var d,e,f,g,h=0;h<a.length;h++)if(Result=this.GetPixelFromRef(a[h],b[h]),d=Result.PixelX,e=Result.PixelY,0==h&&(this.TheContext.moveTo(d,e),f=d,g=e),d!=f||e!=g)this.TheContext.lineTo(d,e),f=d,g=e;c&&this.TheContext.closePath()};
CMView2D.prototype.PaintPath=function(a,b,c){void 0==b&&(b=a?!0:!1);void 0==c&&(c=!0);(void 0==b||b)&&this.TheContext.fill();if(void 0==c||c)0==b||void 0==this.TheContext.shadowColor?this.TheContext.stroke():(a=this.TheContext.shadowColor,this.TheContext.shadowColor="rgba(0,0,0,0)",this.TheContext.stroke(),this.TheContext.shadowColor=a)};CMView2D.prototype.PaintRefPoly=function(a,b,c,d,e){void 0!=a&&(this.TheContext.beginPath(),this.CreatePath(a,b,c),this.PaintPath(c,d,e))};
CMView2D.prototype.PaintRefArea=function(a,b,c,d){if(void 0!=a&&0<a.length){this.TheContext.beginPath();this.CreatePath(a[0][0],a[0][1],b);for(var e=1;e<a.length;e++)this.CreatePath(a[e][0],a[e][1],b,c,d);this.PaintPath(b,c,d)}};CMView2D.prototype.PaintRefRegion=function(a,b,c,d){if(void 0!=a)for(var e=0;e<a.length;e++)this.PaintRefArea(a[e],b,c,d)};CMView2D.prototype.PaintRefImage=function(a,b,c){b=this.GetPixelFromRef(b,c);this.TheContext.drawImage(a,b.PixelX,b.PixelY)};
CMView2D.prototype.PaintRefImageScaled=function(a,b,c,d,e){"object"==typeof b&&(TheBounds=b,b=TheBounds.XMin,c=TheBounds.YMax,d=TheBounds.XMax-TheBounds.XMin,e=TheBounds.YMin-TheBounds.YMax);c=this.GetPixelFromRef(b,c);b=Math.round(c.PixelX);c=Math.round(c.PixelY);d=this.GetPixelWidthFromRefWidth(d);e=this.GetPixelHeightFromRefHeight(e);d=Math.round(d);e=Math.round(e);this.TheContext.drawImage(a,b,c,d+1,e+1)};
CMView2D.prototype.CreateInfoWindow=function(a,b,c,d,e,f){b=this.GetPixelXFromRefX(b);c=this.GetPixelYFromRefY(c);jQuery(this.TheCanvasElement).offset();var g=this.TheCanvasElement.getBoundingClientRect();b+=g.left;c+=g.top;g=this.GetParent(CMMainContainer).GetSetting("MainContainer","ImageFolder");return CMUtilities.CreateInfoWindow(a,b,c,d,e,f,g)};function CMPanelTabs(a){CMBase.call(this);void 0==a&&alert("Sorry, the CMPanelTabs requires a CanvasMap object on construction");this.SetParent(a);this.Tabs=[];this.TabContents=[]}CMPanelTabs.prototype=Object.create(CMBase.prototype);CMPanelTabs.prototype.contructor=CMPanelTabs;CMPanelTabs.prototype.GetTabIndexFromName=function(a){for(var b=-1,c=0;c<this.Tabs.length;c++)this.Tabs[c].Name==a&&(b=c);return b};
CMPanelTabs.prototype.SetElement=function(a){this.TheElement=a;this.TabContainer=document.createElement("DIV");this.TabContainer.className="CM_Tabs";this.TheElement.appendChild(this.TabContainer)};
CMPanelTabs.prototype.AddTab=function(a,b,c,d){if(null!=this.TheElement){var e=document.createElement("button");e.id=a+"_tab";e.className="tablinks";void 0!=c&&(e.title=c);e.innerHTML=b;e.Selected=!1;e.TabPanel=this;e.Name=b;e.onclick=function(){this.TabPanel.SelectTab(this.Name);CMMainContainer.HidePopupWindows()};this.Tabs.push(e);this.TabContainer.appendChild(e);0==CMUtilities.IsDefined(d)&&(d=document.createElement("DIV"),d.id=a,d.className="CM_TabContent");1<this.Tabs.length&&(d.style.display=
"none");this.TabContents.push(d);this.TheElement.appendChild(d)}return d};CMPanelTabs.prototype.SelectTab=function(a){for(var b=0;b<this.Tabs.length;b++)this.Tabs[b].Name==a?(this.TabContents[b].style.display="block",this.Tabs[b].className=this.Tabs[b].className+=" active"):(this.TabContents[b].style.display="none",this.Tabs[b].className=this.Tabs[b].className.replace(" active",""))};
CMPanelTabs.prototype.GetTabContentElement=function(a){var b=null;a=this.GetTabIndexFromName(a);-1!=a&&(b=this.TabContents[a]);return b};CMPanelTabs.prototype.RemoveTab=function(a){a=this.GetTabIndexFromName(a);if(-1!=a){var b=this.Tabs[a];b.parentNode.removeChild(b);this.Tabs.splice(a,1);this.TabContents.splice(a,1)}};